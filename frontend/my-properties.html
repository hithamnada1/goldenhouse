<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ | Golden House</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .header-buttons {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn-primary {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      color: #333;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(45deg, #FFA500, #FF6347);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 165, 0, 0.4);
      color: white;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      padding: 10px 25px;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      transform: translateY(-2px);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .page-title {
      color: white;
      text-align: center;
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .page-subtitle {
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 40px;
    }

    .tabs-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .nav-tabs {
      border-bottom: 2px solid #FFD700;
      margin-bottom: 30px;
    }

    .nav-tabs .nav-link {
      border: none;
      color: #666;
      font-weight: 600;
      padding: 15px 25px;
      border-radius: 15px 15px 0 0;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      border: none;
    }

    .nav-tabs .nav-link:hover {
      background: rgba(255, 215, 0, 0.1);
      color: #333;
    }

    /* Payment Status Tab Styles */
    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .status-pending {
      background: linear-gradient(45deg, #ffecd2, #fcb69f);
      color: #8b4513;
    }

    .status-paid-full {
      background: linear-gradient(45deg, #a8e6cf, #56ab2f);
      color: #fff;
    }

    .status-paid-partial {
      background: linear-gradient(45deg, #ffecd2, #fcb69f);
      color: #8b4513;
    }

    .status-overdue {
      background: linear-gradient(45deg, #f093fb, #f5576c);
      color: #fff;
    }

    .payment-card {
      transition: transform 0.3s ease;
    }

    .payment-card:hover {
      transform: translateY(-5px);
    }

    .progress {
      height: 8px;
      border-radius: 10px;
    }

    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .file-upload:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .file-upload.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.2);
    }

    .tab-content {
      padding: 20px 0;
    }

    .add-card {
      border: 2px solid #28a745;
      background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
      transition: all 0.3s ease;
    }

    .add-card .card-header {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border-radius: 15px 15px 0 0 !important;
    }

    .view-card {
      border: 2px solid #007bff;
      background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
      transition: all 0.3s ease;
    }

    .view-card .card-header {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      border-radius: 15px 15px 0 0 !important;
    }

    .add-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.2);
    }

    .view-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 123, 255, 0.2);
    }

    .card-body {
      padding: 1.5rem;
    }

    .card-text {
      color: #666;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .btn {
      border-radius: 25px;
      font-weight: 600;
      padding: 10px 20px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    /* Modal Styles */
    .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border-radius: 15px 15px 0 0;
      border: none;
    }

    .modal-header .btn-close {
      filter: invert(1);
    }

    .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .form-control {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #28a745;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .form-text {
      color: #6c757d;
      font-size: 0.875rem;
    }

    .modal-footer {
      border-top: 1px solid #e9ecef;
      padding: 1rem;
    }

    .modal-footer .btn {
      border-radius: 25px;
      padding: 8px 20px;
      font-weight: 600;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .card-header {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      border-radius: 15px 15px 0 0 !important;
      font-weight: 700;
    }

    .status-available {
      color: #28a745;
      font-weight: 600;
    }

    .status-rented {
      color: #dc3545;
      font-weight: 600;
    }

    .status-sold {
      color: #6c757d;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <img src="images/logo.png" alt="Golden House Logo" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <div style="display:none; font-size: 2em;">ğŸ </div>
      <div class="header-buttons">
        <a href="/" class="back-btn">
          <i class="fas fa-arrow-right"></i>
          Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <h1 class="page-title">Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ</h1>
    <p class="page-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù‚Ø§Ø±Ø§ØªÙŠ ÙˆØ¨Ù†Ø§ÙŠØ§ØªÙŠ ÙˆÙˆØ­Ø¯Ø§ØªÙŠ</p>

    <div class="tabs-container">
      <!-- Tabs -->
      <ul class="nav nav-tabs" id="myPropertiesTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
            <i class="fas fa-plus-circle"></i>
            Ø¥Ø¶Ø§ÙØ©
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="view-tab" data-bs-toggle="tab" data-bs-target="#view" type="button" role="tab">
            <i class="fas fa-eye"></i>
            Ø§Ø³ØªØ¹Ø±Ø§Ø¶
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payment-status-tab" data-bs-toggle="tab" data-bs-target="#payment-status" type="button" role="tab">
            <i class="fas fa-credit-card"></i>
            Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="myPropertiesTabContent">
        <!-- Add Tab -->
        <div class="tab-pane fade show active" id="add" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</h3>
          </div>
          
          <div class="row">
            <!-- Add Building Card -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="card add-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-building"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø§ÙŠØ©
                  </h5>
                </div>
                <div class="card-body">
                  <p class="card-text">Ø£Ø¶Ù Ø¨Ù†Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ ÙˆÙ…Ø³ØªÙ†Ø¯Ø§ØªÙ‡Ø§</p>
                  <button class="btn btn-success w-100" onclick="openAddBuildingModal()">
                    <i class="fas fa-plus"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø§ÙŠØ©
                  </button>
                </div>
              </div>
            </div>
            

            
            <!-- Add Payment Card -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="card add-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-money-bill-wave"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                  </h5>
                </div>
                <div class="card-body">
                  <p class="card-text">Ø£Ø¶Ù Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ ØªÙØ§ØµÙŠÙ„Ù‡Ø§ ÙˆÙ…Ø³ØªÙ†Ø¯Ø§ØªÙ‡Ø§</p>
                  <button class="btn btn-success w-100" onclick="openAddPaymentModal()">
                    <i class="fas fa-plus"></i>
                    Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Add Invoice Card -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="card add-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-file-invoice"></i>
                    Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©
                  </h5>
                </div>
                <div class="card-body">
                  <p class="card-text">Ø£Ø¶Ù ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø£Ùˆ ØµØ±Ù ØµØ­ÙŠ</p>
                  <button class="btn btn-success w-100" onclick="openAddInvoiceModal()">
                    <i class="fas fa-plus"></i>
                    Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- View Tab -->
        <div class="tab-pane fade" id="view" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-search"></i> Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
          </div>
          
          <div class="row">
            <div class="col-12">
              <div class="card view-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-search"></i>
                    Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø´Ø§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label for="viewBuildingSelect" class="form-label">
                        <i class="fas fa-building"></i> Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©
                      </label>
                      <select class="form-control" id="viewBuildingSelect" onchange="loadUnitsForView()">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="viewUnitSelect" class="form-label">
                        <i class="fas fa-home"></i> Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©
                      </label>
                      <select class="form-control" id="viewUnitSelect" onchange="loadUnitDetails()" disabled>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="viewDataType" class="form-label">
                        <i class="fas fa-filter"></i> Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                      </label>
                      <select class="form-control" id="viewDataType" onchange="loadDataByType()">
                        <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
                        <option value="units">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>
                        <option value="payments">Ø§Ù„Ø¯ÙØ¹Ø§Øª</option>
                        <option value="invoices">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Results Container -->
                  <div id="viewResults" class="mt-4" style="display: none;">
                    <div class="card">
                      <div class="card-header bg-primary text-white">
                        <h6 class="mb-0" id="resultsTitle">
                          <i class="fas fa-list"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
                        </h6>
                      </div>
                      <div class="card-body">
                        <div id="resultsContent">
                          <!-- Results will be loaded here -->
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Quick Actions -->
                  <div class="row mt-4">
                    <div class="col-12">
                      <h6 class="text-muted mb-3">
                        <i class="fas fa-bolt"></i> Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©
                      </h6>
                      <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadAllBuildings()">
                          <i class="fas fa-building"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="loadAllUnits()">
                          <i class="fas fa-home"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadAllPayments()">
                          <i class="fas fa-money-bill-wave"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="loadAllInvoices()">
                          <i class="fas fa-file-invoice"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Status Tab -->
        <div class="tab-pane fade" id="payment-status" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-credit-card"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3>
          </div>
          
          <div class="row">
            <div class="col-12">
              <div class="card view-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card"></i>
                    ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶
                  </h5>
                </div>
                <div class="card-body">
                  <!-- ÙÙ„ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰:</label>
                      <select id="buildingSelect" class="form-select">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
                      <select id="unitSelect" class="form-select">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>
                      </select>
                    </div>
                  </div>

                  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª -->
                  <div id="paymentsList" class="row">
                    <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù‡Ù†Ø§ -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Building Modal -->
  <div class="modal fade" id="addBuildingModal" tabindex="-1" aria-labelledby="addBuildingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBuildingModalLabel">
            <i class="fas fa-building"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBuildingForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="buildingName" class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø§ÙŠØ© *</label>
                <input type="text" class="form-control" id="buildingName" name="name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="buildingAddress" class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</label>
                <input type="text" class="form-control" id="buildingAddress" name="address">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="totalUnits" class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</label>
                <input type="number" class="form-control" id="totalUnits" name="total_units" min="1">
              </div>
              <div class="col-md-6 mb-3">
                <label for="buildingDescription" class="form-label">ÙˆØµÙ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</label>
                <textarea class="form-control" id="buildingDescription" name="description" rows="3"></textarea>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="buildingDocuments" class="form-label">Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</label>
              <input type="file" class="form-control" id="buildingDocuments" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª (PDF, Word, ØµÙˆØ±)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-success" onclick="saveBuilding()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©
          </button>
        </div>
      </div>
    </div>
  </div>



  <!-- Add Payment Modal -->
  <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPaymentModalLabel">
            <i class="fas fa-money-bill-wave"></i>
            Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addPaymentForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="paymentBuilding" class="form-label">Ø§Ù„Ø¨Ù†Ø§ÙŠØ© *</label>
                <select class="form-control" id="paymentBuilding" name="building_id" required onchange="loadUnitsForPayment()">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentUnit" class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø© *</label>
                <select class="form-control" id="paymentUnit" name="unit_id" required disabled>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="paymentAmount" class="form-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯Ø±Ù‡Ù…) *</label>
                <input type="number" class="form-control" id="paymentAmount" name="amount" min="0" step="0.01" required onchange="generatePaymentInstallments()">
              </div>
              <div class="col-md-4 mb-3">
                <label for="paymentDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© *</label>
                <input type="date" class="form-control" id="paymentDate" name="payment_date" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="paymentInstallments" class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</label>
                <input type="number" class="form-control" id="paymentInstallments" name="installments" min="1" value="1" onchange="generatePaymentInstallments()">
              </div>
            </div>
            
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© -->
            <div id="paymentInstallmentsContainer" class="mb-3" style="display: none;">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø³ÙŠØªÙ… ØªÙ‚Ø³ÙŠÙ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠÙ…Ø© ÙƒÙ„ Ø¯ÙØ¹Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©.
              </div>
              <h6 class="text-primary mb-3">
                <i class="fas fa-money-bill-wave"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
              </h6>
              <div id="paymentInstallmentsList">
                <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="paymentType" class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</label>
                <select class="form-control" id="paymentType" name="payment_type">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                  <option value="rent">Ø¥ÙŠØ¬Ø§Ø±</option>
                  <option value="sale">Ø¨ÙŠØ¹</option>
                  <option value="deposit">Ø¹Ø±Ø¨ÙˆÙ†</option>
                  <option value="maintenance">ØµÙŠØ§Ù†Ø©</option>
                  <option value="other">Ø£Ø®Ø±Ù‰</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentMethod" class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select class="form-control" id="paymentMethod" name="payment_method">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</option>
                  <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹</option>
                  <option value="bank_transfer">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                  <option value="check">Ø´ÙŠÙƒ</option>
                  <option value="card">Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                  <option value="other">Ø£Ø®Ø±Ù‰</option>
                </select>
              </div>
            </div>
            

            

            
            <div class="mb-3">
              <label for="paymentDescription" class="form-label">ÙˆØµÙ Ø§Ù„Ø¯ÙØ¹Ø©</label>
              <textarea class="form-control" id="paymentDescription" name="description" rows="3"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="paymentDocuments" class="form-label">Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø©</label>
              <input type="file" class="form-control" id="paymentDocuments" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª (PDF, Word, ØµÙˆØ±)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-success" onclick="savePayment()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Invoice Modal -->
  <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addInvoiceModalLabel">
            <i class="fas fa-file-invoice"></i>
            Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addInvoiceForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceBuilding" class="form-label">Ø§Ù„Ø¨Ù†Ø§ÙŠØ© *</label>
                <select class="form-control" id="invoiceBuilding" name="building_id" required onchange="loadUnitsForInvoice()">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceUnit" class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø© *</label>
                <select class="form-control" id="invoiceUnit" name="unit_id" required disabled onchange="updateInvoiceTenant()">
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceType" class="form-label">Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© *</label>
                <select class="form-control" id="invoiceType" name="invoice_type" required>
                  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                  <option value="electricity">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                  <option value="sewage">ØµØ±Ù ØµØ­ÙŠ</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceAmount" class="form-label">Ù…Ø¨Ù„Øº Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø¯Ø±Ù‡Ù…) *</label>
                <input type="number" class="form-control" id="invoiceAmount" name="amount" min="0" step="0.01" required>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© *</label>
                <input type="date" class="form-control" id="invoiceDate" name="invoice_date" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceTenant" class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
                <input type="text" class="form-control" id="invoiceTenant" name="tenant_name" readonly>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceStatus" class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                <select class="form-control" id="invoiceStatus" name="status">
                  <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                  <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                  <option value="overdue">Ù…ØªØ£Ø®Ø±</option>
                  <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceDueDate" class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                <input type="date" class="form-control" id="invoiceDueDate" name="due_date">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceNumber" class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
                <input type="text" class="form-control" id="invoiceNumber" name="invoice_number">
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceProvider" class="form-label">Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                <input type="text" class="form-control" id="invoiceProvider" name="provider">
              </div>
            </div>
            
            <div class="mb-3">
              <label for="invoiceDescription" class="form-label">ÙˆØµÙ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
              <textarea class="form-control" id="invoiceDescription" name="description" rows="3"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="invoiceDocuments" class="form-label">Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
              <input type="file" class="form-control" id="invoiceDocuments" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="form-text">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ø¹Ø¯Ø© Ù…Ù„ÙØ§Øª (PDF, Word, ØµÙˆØ±)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-success" onclick="saveInvoice()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check user authentication
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.id) {
        window.location.href = '/login';
        return;
      }
      
      // Store user ID globally
      window.currentUserId = user.id;
      
      // Load initial data for view system
      loadBuildingsForView();
    });

    // Modal functions for Add operations
    function openAddBuildingModal() {
      // Reset form
      document.getElementById('addBuildingForm').reset();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addBuildingModal'));
      modal.show();
    }

    // Save building function
    async function saveBuilding() {
      try {
        const form = document.getElementById('addBuildingForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const name = formData.get('name');
        if (!name.trim()) {
          alert('Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø§ÙŠØ© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addBuildingModal .btn-success');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/buildings?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ù†Ø§ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addBuildingModal'));
          modal.hide();
          form.reset();
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error saving building:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addBuildingModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©';
        saveBtn.disabled = false;
      }
    }

    async function openAddUnitModal() {
      // Reset form
      document.getElementById('addUnitForm').reset();
      
      // Load buildings for dropdown
      await loadBuildingsForUnits();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addUnitModal'));
      modal.show();
    }
    

    

    


    function openAddPaymentModal() {
      // Reset form
      document.getElementById('addPaymentForm').reset();
      
      // Load buildings for dropdown
      loadBuildingsForPayments();
      
      // Disable unit selection until building is selected
      document.getElementById('paymentUnit').disabled = true;
      document.getElementById('paymentUnit').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
      
      // Set default date to today
      document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
      
      // Hide installments container initially
      document.getElementById('paymentInstallmentsContainer').style.display = 'none';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
      modal.show();
    }
    
    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
    function generatePaymentInstallments() {
      const installmentsCount = parseInt(document.getElementById('paymentInstallments').value) || 1;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
      const paymentDate = document.getElementById('paymentDate').value;
      const paymentType = document.getElementById('paymentType').value;
      const paymentMethod = document.getElementById('paymentMethod').value;
      
      const installmentsContainer = document.getElementById('paymentInstallmentsContainer');
      const installmentsList = document.getElementById('paymentInstallmentsList');
      
      // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯Ø¯
      if (installmentsCount > 1) {
        installmentsContainer.style.display = 'block';
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¯ÙØ¹Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
        document.getElementById('paymentAmount').readOnly = true;
        document.getElementById('paymentAmount').style.backgroundColor = '#f8f9fa';
      } else {
        installmentsContainer.style.display = 'none';
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        document.getElementById('paymentAmount').readOnly = false;
        document.getElementById('paymentAmount').style.backgroundColor = '';
        return;
      }
      
      // Ø­Ø³Ø§Ø¨ Ù‚ÙŠÙ…Ø© ÙƒÙ„ Ø¯ÙØ¹Ø©
      const installmentAmount = paymentAmount / installmentsCount;
      
      let installmentsHtml = '';
      
      for (let i = 1; i <= installmentsCount; i++) {
        // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© (Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯ Ø¨ÙŠÙ† ÙƒÙ„ Ø¯ÙØ¹Ø©)
        const dueDate = new Date();
        if (paymentDate) {
          dueDate.setTime(new Date(paymentDate).getTime());
        }
        dueDate.setMonth(dueDate.getMonth() + i);
        const formattedDueDate = dueDate.toISOString().split('T')[0];
        
        installmentsHtml += `
          <div class="card mb-3 payment-installment-card">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">
                <i class="fas fa-money-bill"></i> Ø§Ù„Ø¯ÙØ¹Ø© Ø±Ù‚Ù… ${i} Ù…Ù† ${installmentsCount}
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø© (Ø¯Ø±Ù‡Ù…)</label>
                  <input type="number" class="form-control payment-installment-amount" 
                         name="payment_installment_amount_${i}" 
                         value="${installmentAmount.toFixed(2)}" 
                         min="0" step="0.01" required>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                  <input type="date" class="form-control payment-installment-due-date" 
                         name="payment_installment_due_date_${i}" 
                         value="${formattedDueDate}" required>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹Ø©</label>
                  <select class="form-control payment-installment-status" name="payment_installment_status_${i}">
                    <option value="pending">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                    <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                    <option value="overdue">Ù…ØªØ£Ø®Ø±</option>
                    <option value="cancelled">Ù…Ù„ØºÙŠ</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</label>
                  <select class="form-control payment-installment-type" name="payment_installment_type_${i}">
                    <option value="rent" ${paymentType === 'rent' ? 'selected' : ''}>Ø¥ÙŠØ¬Ø§Ø±</option>
                    <option value="sale" ${paymentType === 'sale' ? 'selected' : ''}>Ø¨ÙŠØ¹</option>
                    <option value="deposit" ${paymentType === 'deposit' ? 'selected' : ''}>Ø¹Ø±Ø¨ÙˆÙ†</option>
                    <option value="maintenance" ${paymentType === 'maintenance' ? 'selected' : ''}>ØµÙŠØ§Ù†Ø©</option>
                    <option value="other" ${paymentType === 'other' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                  </select>
                </div>
                <div class="col-md-6 mb-2">
                  <label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                  <select class="form-control payment-installment-method" name="payment_installment_method_${i}">
                    <option value="cash" ${paymentMethod === 'cash' ? 'selected' : ''}>Ù†Ù‚Ø¯Ø§Ù‹</option>
                    <option value="bank_transfer" ${paymentMethod === 'bank_transfer' ? 'selected' : ''}>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                    <option value="check" ${paymentMethod === 'check' ? 'selected' : ''}>Ø´ÙŠÙƒ</option>
                    <option value="card" ${paymentMethod === 'card' ? 'selected' : ''}>Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                    <option value="other" ${paymentMethod === 'other' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12 mb-2">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø©</label>
                  <input type="text" class="form-control payment-installment-notes" 
                         name="payment_installment_notes_${i}" 
                         placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¯ÙØ¹Ø©">
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      installmentsList.innerHTML = installmentsHtml;
      
      // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø¯ÙØ¹Ø§Øª
      addPaymentInstallmentEventListeners();
    }
    
    // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙØ¹
    function addPaymentInstallmentEventListeners() {
      const installmentCards = document.querySelectorAll('.payment-installment-card');
      
      installmentCards.forEach((card, index) => {
        const amountInput = card.querySelector('.payment-installment-amount');
        const dueDateInput = card.querySelector('.payment-installment-due-date');
        
        if (amountInput) {
          amountInput.addEventListener('change', function() {
            updatePaymentTotalAmount();
          });
        }
        
        if (dueDateInput) {
          dueDateInput.addEventListener('change', function() {
            validatePaymentDueDates();
          });
        }
      });
    }
    
    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø§Øª
    function updatePaymentTotalAmount() {
      const amountInputs = document.querySelectorAll('.payment-installment-amount');
      let total = 0;
      
      amountInputs.forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      
      console.log('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙØ¹:', total);
    }
    
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø§Øª
    function validatePaymentDueDates() {
      const dueDateInputs = document.querySelectorAll('.payment-installment-due-date');
      const dates = [];
      
      dueDateInputs.forEach(input => {
        if (input.value) {
          dates.push(new Date(input.value));
        }
      });
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ù…Ø±ØªØ¨Ø©
      for (let i = 1; i < dates.length; i++) {
        if (dates[i] <= dates[i-1]) {
          alert('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ù…Ø±ØªØ¨Ø© ØªØ±ØªÙŠØ¨Ø§Ù‹ ØªØµØ§Ø¹Ø¯ÙŠØ§Ù‹');
          return false;
        }
      }
      
      return true;
    }

    function openAddInvoiceModal() {
      // Reset form
      document.getElementById('addInvoiceForm').reset();
      
      // Load buildings for dropdown
      loadBuildingsForInvoices();
      
      // Disable unit selection until building is selected
      document.getElementById('invoiceUnit').disabled = true;
      document.getElementById('invoiceUnit').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
      
      // Set default date to today
      document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addInvoiceModal'));
      modal.show();
    }

    // Modal functions for View operations
    function openViewBuildingsModal() {
      alert('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹');
    }

    async function openViewUnitsModal() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/units?token=' + token);
        const units = await response.json();
        
        // Ø¥Ù†Ø´Ø§Ø¡ modal Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        const modalHtml = `
          <div class="modal fade" id="viewUnitsModal" tabindex="-1" aria-labelledby="viewUnitsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewUnitsModalLabel">
                    <i class="fas fa-home"></i>
                    Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                          <th>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                          <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
                          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                          <th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                          <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                          <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th>
                          <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
                          <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
                          <th>Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</th>
                          <th>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ø¡</th>
                          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${units.map(unit => `
                          <tr>
                            <td>${unit.unit_number || '-'}</td>
                            <td>${getUnitTypeName(unit.unit_type)}</td>
                            <td>${unit.rent_value ? formatPrice(unit.rent_value) : '-'}</td>
                            <td>${unit.tenant_name || '-'}</td>
                            <td>${unit.tenant_phone || '-'}</td>
                            <td>${unit.tenant_email || '-'}</td>
                            <td>${unit.installments || 1}</td>
                            <td>${unit.contract_start_date || '-'}</td>
                            <td>${unit.contract_end_date || '-'}</td>
                            <td>${unit.electricity_account || '-'}</td>
                            <td>${unit.water_account || '-'}</td>
                            <td>
                              <span class="badge ${unit.status === 'available' ? 'bg-success' : 'bg-warning'}">
                                ${unit.status === 'available' ? 'Ù…ØªØ§Ø­Ø©' : 'Ù…Ø¤Ø¬Ø±Ø©'}
                              </span>
                            </td>
                            <td>
                              <button class="btn btn-sm btn-warning" onclick="editUnit(${unit.id})">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="deleteUnit(${unit.id})">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Ø¥Ø²Ø§Ù„Ø© modal Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const existingModal = document.getElementById('viewUnitsModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // Ø¥Ø¶Ø§ÙØ© modal Ø¬Ø¯ÙŠØ¯
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Ø¹Ø±Ø¶ modal
        const modal = new bootstrap.Modal(document.getElementById('viewUnitsModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading units:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
      }
    }
    
    function getUnitTypeName(type) {
      const types = {
        'studio': 'Ø§Ø³ØªØ¯ÙŠÙˆ',
        '1-bedroom': 'ØºØ±ÙØ© ÙˆØµØ§Ù„Ø©',
        '2-bedroom': 'ØºØ±ÙØªÙŠÙ† ÙˆØµØ§Ù„Ø©',
        '3-bedroom': 'Ø«Ù„Ø§Ø« ØºØ±Ù ÙˆØµØ§Ù„Ø©',
        'commercial': 'ØªØ¬Ø§Ø±ÙŠ',
        'villa': 'ÙÙŠÙ„Ø§'
      };
      return types[type] || type;
    }
    
    function formatPrice(price) {
      return new Intl.NumberFormat('ar-EG', {
        style: 'currency',
        currency: 'AED'
      }).format(price);
    }
    
    async function editUnit(unitId) {
      try {
        console.log('Starting editUnit for unitId:', unitId);
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ modal
        const modalElement = document.getElementById('addUnitModal');
        if (!modalElement) {
          console.error('Modal addUnitModal not found!');
          alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
          return;
        }
        
        console.log('Loading buildings...');
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
        await loadBuildingsForUnits();
        console.log('Buildings loaded successfully');
        
        console.log('Fetching unit data...');
        const response = await fetch(`/api/units/${unitId}?token=${token}`);
        const unit = await response.json();
        console.log('Unit data:', unit);
        
        if (response.ok) {
          console.log('Filling form with unit data...');
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
          const elements = {
            unitName: document.getElementById('unitName'),
            unitBuilding: document.getElementById('unitBuilding'),
            unitType: document.getElementById('unitType'),
            unitRentValue: document.getElementById('unitRentValue'),
            unitTenantName: document.getElementById('unitTenantName'),
            unitTenantPhone: document.getElementById('unitTenantPhone'),
            unitTenantEmail: document.getElementById('unitTenantEmail'),
            unitContractStart: document.getElementById('unitContractStart'),
            unitContractEnd: document.getElementById('unitContractEnd'),
            unitElectricityAccount: document.getElementById('unitElectricityAccount'),
            unitWaterAccount: document.getElementById('unitWaterAccount'),
            unitDescription: document.getElementById('unitDescription')
          };
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
          for (const [key, element] of Object.entries(elements)) {
            if (!element) {
              console.error(`Element ${key} not found!`);
              alert(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ${key} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
              return;
            }
          }
          
          // Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          elements.unitName.value = unit.unit_number || '';
          elements.unitBuilding.value = unit.building_id || '';
          elements.unitType.value = unit.unit_type || '';
          elements.unitRentValue.value = unit.rent_value || '';
          elements.unitTenantName.value = unit.tenant_name || '';
          elements.unitTenantPhone.value = unit.tenant_phone || '';
          elements.unitTenantEmail.value = unit.tenant_email || '';
          elements.unitContractStart.value = unit.contract_start_date || '';
          elements.unitContractEnd.value = unit.contract_end_date || '';
          elements.unitElectricityAccount.value = unit.electricity_account || '';
          elements.unitWaterAccount.value = unit.water_account || '';
          elements.unitDescription.value = unit.description || '';
          
          console.log('Form filled successfully');
          
          // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† modal
          const modalLabel = document.getElementById('addUnitModalLabel');
          if (modalLabel) {
            modalLabel.innerHTML = '<i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©';
          }
          
          // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
          const form = document.getElementById('addUnitForm');
          if (form) {
            form.setAttribute('data-edit-id', unitId);
          }
          
          // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø­ÙØ¸
          const saveBtn = document.querySelector('#addUnitModal .btn-success');
          if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            saveBtn.onclick = updateUnit;
          }
          
          console.log('Showing modal...');
          // Ø¹Ø±Ø¶ modal
          const modal = new bootstrap.Modal(modalElement);
          modal.show();
          console.log('Modal shown successfully');
        } else {
          console.error('Error response:', response.status, response.statusText);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©');
        }
      } catch (error) {
        console.error('Error loading unit:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©');
      }
    }
    
    async function updateUnit() {
      try {
        const form = document.getElementById('addUnitForm');
        const unitId = form.getAttribute('data-edit-id');
        
        if (!unitId) {
          alert('Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
        }
        
        const formData = new FormData(form);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const unitNumber = formData.get('unit_number');
        const unitType = formData.get('unit_type');
        const buildingId = formData.get('building_id');
        const rentValue = formData.get('rent_value');
        const tenantName = formData.get('tenant_name');
        const tenantPhone = formData.get('tenant_phone');
        
        if (!unitNumber || !unitNumber.trim()) {
          alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        if (!unitType) {
          alert('Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        if (!buildingId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©');
          return;
        }
        
        if (!rentValue || rentValue <= 0) {
          alert('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù…Ø·Ù„ÙˆØ¨Ø©');
          return;
        }
        
        if (!tenantName || !tenantName.trim()) {
          alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        if (!tenantPhone || !tenantPhone.trim()) {
          alert('Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        const response = await fetch(`/api/units/${unitId}?token=${token}`, {
          method: 'PUT',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addUnitModal'));
          modal.hide();
          form.reset();
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
          // document.getElementById('addUnitModalLabel').innerHTML = '<i class="fas fa-home"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©';
          form.removeAttribute('data-edit-id');
          saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø©';
          saveBtn.onclick = saveUnit;
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error updating unit:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ­Ø¯Ø©');
      } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø±
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø©';
        saveBtn.disabled = false;
      }
    }
    
    async function deleteUnit(unitId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ')) {
        return;
      }
      
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units/${unitId}?token=${token}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
          openViewUnitsModal();
        } else {
          const result = await response.json();
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error deleting unit:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©');
      }
    }

    async function openViewPaymentsModal() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/payments?token=' + token);
        const payments = await response.json();
        
        // Ø¥Ù†Ø´Ø§Ø¡ modal Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        const modalHtml = `
          <div class="modal fade" id="viewPaymentsModal" tabindex="-1" aria-labelledby="viewPaymentsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewPaymentsModalLabel">
                    <i class="fas fa-money-bill-wave"></i>
                    Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø¯ÙØ¹Ø§Øª
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</th>
                          <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                          <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø©</th>
                          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</th>
                          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</th>
                          <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                          <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                          <th>Ø§Ù„ÙˆØµÙ</th>
                          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${payments.map(payment => `
                          <tr>
                            <td>${payment.building_name || '-'}</td>
                            <td>${payment.unit_number || '-'}</td>
                            <td>${payment.amount ? formatPrice(payment.amount) : '-'}</td>
                            <td>${getPaymentTypeName(payment.payment_type)}</td>
                            <td>${payment.payment_date || '-'}</td>
                            <td>${getPaymentMethodName(payment.payment_method)}</td>
                            <td>
                              <span class="badge ${getPaymentStatusBadge(payment.status)}">
                                ${getPaymentStatusName(payment.status)}
                              </span>
                            </td>
                            <td>${payment.due_date || '-'}</td>
                            <td>${payment.description || '-'}</td>
                            <td>
                              <button class="btn btn-sm btn-warning" onclick="editPayment(${payment.id})">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="deletePayment(${payment.id})">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Ø¥Ø²Ø§Ù„Ø© modal Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const existingModal = document.getElementById('viewPaymentsModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // Ø¥Ø¶Ø§ÙØ© modal Ø¬Ø¯ÙŠØ¯
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Ø¹Ø±Ø¶ modal
        const modal = new bootstrap.Modal(document.getElementById('viewPaymentsModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading payments:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª');
      }
    }
    
    function getPaymentTypeName(type) {
      const types = {
        'rent': 'Ø¥ÙŠØ¬Ø§Ø±',
        'sale': 'Ø¨ÙŠØ¹',
        'deposit': 'Ø¹Ø±Ø¨ÙˆÙ†',
        'maintenance': 'ØµÙŠØ§Ù†Ø©',
        'other': 'Ø£Ø®Ø±Ù‰'
      };
      return types[type] || type;
    }
    
    function getPaymentMethodName(method) {
      const methods = {
        'cash': 'Ù†Ù‚Ø¯Ø§Ù‹',
        'bank_transfer': 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
        'check': 'Ø´ÙŠÙƒ',
        'card': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
        'other': 'Ø£Ø®Ø±Ù‰'
      };
      return methods[method] || method;
    }
    
    function getPaymentStatusName(status) {
      const statuses = {
        'paid': 'Ù…Ø¯ÙÙˆØ¹',
        'pending': 'Ù…Ø¹Ù„Ù‚',
        'overdue': 'Ù…ØªØ£Ø®Ø±'
      };
      return statuses[status] || status;
    }
    
    function getPaymentStatusBadge(status) {
      const badges = {
        'paid': 'bg-success',
        'pending': 'bg-warning',
        'overdue': 'bg-danger'
      };
      return badges[status] || 'bg-secondary';
    }
    
    async function editPayment(paymentId) {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/payments/${paymentId}?token=${token}`);
        const payment = await response.json();
        
        if (response.ok) {
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
          await loadBuildingsForPayments();
          
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ù„Ù„Ø¨Ù†Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          if (payment.building_id) {
            await loadUnitsForPayment();
          }
          
          // Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          document.getElementById('paymentBuilding').value = payment.building_id || '';
          document.getElementById('paymentUnit').value = payment.unit_id || '';
          document.getElementById('paymentAmount').value = payment.amount || '';
          document.getElementById('paymentDate').value = payment.payment_date || '';
          document.getElementById('paymentType').value = payment.payment_type || '';
          document.getElementById('paymentMethod').value = payment.payment_method || '';
          document.getElementById('paymentDescription').value = payment.description || '';
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø­Ù‚Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº
          document.getElementById('paymentAmount').readOnly = false;
          document.getElementById('paymentAmount').style.backgroundColor = '';
          
          // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
          document.getElementById('paymentInstallmentsContainer').style.display = 'none';
          
          // ØªØºÙŠÙŠØ± Ø¹Ù†ÙˆØ§Ù† modal
          document.getElementById('addPaymentModalLabel').innerHTML = '<i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©';
          
          // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
          const form = document.getElementById('addPaymentForm');
          form.setAttribute('data-edit-id', paymentId);
          
          // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø­ÙØ¸
          const saveBtn = document.querySelector('#addPaymentModal .btn-success');
          saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
          saveBtn.onclick = updatePayment;
          
          // Ø¹Ø±Ø¶ modal
          const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
          modal.show();
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø©');
        }
      } catch (error) {
        console.error('Error loading payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø©');
      }
    }
    
    async function updatePayment() {
      try {
        const form = document.getElementById('addPaymentForm');
        const paymentId = form.getAttribute('data-edit-id');
        
        if (!paymentId) {
          alert('Ù…Ø¹Ø±Ù Ø§Ù„Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          return;
        }
        
        const formData = new FormData(form);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        const buildingId = formData.get('building_id');
        const unitId = formData.get('unit_id');
        const amount = formData.get('amount');
        const paymentDate = formData.get('payment_date');
        
        if (!buildingId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©');
          return;
        }
        if (!unitId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©');
          return;
        }
        if (!amount || amount <= 0) {
          alert('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ø·Ù„ÙˆØ¨Ø©');
          return;
        }
        if (!paymentDate) {
          alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
        const response = await fetch(`/api/payments/${paymentId}?token=${token}`, {
          method: 'PUT',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
          modal.hide();
          form.reset();
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
          document.getElementById('addPaymentModalLabel').innerHTML = '<i class="fas fa-money-bill-wave"></i> Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©';
          form.removeAttribute('data-edit-id');
          saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©';
          saveBtn.onclick = savePayment;
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error updating payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹Ø©');
      } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø±
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©';
        saveBtn.disabled = false;
      }
    }
    
    async function deletePayment(paymentId) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) {
        return;
      }
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch(`/api/payments/${paymentId}?token=${token}`, {
          method: 'DELETE'
        });
        let result = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            result = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©: Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¯ÙØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
          return;
        }
        if (response.ok) {
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          openViewPaymentsModal();
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result && result.error ? result.error : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©');
      }
    }

    async function openViewInvoicesModal() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/invoices?token=' + token);
        const invoices = await response.json();
        
        // Ø¥Ù†Ø´Ø§Ø¡ modal Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        const modalHtml = `
          <div class="modal fade" id="viewInvoicesModal" tabindex="-1" aria-labelledby="viewInvoicesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewInvoicesModalLabel">
                    <i class="fas fa-file-invoice"></i>
                    Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</th>
                          <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                          <th>Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                          <th>Ù…Ø¨Ù„Øº Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                          <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                          <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                          <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                          <th>Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${invoices.map(invoice => `
                          <tr>
                            <td>${invoice.building_name || '-'}</td>
                            <td>${invoice.unit_number || '-'}</td>
                            <td>${getInvoiceTypeName(invoice.invoice_type)}</td>
                            <td>${invoice.amount ? formatPrice(invoice.amount) : '-'}</td>
                            <td>${invoice.invoice_date || '-'}</td>
                            <td>${invoice.tenant_name || '-'}</td>
                            <td>
                              <span class="badge ${getInvoiceStatusBadge(invoice.status)}">
                                ${getInvoiceStatusName(invoice.status)}
                              </span>
                            </td>
                            <td>${invoice.due_date || '-'}</td>
                            <td>${invoice.invoice_number || '-'}</td>
                            <td>${invoice.provider || '-'}</td>
                            <td>
                              <button class="btn btn-sm btn-warning" onclick="editInvoice(${invoice.id})">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Ø¥Ø²Ø§Ù„Ø© modal Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        const existingModal = document.getElementById('viewInvoicesModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // Ø¥Ø¶Ø§ÙØ© modal Ø¬Ø¯ÙŠØ¯
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Ø¹Ø±Ø¶ modal
        const modal = new bootstrap.Modal(document.getElementById('viewInvoicesModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading invoices:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
      }
    }
    
    function getInvoiceTypeName(type) {
      const types = {
        'electricity': 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
        'sewage': 'ØµØ±Ù ØµØ­ÙŠ',
        'water': 'Ù…ÙŠØ§Ù‡',
        'gas': 'ØºØ§Ø²',
        'internet': 'Ø¥Ù†ØªØ±Ù†Øª',
        'other': 'Ø£Ø®Ø±Ù‰'
      };
      return types[type] || type;
    }
    
    function getInvoiceStatusName(status) {
      const statuses = {
        'unpaid': 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹',
        'paid': 'Ù…Ø¯ÙÙˆØ¹',
        'overdue': 'Ù…ØªØ£Ø®Ø±',
        'cancelled': 'Ù…Ù„ØºÙŠ'
      };
      return statuses[status] || status;
    }
    
    function getInvoiceStatusBadge(status) {
      const badges = {
        'unpaid': 'bg-warning',
        'paid': 'bg-success',
        'overdue': 'bg-danger',
        'cancelled': 'bg-secondary'
      };
      return badges[status] || 'bg-secondary';
    }
    
    function getInstallmentStatusName(status) {
      const statuses = {
        'pending': 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        'paid': 'Ù…Ø¯ÙÙˆØ¹',
        'overdue': 'Ù…ØªØ£Ø®Ø±',
        'cancelled': 'Ù…Ù„ØºÙŠ'
      };
      return statuses[status] || status;
    }
    
    function getInstallmentStatusBadge(status) {
      const badges = {
        'pending': 'bg-warning',
        'paid': 'bg-success',
        'overdue': 'bg-danger',
        'cancelled': 'bg-secondary'
      };
      return badges[status] || 'bg-secondary';
    }
    
    // New View System Functions
    async function loadBuildingsForView() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        console.log('Loading buildings for view...'); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        console.log('Buildings loaded:', buildings); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        
        const select = document.getElementById('viewBuildingSelect');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§</option>';
        
        if (buildings && buildings.length > 0) {
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
          
          console.log(`Loaded ${buildings.length} buildings`);
        } else {
          select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†Ø§ÙŠØ§Øª Ù…ØªØ§Ø­Ø©</option>';
          console.log('No buildings found');
        }
      } catch (error) {
        console.error('Error loading buildings for view:', error);
        const select = document.getElementById('viewBuildingSelect');
        select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª</option>';
      }
    }
    
    async function loadUnitsForView() {
      try {
        const buildingId = document.getElementById('viewBuildingSelect').value;
        const unitSelect = document.getElementById('viewUnitSelect');
        
        if (!buildingId) {
          unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§</option>';
          unitSelect.disabled = true;
          hideResults();
          return;
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        unitSelect.innerHTML = '<option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª...</option>';
        unitSelect.disabled = true;
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        console.log('Loading units for building ID:', buildingId); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ID Ø§Ù„Ø¨Ù†Ø§ÙŠØ©
        
        const response = await fetch(`/api/units?token=${token}&building_id=${buildingId}`);
        let units = null;
        
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            units = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          console.error('Error parsing units:', jsonErr);
          unitSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
          unitSelect.disabled = true;
          hideResults();
          return;
        }
        
        console.log('Units loaded:', units); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        
        unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§</option>';
        unitSelect.disabled = false;
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${getUnitTypeName(unit.unit_type)} - ${unit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
            unitSelect.appendChild(option);
          });
          
          console.log(`Loaded ${units.length} units for building ${buildingId}`);
        } else {
          unitSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>';
          console.log('No units found for building:', buildingId);
        }
        
        hideResults();
      } catch (error) {
        console.error('Error loading units for view:', error);
        const unitSelect = document.getElementById('viewUnitSelect');
        unitSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
        unitSelect.disabled = true;
        hideResults();
      }
    }
    
    async function loadUnitDetails() {
      try {
        const unitId = document.getElementById('viewUnitSelect').value;
        if (!unitId) {
          hideResults();
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        console.log('Loading unit details for ID:', unitId); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ID Ø§Ù„ÙˆØ­Ø¯Ø©
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        const resultsContainer = document.getElementById('viewResults');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsContent = document.getElementById('resultsContent');
        
        resultsTitle.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©...';
        resultsContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p></div>';
        resultsContainer.style.display = 'block';
        
        const response = await fetch(`/api/units/${unitId}?token=${token}`);
        let unit = null;
        
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            unit = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          console.error('Error parsing unit details:', jsonErr);
          alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©: Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„ÙˆØ­Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
          hideResults();
          return;
        }
        
        if (response.ok && unit) {
          console.log('Unit details loaded successfully:', unit); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          showUnitDetails(unit);
          
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          await loadRelatedData(unitId);
        } else {
          console.error('Failed to load unit details. Response status:', response.status);
          hideResults();
        }
      } catch (error) {
        console.error('Error loading unit details:', error);
        hideResults();
      }
    }
    
    async function loadRelatedData(unitId) {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©
        const paymentsResponse = await fetch(`/api/payments?token=${token}&unit_id=${unitId}`);
        let payments = [];
        try {
          const contentType = paymentsResponse.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            payments = await paymentsResponse.json();
          }
        } catch (e) {
          console.error('Error loading payments:', e);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©
        const invoicesResponse = await fetch(`/api/invoices?token=${token}&unit_id=${unitId}`);
        let invoices = [];
        try {
          const contentType = invoicesResponse.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            invoices = await invoicesResponse.json();
          }
        } catch (e) {
          console.error('Error loading invoices:', e);
        }
        
        // Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        showRelatedDataSummary(payments, invoices);
        
      } catch (error) {
        console.error('Error loading related data:', error);
      }
    }
    
    function showRelatedDataSummary(payments, invoices) {
      const resultsContent = document.getElementById('resultsContent');
      const currentContent = resultsContent.innerHTML;
      
      console.log('Showing related data summary - Payments:', payments.length, 'Invoices:', invoices.length);
      
      const summaryHtml = `
        <div class="row mt-3">
          <div class="col-12">
            <h6 class="text-primary">
              <i class="fas fa-chart-bar"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-primary">
                      <i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø¯ÙØ¹Ø§Øª
                    </h5>
                    <h3 class="text-success">${payments.length}</h3>
                    <p class="card-text">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©</p>
                    <button class="btn btn-info btn-sm" onclick="loadDataByType('payments')">
                      <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-primary">
                      <i class="fas fa-file-invoice"></i> Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                    </h5>
                    <h3 class="text-warning">${invoices.length}</h3>
                    <p class="card-text">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©</p>
                    <button class="btn btn-info btn-sm" onclick="loadDataByType('invoices')">
                      <i class="fas fa-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-success">
                  <i class="fas fa-check-circle"></i> ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      resultsContent.innerHTML = currentContent + summaryHtml;
    }
    
    function showUnitDetails(unit) {
      const resultsContainer = document.getElementById('viewResults');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsContent = document.getElementById('resultsContent');
      
      console.log('Showing unit details:', unit); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      
      resultsTitle.innerHTML = '<i class="fas fa-home"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©';
      
      const detailsHtml = `
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­
        </div>
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-building"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
            </h6>
            <table class="table table-borderless table-striped">
              <tr><td><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©:</strong></td><td>${unit.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©:</strong></td><td>${getUnitTypeName(unit.unit_type)}</td></tr>
              <tr><td><strong>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</strong></td><td>${unit.rent_value ? formatPrice(unit.rent_value) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ø§Ù„Ø¨Ù†Ø§ÙŠØ©:</strong></td><td>${unit.building_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong></td><td><span class="badge ${unit.status === 'available' ? 'bg-success' : 'bg-warning'}">${unit.status === 'available' ? 'Ù…ØªØ§Ø­Ø©' : 'Ù…Ø¤Ø¬Ø±Ø©'}</span></td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
            </h6>
            <table class="table table-borderless table-striped">
              <tr><td><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong></td><td>${unit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±:</strong></td><td>${unit.tenant_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong></td><td>${unit.tenant_email || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª:</strong></td><td>${unit.installments || 1}</td></tr>
              <tr><td><strong>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:</strong></td><td>${unit.contract_start_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯:</strong></td><td>${unit.contract_end_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
            </table>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-tools"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
            </h6>
            <table class="table table-borderless table-striped">
              <tr><td><strong>Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡:</strong></td><td>${unit.electricity_account || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
              <tr><td><strong>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ø¡:</strong></td><td>${unit.water_account || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-cogs"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
            </h6>
            <div class="d-flex gap-2">
              <button class="btn btn-warning btn-sm" onclick="editUnit(${unit.id})">
                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø©
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteUnit(${unit.id})">
                <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©
              </button>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­
              <br>
              <small>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${unit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${unit.tenant_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
            </div>
          </div>
        </div>
      `;
      
      resultsContent.innerHTML = detailsHtml;
      resultsContainer.style.display = 'block';
    }
    
    async function loadDataByType(dataType = null) {
      try {
        const selectedDataType = dataType || document.getElementById('viewDataType').value;
        const buildingId = document.getElementById('viewBuildingSelect').value;
        const unitId = document.getElementById('viewUnitSelect').value;
        
        if (!selectedDataType) {
          hideResults();
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        let url = '';
        let title = '';
        
        switch (selectedDataType) {
          case 'units':
            url = buildingId ? `/api/units?token=${token}&building_id=${buildingId}` : `/api/units?token=${token}`;
            title = 'Ø§Ù„ÙˆØ­Ø¯Ø§Øª';
            break;
          case 'payments':
            url = unitId ? `/api/payments?token=${token}&unit_id=${unitId}` : `/api/payments?token=${token}`;
            title = 'Ø§Ù„Ø¯ÙØ¹Ø§Øª';
            break;
          case 'invoices':
            url = unitId ? `/api/invoices?token=${token}&unit_id=${unitId}` : `/api/invoices?token=${token}`;
            title = 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±';
            break;
        }
        
        console.log('Loading data from URL:', url); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† URL
        
        const response = await fetch(url);
        let data = null;
        
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            data = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          console.error('JSON parsing error:', jsonErr);
          showDataResults([], selectedDataType, title); // Ø¹Ø±Ø¶ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
          return;
        }
        
        console.log('Data loaded:', data); // Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        showDataResults(data, selectedDataType, title);
        
      } catch (error) {
        console.error('Error loading data by type:', error);
        showDataResults([], dataType || document.getElementById('viewDataType').value, '');
      }
    }
    
    function showDataResults(data, dataType, title) {
      const resultsContainer = document.getElementById('viewResults');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsContent = document.getElementById('resultsContent');
      
      console.log('Showing data results:', { dataType, title, dataLength: data ? data.length : 0 });
      
      resultsTitle.innerHTML = `<i class="fas fa-list"></i> ${title}`;
      
      if (!data || data.length === 0) {
        resultsContent.innerHTML = `
          <div class="text-center text-muted">
            <i class="fas fa-info-circle"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
            <br>
            <small>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${title} Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</small>
          </div>
        `;
        resultsContainer.style.display = 'block';
        return;
      }
      
      let tableHtml = '';
      
      switch (dataType) {
        case 'units':
          tableHtml = createUnitsTable(data);
          break;
        case 'payments':
          tableHtml = createPaymentsTable(data);
          break;
        case 'invoices':
          tableHtml = createInvoicesTable(data);
          break;
      }
      
      resultsContent.innerHTML = `
        <div class="alert alert-success">
          <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${data.length} ${title}
        </div>
        ${tableHtml}
      `;
      resultsContainer.style.display = 'block';
    }
    
    function createUnitsTable(units) {
      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</th>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                <th>Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th>
                <th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th>Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</th>
                <th>Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ø¡</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${units.map(unit => `
                <tr>
                  <td><strong>${unit.unit_number || '-'}</strong></td>
                  <td>${getUnitTypeName(unit.unit_type)}</td>
                  <td><span class="text-success fw-bold">${unit.rent_value ? formatPrice(unit.rent_value) : '-'}</span></td>
                  <td><span class="text-primary">${unit.tenant_name || '-'}</span></td>
                  <td><span class="text-info">${unit.tenant_phone || '-'}</span></td>
                  <td>${unit.tenant_email || '-'}</td>
                  <td><span class="badge bg-secondary">${unit.installments || 1}</span></td>
                  <td>${unit.contract_start_date || '-'}</td>
                  <td>${unit.contract_end_date || '-'}</td>
                  <td><span class="text-warning">${unit.electricity_account || '-'}</span></td>
                  <td><span class="text-info">${unit.water_account || '-'}</span></td>
                  <td>
                    <span class="badge ${unit.status === 'available' ? 'bg-success' : 'bg-warning'}">
                      ${unit.status === 'available' ? 'Ù…ØªØ§Ø­Ø©' : 'Ù…Ø¤Ø¬Ø±Ø©'}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editUnit(${unit.id})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUnit(${unit.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="mt-3">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> ØªÙ… Ø¹Ø±Ø¶ ${units.length} ÙˆØ­Ø¯Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ ØªÙØ§ØµÙŠÙ„Ù‡Ø§
          </div>
        </div>
      `;
    }
    
    function createPaymentsTable(payments) {
      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø©</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</th>
                <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                <th>Ø§Ù„ÙˆØµÙ</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${payments.map(payment => `
                <tr>
                  <td>${payment.building_name || '-'}</td>
                  <td>${payment.unit_number || '-'}</td>
                  <td>${payment.amount ? formatPrice(payment.amount) : '-'}</td>
                  <td>${getPaymentTypeName(payment.payment_type)}</td>
                  <td>${payment.payment_date || '-'}</td>
                  <td>${getPaymentMethodName(payment.payment_method)}</td>
                  <td>
                    <span class="badge ${getPaymentStatusBadge(payment.status)}">
                      ${getPaymentStatusName(payment.status)}
                    </span>
                  </td>
                  <td>${payment.due_date || '-'}</td>
                  <td>${payment.description || '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editPayment(${payment.id})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletePayment(${payment.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    function createInvoicesTable(invoices) {
      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ù…Ø¨Ù„Øº Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                <th>Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${invoices.map(invoice => `
                <tr>
                  <td>${invoice.building_name || '-'}</td>
                  <td>${invoice.unit_number || '-'}</td>
                  <td>${getInvoiceTypeName(invoice.invoice_type)}</td>
                  <td>${invoice.amount ? formatPrice(invoice.amount) : '-'}</td>
                  <td>${invoice.invoice_date || '-'}</td>
                  <td>${invoice.tenant_name || '-'}</td>
                  <td>
                    <span class="badge ${getInvoiceStatusBadge(invoice.status)}">
                      ${getInvoiceStatusName(invoice.status)}
                    </span>
                  </td>
                  <td>${invoice.due_date || '-'}</td>
                  <td>${invoice.invoice_number || '-'}</td>
                  <td>${invoice.provider || '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editInvoice(${invoice.id})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    function hideResults() {
      const resultsContainer = document.getElementById('viewResults');
      if (resultsContainer) {
        resultsContainer.style.display = 'none';
        console.log('Results hidden');
      }
    }
    
    // Quick Actions Functions
    async function loadAllBuildings() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        showDataResults(buildings, 'buildings', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª');
      } catch (error) {
        console.error('Error loading all buildings:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª');
      }
    }
    
    async function loadAllUnits() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch('/api/units?token=' + token);
        let units = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            units = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          showDataResults([], 'units', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
          return;
        }
        showDataResults(units, 'units', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
      } catch (error) {
        console.error('Error loading all units:', error);
        showDataResults([], 'units', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª');
      }
    }
    
    async function loadAllPayments() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch('/api/payments?token=' + token);
        let payments = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            payments = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          showDataResults([], 'payments', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª');
          return;
        }
        showDataResults(payments, 'payments', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª');
      } catch (error) {
        console.error('Error loading all payments:', error);
        showDataResults([], 'payments', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª');
      }
    }
    
    async function loadAllInvoices() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch('/api/invoices?token=' + token);
        let invoices = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            invoices = await response.json();
          } else {
            throw new Error('Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ³ JSON (Ù‚Ø¯ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…)');
          }
        } catch (jsonErr) {
          showDataResults([], 'invoices', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
          return;
        }
        showDataResults(invoices, 'invoices', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
      } catch (error) {
        console.error('Error loading all invoices:', error);
        showDataResults([], 'invoices', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ±');
      }
    }

    // Helper functions to load dropdowns
    async function loadBuildingsForUnits() {
      try {
        console.log('loadBuildingsForUnits: Starting...');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        console.log('loadBuildingsForUnits: Token:', token);
        
        const response = await fetch('/api/buildings?token=' + token);
        console.log('loadBuildingsForUnits: Response status:', response.status);
        const buildings = await response.json();
        console.log('loadBuildingsForUnits: Buildings data:', buildings);
        
        const select = document.getElementById('unitBuilding');
        console.log('loadBuildingsForUnits: Found select element:', select);
        
        if (!select) {
          console.error('loadBuildingsForUnits: unitBuilding element not found!');
          return;
        }
        
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>';
        
        if (buildings && buildings.length > 0) {
          console.log('loadBuildingsForUnits: Adding', buildings.length, 'buildings to dropdown');
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
          console.log('loadBuildingsForUnits: Dropdown populated successfully');
        } else {
          console.log('loadBuildingsForUnits: No buildings found');
          select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†Ø§ÙŠØ§Øª Ù…ØªØ§Ø­Ø©</option>';
        }
      } catch (error) {
        console.error('Error loading buildings:', error);
        const select = document.getElementById('unitBuilding');
        if (select) {
          select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª</option>';
        }
      }
    }
    
    async function loadBuildingsForPayments() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        const select = document.getElementById('paymentBuilding');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>';
        
        if (buildings && buildings.length > 0) {
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†Ø§ÙŠØ§Øª Ù…ØªØ§Ø­Ø©</option>';
        }
      } catch (error) {
        console.error('Error loading buildings for payments:', error);
        const select = document.getElementById('paymentBuilding');
        select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª</option>';
      }
    }
    
    async function loadBuildingsForInvoices() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        const select = document.getElementById('invoiceBuilding');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>';
        
        if (buildings && buildings.length > 0) {
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†Ø§ÙŠØ§Øª Ù…ØªØ§Ø­Ø©</option>';
        }
      } catch (error) {
        console.error('Error loading buildings for invoices:', error);
        const select = document.getElementById('invoiceBuilding');
        select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù†Ø§ÙŠØ§Øª</option>';
      }
    }
    
    async function loadUnitsForInvoice() {
      try {
        const buildingId = document.getElementById('invoiceBuilding').value;
        const unitSelect = document.getElementById('invoiceUnit');
        
        if (!buildingId) {
          unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
          unitSelect.disabled = true;
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
          document.getElementById('invoiceTenant').value = '';
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units?token=${token}&building_id=${buildingId}`);
        const units = await response.json();
        
        unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
        unitSelect.disabled = false;
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${getUnitTypeName(unit.unit_type)} - ${unit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
            unitSelect.appendChild(option);
          });
        } else {
          unitSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>';
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
        document.getElementById('invoiceTenant').value = '';
      } catch (error) {
        console.error('Error loading units for invoice:', error);
        const unitSelect = document.getElementById('invoiceUnit');
        unitSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
        unitSelect.disabled = true;
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±
        document.getElementById('invoiceTenant').value = '';
      }
    }
    
    async function updateInvoiceTenant() {
      try {
        const unitId = document.getElementById('invoiceUnit').value;
        
        if (!unitId) {
          document.getElementById('invoiceTenant').value = '';
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units/${unitId}?token=${token}`);
        const unit = await response.json();
        
        if (response.ok && unit) {
          document.getElementById('invoiceTenant').value = unit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        } else {
          document.getElementById('invoiceTenant').value = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        }
      } catch (error) {
        console.error('Error loading unit details:', error);
        document.getElementById('invoiceTenant').value = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      }
    }
    
    async function loadUnitsForPayment() {
      try {
        const buildingId = document.getElementById('paymentBuilding').value;
        const unitSelect = document.getElementById('paymentUnit');
        
        if (!buildingId) {
          unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹</option>';
          unitSelect.disabled = true;
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units?token=${token}&building_id=${buildingId}`);
        const units = await response.json();
        
        unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
        unitSelect.disabled = false;
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${getUnitTypeName(unit.unit_type)} - ${unit.tenant_name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
            unitSelect.appendChild(option);
          });
        } else {
          unitSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ù†Ø§ÙŠØ©</option>';
        }
      } catch (error) {
        console.error('Error loading units for payment:', error);
        const unitSelect = document.getElementById('paymentUnit');
        unitSelect.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
        unitSelect.disabled = true;
      }
    }

    async function loadUnitsForPayments() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/units?token=' + token);
        const units = await response.json();
        
        const select = document.getElementById('paymentUnit');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${getUnitTypeName(unit.unit_type)}`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø©</option>';
        }
      } catch (error) {
        console.error('Error loading units:', error);
        const select = document.getElementById('paymentUnit');
        select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
      }
    }

    async function loadUnitsForInvoices() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/units?token=' + token);
        const units = await response.json();
        
        const select = document.getElementById('invoiceUnit');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} - ${getUnitTypeName(unit.unit_type)}`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø©</option>';
        }
      } catch (error) {
        console.error('Error loading units:', error);
        const select = document.getElementById('invoiceUnit');
        select.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
      }
    }

    // Save functions
    async function saveUnit() {
      try {
        const form = document.getElementById('addUnitForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const unitNumber = formData.get('unit_number');
        const unitType = formData.get('unit_type');
        const buildingId = formData.get('building_id');
        const rentValue = formData.get('rent_value');
        const tenantName = formData.get('tenant_name');
        const tenantPhone = formData.get('tenant_phone');
        
        if (!unitNumber || !unitNumber.trim()) {
          alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        if (!unitType) {
          alert('Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        if (!buildingId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©');
          return;
        }
        
        if (!rentValue || rentValue <= 0) {
          alert('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù…Ø·Ù„ÙˆØ¨Ø©');
          return;
        }
        
        if (!tenantName || !tenantName.trim()) {
          alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        if (!tenantPhone || !tenantPhone.trim()) {
          alert('Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/units?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addUnitModal'));
          modal.hide();
          form.reset();
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error saving unit:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙˆØ­Ø¯Ø©';
        saveBtn.disabled = false;
      }
    }

    async function savePayment() {
      try {
        const form = document.getElementById('addPaymentForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const buildingId = formData.get('building_id');
        const unitId = formData.get('unit_id');
        const amount = formData.get('amount');
        const paymentDate = formData.get('payment_date');
        const installmentsCount = parseInt(formData.get('installments')) || 1;
        
        if (!buildingId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©');
          return;
        }
        if (!unitId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©');
          return;
        }
        if (!amount || amount <= 0) {
          alert('Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ø·Ù„ÙˆØ¨Ø©');
          return;
        }
        if (!paymentDate) {
          alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª > 1ØŒ Ø£Ø¶Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        if (installmentsCount > 1) {
          const installmentsContainer = document.getElementById('paymentInstallmentsContainer');
          if (installmentsContainer.style.display !== 'none') {
            console.log(`Processing ${installmentsCount} installments...`);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø­Ù‚Ù„ amount Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„ØªØ¬Ù†Ø¨ ØªØ¶Ù…ÙŠÙ†Ù‡ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨
            formData.delete('amount');
            
            // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
            for (let i = 1; i <= installmentsCount; i++) {
              const installmentAmount = document.querySelector(`input[name="payment_installment_amount_${i}"]`);
              const installmentDueDate = document.querySelector(`input[name="payment_installment_due_date_${i}"]`);
              const installmentStatus = document.querySelector(`select[name="payment_installment_status_${i}"]`);
              const installmentType = document.querySelector(`select[name="payment_installment_type_${i}"]`);
              const installmentMethod = document.querySelector(`select[name="payment_installment_method_${i}"]`);
              const installmentNotes = document.querySelector(`input[name="payment_installment_notes_${i}"]`);
              
              console.log(`Installment ${i} elements:`, {
                amount: installmentAmount,
                dueDate: installmentDueDate,
                status: installmentStatus,
                type: installmentType,
                method: installmentMethod,
                notes: installmentNotes
              });
              
              // Ø·Ø¨Ø§Ø¹Ø© ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ´Ø®ÙŠØµ
              if (installmentAmount) {
                console.log(`Installment ${i} amount element found:`, installmentAmount.value);
              } else {
                console.log(`Installment ${i} amount element NOT found`);
              }
              
              if (installmentDueDate) {
                console.log(`Installment ${i} due date element found:`, installmentDueDate.value);
              } else {
                console.log(`Installment ${i} due date element NOT found`);
              }
              
              if (installmentAmount && installmentDueDate) {
                const amountValue = installmentAmount.value;
                const dueDateValue = installmentDueDate.value;
                const statusValue = installmentStatus ? installmentStatus.value : 'pending';
                const typeValue = installmentType ? installmentType.value : formData.get('payment_type');
                const methodValue = installmentMethod ? installmentMethod.value : formData.get('payment_method');
                const notesValue = installmentNotes ? installmentNotes.value : '';
                
                console.log(`Adding installment ${i} data:`, {
                  amount: amountValue,
                  dueDate: dueDateValue,
                  status: statusValue,
                  type: typeValue,
                  method: methodValue,
                  notes: notesValue
                });
                
                formData.append(`payment_installment_amount_${i}`, amountValue);
                formData.append(`payment_installment_due_date_${i}`, dueDateValue);
                formData.append(`payment_installment_status_${i}`, statusValue);
                formData.append(`payment_installment_type_${i}`, typeValue);
                formData.append(`payment_installment_method_${i}`, methodValue);
                formData.append(`payment_installment_notes_${i}`, notesValue);
              } else {
                console.log(`Skipping installment ${i} - missing required elements`);
              }
            }
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©
            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
              console.log(`${key}: ${value}`);
            }
          }
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/payments?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          const paymentsAdded = result.paymentsAdded || 1;
          alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${paymentsAdded} Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
          const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
          modal.hide();
          form.reset();
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
          document.getElementById('paymentInstallmentsContainer').style.display = 'none';
          document.getElementById('paymentAmount').readOnly = false;
          document.getElementById('paymentAmount').style.backgroundColor = '';
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error saving payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©';
        saveBtn.disabled = false;
      }
    }

    async function saveInvoice() {
      try {
        const form = document.getElementById('addInvoiceForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const buildingId = formData.get('building_id');
        const unitId = formData.get('unit_id');
        const invoiceType = formData.get('invoice_type');
        const amount = formData.get('amount');
        const invoiceDate = formData.get('invoice_date');
        
        if (!buildingId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ø§ÙŠØ©');
          return;
        }
        if (!unitId) {
          alert('Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©');
          return;
        }
        if (!invoiceType) {
          alert('Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        if (!amount || amount <= 0) {
          alert('Ù…Ø¨Ù„Øº Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        if (!invoiceDate) {
          alert('ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø·Ù„ÙˆØ¨');
          return;
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addInvoiceModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/invoices?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal'));
          modal.hide();
          form.reset();
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
      } catch (error) {
        console.error('Error saving invoice:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addInvoiceModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©';
        saveBtn.disabled = false;
      }
    }

    // Payment Status Functions
    let currentUser = null;
    let payments = [];

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function loadUser() {
      try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† URL
        let token = localStorage.getItem('token');
        if (!token) {
          // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† URL
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping user load');
          return;
        }

        const response = await fetch(`/api/users?token=${token}`);
        const users = await response.json();
        currentUser = users.find(user => user.id == token);
        
        if (!currentUser) {
          console.log('User not found, skipping user load');
          return;
        }
      } catch (error) {
        console.error('Error loading user:', error);
        // Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ØŒ ÙÙ‚Ø· Ù†Ø·Ø¨Ø¹ Ø§Ù„Ø®Ø·Ø£
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ
    async function loadBuildings() {
      try {
        console.log('Loading buildings...');
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping buildings load');
          return;
        }
        
        console.log('Fetching buildings with token:', token);
        const response = await fetch(`/api/buildings?token=${token}`);
        console.log('Buildings response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const buildings = await response.json();
        console.log('Buildings loaded:', buildings.length);
        console.log('Buildings data:', buildings);
        
        const buildingSelect = document.getElementById('buildingSelect');
        if (buildingSelect) {
          buildingSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ</option>';
          
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            buildingSelect.appendChild(option);
          });
          console.log('Buildings dropdown populated with', buildings.length, 'buildings');
        } else {
          console.error('buildingSelect element not found');
        }
      } catch (error) {
        console.error('Error loading buildings:', error);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
    async function loadUnits(buildingId = '') {
      try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping units load');
          return;
        }
        
        let url = `/api/units?token=${token}`;
        if (buildingId) {
          url += `&building_id=${buildingId}`;
        }
        
        const response = await fetch(url);
        const units = await response.json();
        
        const unitSelect = document.getElementById('unitSelect');
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>';
          
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number} - ${unit.unit_type}`;
            unitSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading units:', error);
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª
    async function loadPayments() {
      try {
        console.log('Loading payments...');
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping payments load');
          return;
        }
        
        const unitId = document.getElementById('unitSelect')?.value || '';
        
        let url = `/api/payments?token=${token}`;
        if (unitId) {
          url += `&unit_id=${unitId}`;
        }
        
        console.log('Fetching payments from:', url);
        const response = await fetch(url);
        console.log('Payments response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const payments = await response.json();
        console.log('Payments loaded:', payments.length);
        console.log('Payments data:', payments);
        
        displayPayments(payments);
      } catch (error) {
        console.error('Error loading payments:', error);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙØ¹Ø§Øª
    function displayPayments(payments) {
      console.log('Displaying payments:', payments);
      const paymentsList = document.getElementById('paymentsList');
      if (!paymentsList) {
        console.error('paymentsList element not found');
        return;
      }
      
      console.log('Found paymentsList element, clearing content...');
      paymentsList.innerHTML = '';
      
      if (!payments || payments.length === 0) {
        console.log('No payments to display');
        paymentsList.innerHTML = `
          <div class="col-12 text-center">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª</p>
          </div>
        `;
        return;
      }
      
      console.log('Creating payment cards for', payments.length, 'payments');
      payments.forEach((payment, index) => {
        console.log(`Creating card for payment ${index + 1}:`, payment);
        const paymentCard = createPaymentCard(payment);
        paymentsList.appendChild(paymentCard);
      });
      
      console.log('Payment cards created successfully');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙØ¹
    function createPaymentCard(payment) {
      console.log('Creating payment card for payment:', payment);
      
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4 mb-4';
      
      const statusClass = getStatusClass(payment.calculated_status);
      const progressPercent = payment.payment_percentage || 0;
      
      console.log('Payment card data:', {
        id: payment.id,
        unit_number: payment.unit_number,
        amount: payment.amount,
        paid_amount: payment.paid_amount,
        remaining_amount: payment.remaining_amount,
        calculated_status: payment.calculated_status,
        status_arabic: payment.status_arabic,
        progressPercent: progressPercent
      });
      
      col.innerHTML = `
        <div class="card payment-card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-credit-card"></i>
              Ø¯ÙØ¹Ø© #${payment.id}
            </h6>
            <span class="status-badge ${statusClass}">
              ${payment.status_arabic}
            </span>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <strong>Ø§Ù„ÙˆØ­Ø¯Ø©:</strong> ${payment.unit_number}
            </div>
            <div class="mb-3">
              <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${payment.amount} Ø¯Ø±Ù‡Ù…
            </div>
            <div class="mb-3">
              <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${payment.paid_amount || 0} Ø¯Ø±Ù‡Ù…
            </div>
            <div class="mb-3">
              <strong>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${payment.remaining_amount} Ø¯Ø±Ù‡Ù…
            </div>
            <div class="mb-3">
              <strong>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙØ¹:</strong>
              <div class="progress">
                <div class="progress-bar" style="width: ${progressPercent}%"></div>
              </div>
              <small class="text-muted">${progressPercent}%</small>
            </div>
            <div class="mb-3">
              <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</strong> ${payment.due_date}
            </div>
            <div class="mb-3">
              <strong>Ø§Ù„ÙˆØµÙ:</strong> ${payment.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}
            </div>
            ${payment.receipt_documents ? `
              <div class="mb-3">
                <strong>Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶:</strong>
                <div class="mt-2">
                  ${payment.receipt_documents.split(',').map(doc => 
                    `<a href="/uploads/${doc}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                      <i class="fas fa-file"></i> ${doc}
                    </a>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="card-footer">
            <button class="btn btn-primary btn-sm w-100" onclick="openUpdateModal(${payment.id})">
              <i class="fas fa-edit"></i>
              ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
            </button>
          </div>
        </div>
      `;
      
      console.log('Payment card created successfully');
      return col;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙØ¦Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    function getStatusClass(status) {
      switch (status) {
        case 'paid_full':
          return 'status-paid-full';
        case 'paid_partial':
          return 'status-paid-partial';
        case 'overdue':
          return 'status-overdue';
        default:
          return 'status-pending';
      }
    }

    // ÙØªØ­ modal Ø§Ù„ØªØ­Ø¯ÙŠØ«
    async function openUpdateModal(paymentId) {
      try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
          return;
        }
        
        const response = await fetch(`/api/payments/${paymentId}/details?token=${token}`);
        const payment = await response.json();
        
        document.getElementById('paymentId').value = payment.id;
        document.getElementById('totalAmount').value = payment.amount;
        document.getElementById('paidAmount').value = payment.paid_amount || 0;
        document.getElementById('paymentStatus').value = payment.payment_status || 'pending';
        document.getElementById('paymentDateActual').value = payment.payment_date_actual || '';
        document.getElementById('paymentNotes').value = '';
        document.getElementById('selectedFiles').innerHTML = '';
        
        const modal = new bootstrap.Modal(document.getElementById('updatePaymentModal'));
        modal.show();
      } catch (error) {
        console.error('Error loading payment details:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹');
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹
    async function updatePayment() {
      const paymentId = document.getElementById('paymentId').value;
      const paidAmount = parseFloat(document.getElementById('paidAmount').value);
      const paymentStatus = document.getElementById('paymentStatus').value;
      const paymentDateActual = document.getElementById('paymentDateActual').value;
      const notes = document.getElementById('paymentNotes').value;
      
      if (!paidAmount || paidAmount < 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
        return;
      }
      
      const formData = new FormData();
      formData.append('paid_amount', paidAmount);
      formData.append('payment_status', paymentStatus);
      if (paymentDateActual) {
        formData.append('payment_date_actual', paymentDateActual);
      }
      if (notes) {
        formData.append('notes', notes);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
      const fileInput = document.getElementById('receiptDocuments');
      for (let file of fileInput.files) {
        formData.append('receipt_documents', file);
      }
      
      try {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
          return;
        }
        
        const response = await fetch(`/api/payments/${paymentId}/payment-status?token=${token}`, {
          method: 'PUT',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­');
          
          // Ø¥ØºÙ„Ø§Ù‚ Modal ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          bootstrap.Modal.getInstance(document.getElementById('updatePaymentModal')).hide();
          await loadPayments();
        } else {
          const error = await response.json();
          alert('Ø®Ø·Ø£: ' + error.error);
        }
      } catch (error) {
        console.error('Error updating payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹');
      }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ drag and drop Ù„Ù„Ù…Ù„ÙØ§Øª
    function setupFileUpload() {
      const fileUpload = document.getElementById('fileUpload');
      const fileInput = document.getElementById('receiptDocuments');
      const selectedFiles = document.getElementById('selectedFiles');
      
      fileUpload.addEventListener('click', () => fileInput.click());
      
      fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
      });
      
      fileUpload.addEventListener('dragleave', () => {
        fileUpload.classList.remove('dragover');
      });
      
      fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        updateSelectedFiles();
      });
      
      fileInput.addEventListener('change', updateSelectedFiles);
      
      function updateSelectedFiles() {
        selectedFiles.innerHTML = '';
        for (let file of fileInput.files) {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'alert alert-info d-flex justify-content-between align-items-center';
          fileDiv.innerHTML = `
            <span><i class="fas fa-file"></i> ${file.name}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          `;
          selectedFiles.appendChild(fileDiv);
        }
      }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ event listeners Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    document.addEventListener('DOMContentLoaded', function() {
      // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const buildingSelect = document.getElementById('buildingSelect');
      const unitSelect = document.getElementById('unitSelect');
      
      if (buildingSelect) {
        buildingSelect.addEventListener('change', function() {
          loadUnits(this.value);
        });
      }
      
      if (unitSelect) {
        unitSelect.addEventListener('change', loadPayments);
      }

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ ÙØªØ­Ù‡
      const paymentStatusTab = document.getElementById('payment-status-tab');
      if (paymentStatusTab) {
        paymentStatusTab.addEventListener('shown.bs.tab', async function() {
          console.log('Payment status tab opened');
          try {
            console.log('Starting to load data for payment status tab...');
            await loadUser();
            console.log('User loaded successfully');
            await loadBuildings();
            console.log('Buildings loaded successfully');
            await loadUnits();
            console.log('Units loaded successfully');
            await loadPayments();
            console.log('Payments loaded successfully');
            setupFileUpload();
            console.log('File upload setup completed');
          } catch (error) {
            console.error('Error initializing payment status tab:', error);
          }
        });
      }
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù…ÙØªÙˆØ­
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking if payment status tab is active...');
        const paymentStatusTab = document.getElementById('payment-status-tab');
        const paymentStatusPane = document.getElementById('payment-status');
        
        if (paymentStatusTab && paymentStatusTab.classList.contains('active')) {
          console.log('Payment status tab is active, loading data...');
          loadUser().then(() => {
            loadBuildings().then(() => {
              loadUnits().then(() => {
                loadPayments();
              });
            });
          });
        }
      });
    });
  </script>

  <!-- Modal ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ -->
  <div class="modal fade" id="updatePaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-edit"></i>
            ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="updatePaymentForm">
            <input type="hidden" id="paymentId">
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</label>
                  <input type="text" id="totalAmount" class="form-control" readonly>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</label>
                  <input type="number" id="paidAmount" class="form-control" step="0.01" required>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹:</label>
                  <select id="paymentStatus" class="form-select" required>
                    <option value="pending">Ù…Ø¹Ù„Ù‚</option>
                    <option value="paid_partial">Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ</option>
                    <option value="paid_full">Ø¯ÙØ¹ ÙƒÙ„ÙŠ</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ:</label>
                  <input type="date" id="paymentDateActual" class="form-control">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶:</label>
              <div class="file-upload" id="fileUpload">
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª</p>
                <input type="file" id="receiptDocuments" multiple accept="image/*,.pdf" style="display: none;">
                <div id="selectedFiles" class="mt-3"></div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
              <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-primary" onclick="updatePayment()">
            <i class="fas fa-save"></i>
            Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html> 