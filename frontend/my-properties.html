<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ÿπŸÇÿßÿ±ÿßÿ™Ÿä | Golden House</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }

    .header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .logo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .header-buttons {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn-primary {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      border: none;
      border-radius: 25px;
      padding: 10px 25px;
      color: #333;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .btn-primary:hover {
      background: linear-gradient(45deg, #FFA500, #FF6347);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 165, 0, 0.4);
      color: white;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      padding: 10px 25px;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      transform: translateY(-2px);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .page-title {
      color: white;
      text-align: center;
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .page-subtitle {
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 40px;
    }

    .tabs-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .nav-tabs {
      border-bottom: 2px solid #FFD700;
      margin-bottom: 30px;
    }

    .nav-tabs .nav-link {
      border: none;
      color: #666;
      font-weight: 600;
      padding: 15px 25px;
      border-radius: 15px 15px 0 0;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.active {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      border: none;
    }

    .nav-tabs .nav-link:hover {
      background: rgba(255, 215, 0, 0.1);
      color: #333;
    }

    /* Payment Status Tab Styles */
    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
    }

    .status-pending {
      background: linear-gradient(45deg, #ffecd2, #fcb69f);
      color: #8b4513;
    }

    .status-paid-full {
      background: linear-gradient(45deg, #a8e6cf, #56ab2f);
      color: #fff;
    }

    .status-paid-partial {
      background: linear-gradient(45deg, #ffecd2, #fcb69f);
      color: #8b4513;
    }

    .status-overdue {
      background: linear-gradient(45deg, #f093fb, #f5576c);
      color: #fff;
    }

    .payment-card {
      transition: transform 0.3s ease;
    }

    .payment-card:hover {
      transform: translateY(-5px);
    }

    .progress {
      height: 8px;
      border-radius: 10px;
    }

    .file-upload {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .file-upload:hover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .file-upload.dragover {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.2);
    }

    .tab-content {
      padding: 20px 0;
    }

    .add-card {
      border: 2px solid #28a745;
      background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
      transition: all 0.3s ease;
    }

    .add-card .card-header {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border-radius: 15px 15px 0 0 !important;
    }

    .view-card {
      border: 2px solid #007bff;
      background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
      transition: all 0.3s ease;
    }

    .view-card .card-header {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      border-radius: 15px 15px 0 0 !important;
    }

    .add-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(40, 167, 69, 0.2);
    }

    .view-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 123, 255, 0.2);
    }

    .card-body {
      padding: 1.5rem;
    }

    .card-text {
      color: #666;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .btn {
      border-radius: 25px;
      font-weight: 600;
      padding: 10px 20px;
      transition: all 0.3s ease;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    /* Modal Styles */
    .modal-content {
      border-radius: 15px;
      border: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border-radius: 15px 15px 0 0;
      border: none;
    }

    .modal-header .btn-close {
      filter: invert(1);
    }

    .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .form-control {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #28a745;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .form-text {
      color: #6c757d;
      font-size: 0.875rem;
    }

    .modal-footer {
      border-top: 1px solid #e9ecef;
      padding: 1rem;
    }

    .modal-footer .btn {
      border-radius: 25px;
      padding: 8px 20px;
      font-weight: 600;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .card-header {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      border-radius: 15px 15px 0 0 !important;
      font-weight: 700;
    }

    .status-available {
      color: #28a745;
      font-weight: 600;
    }

    .status-rented {
      color: #dc3545;
      font-weight: 600;
    }

    .status-sold {
      color: #6c757d;
      font-weight: 600;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #FFD700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <img src="images/logo.png" alt="Golden House Logo" class="logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <div style="display:none; font-size: 2em;">üè†</div>
      <div class="header-buttons">
        <a href="/" class="back-btn">
          <i class="fas fa-arrow-right"></i>
          ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <h1 class="page-title">ÿπŸÇÿßÿ±ÿßÿ™Ÿä</h1>
    <p class="page-subtitle">ÿ•ÿØÿßÿ±ÿ© ÿπŸÇÿßÿ±ÿßÿ™Ÿä Ÿàÿ®ŸÜÿßŸäÿßÿ™Ÿä ŸàŸàÿ≠ÿØÿßÿ™Ÿä</p>

    <div class="tabs-container">
      <!-- Tabs -->
      <ul class="nav nav-tabs" id="myPropertiesTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
            <i class="fas fa-plus-circle"></i>
            ÿ•ÿ∂ÿßŸÅÿ©
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="view-tab" data-bs-toggle="tab" data-bs-target="#view" type="button" role="tab">
            <i class="fas fa-eye"></i>
            ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="payment-status-tab" data-bs-toggle="tab" data-bs-target="#payment-status" type="button" role="tab">
            <i class="fas fa-credit-card"></i>
            ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπÿßÿ™
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="myPropertiesTabContent">
        <!-- Add Tab -->
        <div class="tab-pane fade show active" id="add" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-plus-circle"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿ¨ÿØŸäÿØÿ©</h3>
          </div>
          
          <div class="row">
            <!-- Add Building Card -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="card add-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-building"></i>
                    ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿßŸäÿ©
                  </h5>
                </div>
                <div class="card-body">
                  <p class="card-text">ÿ£ÿ∂ŸÅ ÿ®ŸÜÿßŸäÿ© ÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß ŸàŸÖÿ≥ÿ™ŸÜÿØÿßÿ™Ÿáÿß</p>
                  <button class="btn btn-success w-100" onclick="openAddBuildingModal()">
                    <i class="fas fa-plus"></i>
                    ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿßŸäÿ©
                  </button>
                </div>
              </div>
            </div>
            

            
            <!-- Add Payment Card -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="card add-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-money-bill-wave"></i>
                    ÿ•ÿ∂ÿßŸÅÿ© ÿØŸÅÿπÿ©
                  </h5>
                </div>
                <div class="card-body">
                  <p class="card-text">ÿ£ÿ∂ŸÅ ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß ŸàŸÖÿ≥ÿ™ŸÜÿØÿßÿ™Ÿáÿß</p>
                  <button class="btn btn-success w-100" onclick="openAddPaymentModal()">
                    <i class="fas fa-plus"></i>
                    ÿ•ÿ∂ÿßŸÅÿ© ÿØŸÅÿπÿ©
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Add Invoice Card -->
            <div class="col-md-6 col-lg-3 mb-4">
              <div class="card add-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-file-invoice"></i>
                    ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ©
                  </h5>
                </div>
                <div class="card-body">
                  <p class="card-text">ÿ£ÿ∂ŸÅ ŸÅÿßÿ™Ÿàÿ±ÿ© ŸÉŸáÿ±ÿ®ÿßÿ° ÿ£Ÿà ÿµÿ±ŸÅ ÿµÿ≠Ÿä</p>
                  <button class="btn btn-success w-100" onclick="openAddInvoiceModal()">
                    <i class="fas fa-plus"></i>
                    ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ©
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- View Tab -->
        <div class="tab-pane fade" id="view" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-search"></i> ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h3>
          </div>
          
          <div class="row">
            <div class="col-12">
              <div class="card view-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-search"></i>
                    ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿ¥ÿßŸÖŸÑ ŸÑŸÑÿ®ŸäÿßŸÜÿßÿ™
                  </h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label for="viewBuildingSelect" class="form-label">
                        <i class="fas fa-building"></i> ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©
                      </label>
                      <select class="form-control" id="viewBuildingSelect" onchange="loadUnitsForView()">
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="viewUnitSelect" class="form-label">
                        <i class="fas fa-home"></i> ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©
                      </label>
                      <select class="form-control" id="viewUnitSelect" onchange="loadUnitDetails()" disabled>
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label for="viewDataType" class="form-label">
                        <i class="fas fa-filter"></i> ŸÜŸàÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                      </label>
                      <select class="form-control" id="viewDataType" onchange="loadDataByType()">
                        <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</option>
                        <option value="units">ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>
                        <option value="payments">ÿßŸÑÿØŸÅÿπÿßÿ™</option>
                        <option value="invoices">ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±</option>
                      </select>
                    </div>
                  </div>
                  
                  <!-- Results Container -->
                  <div id="viewResults" class="mt-4" style="display: none;">
                    <div class="card">
                      <div class="card-header bg-primary text-white">
                        <h6 class="mb-0" id="resultsTitle">
                          <i class="fas fa-list"></i> ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
                        </h6>
                      </div>
                      <div class="card-body">
                        <div id="resultsContent">
                          <!-- Results will be loaded here -->
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Quick Actions -->
                  <div class="row mt-4">
                    <div class="col-12">
                      <h6 class="text-muted mb-3">
                        <i class="fas fa-bolt"></i> ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©
                      </h6>
                      <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="loadAllBuildings()">
                          <i class="fas fa-building"></i> ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="loadAllUnits()">
                          <i class="fas fa-home"></i> ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿ≠ÿØÿßÿ™
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="loadAllPayments()">
                          <i class="fas fa-money-bill-wave"></i> ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸÅÿπÿßÿ™
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="loadAllInvoices()">
                          <i class="fas fa-file-invoice"></i> ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Status Tab -->
        <div class="tab-pane fade" id="payment-status" role="tabpanel">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-credit-card"></i> ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπÿßÿ™</h3>
          </div>
          
          <div class="row">
            <div class="col-12">
              <div class="card view-card">
                <div class="card-header">
                  <h5 class="card-title mb-0">
                    <i class="fas fa-credit-card"></i>
                    ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπÿßÿ™ Ÿàÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿ®ÿ∂
                  </h5>
                </div>
                <div class="card-body">
                  <!-- ŸÅŸÑÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿßÿ™ -->
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <label class="form-label">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ®ŸÜŸâ:</label>
                      <select id="buildingSelect" class="form-select">
                        <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ®ÿßŸÜŸä</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©:</label>
                      <select id="unitSelect" class="form-select">
                        <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>
                      </select>
                    </div>
                  </div>

                  <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿØŸÅÿπÿßÿ™ -->
                  <div id="paymentsList" class="row">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™ ŸáŸÜÿß -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Building Modal -->
  <div class="modal fade" id="addBuildingModal" tabindex="-1" aria-labelledby="addBuildingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addBuildingModalLabel">
            <i class="fas fa-building"></i>
            ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿßŸäÿ© ÿ¨ÿØŸäÿØÿ©
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBuildingForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="buildingName" class="form-label">ÿßÿ≥ŸÖ ÿßŸÑÿ®ŸÜÿßŸäÿ© *</label>
                <input type="text" class="form-control" id="buildingName" name="name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="buildingAddress" class="form-label">ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ®ŸÜÿßŸäÿ©</label>
                <input type="text" class="form-control" id="buildingAddress" name="address">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="totalUnits" class="form-label">ÿπÿØÿØ ÿßŸÑŸàÿ≠ÿØÿßÿ™</label>
                <input type="number" class="form-control" id="totalUnits" name="total_units" min="1">
              </div>
              <div class="col-md-6 mb-3">
                <label for="buildingDescription" class="form-label">ŸàÿµŸÅ ÿßŸÑÿ®ŸÜÿßŸäÿ©</label>
                <textarea class="form-control" id="buildingDescription" name="description" rows="3"></textarea>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="buildingDocuments" class="form-label">ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿ®ŸÜÿßŸäÿ©</label>
              <input type="file" class="form-control" id="buildingDocuments" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="form-text">ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ÿπÿØÿ© ŸÖŸÑŸÅÿßÿ™ (PDF, Word, ÿµŸàÿ±)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button type="button" class="btn btn-success" onclick="saveBuilding()">
            <i class="fas fa-save"></i>
            ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸÜÿßŸäÿ©
          </button>
        </div>
      </div>
    </div>
  </div>



  <!-- Add Payment Modal -->
  <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPaymentModalLabel">
            <i class="fas fa-money-bill-wave"></i>
            ÿ•ÿ∂ÿßŸÅÿ© ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ©
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addPaymentForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="paymentBuilding" class="form-label">ÿßŸÑÿ®ŸÜÿßŸäÿ© *</label>
                <select class="form-control" id="paymentBuilding" name="building_id" required onchange="loadUnitsForPayment()">
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentUnit" class="form-label">ÿßŸÑŸàÿ≠ÿØÿ© *</label>
                <select class="form-control" id="paymentUnit" name="unit_id" required disabled>
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="paymentAmount" class="form-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫ (ÿØÿ±ŸáŸÖ) *</label>
                <input type="number" class="form-control" id="paymentAmount" name="amount" min="0" step="0.01" required onchange="generatePaymentInstallments()">
              </div>
              <div class="col-md-4 mb-3">
                <label for="paymentDate" class="form-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ© *</label>
                <input type="date" class="form-control" id="paymentDate" name="payment_date" required>
              </div>
              <div class="col-md-4 mb-3">
                <label for="paymentInstallments" class="form-label">ÿπÿØÿØ ÿßŸÑÿØŸÅÿπÿßÿ™</label>
                <input type="number" class="form-control" id="paymentInstallments" name="installments" min="1" value="1" onchange="generatePaymentInstallments()">
              </div>
            </div>
            
            <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ© -->
            <div id="paymentInstallmentsContainer" class="mb-3" style="display: none;">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿ≥Ÿäÿ™ŸÖ ÿ™ŸÇÿ≥ŸäŸÖ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿπŸÑŸâ ÿπÿØÿØ ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØ. ŸäŸÖŸÉŸÜŸÉ ÿ™ÿπÿØŸäŸÑ ŸÇŸäŸÖÿ© ŸÉŸÑ ÿØŸÅÿπÿ© ÿ≠ÿ≥ÿ® ÿßŸÑÿ≠ÿßÿ¨ÿ©.
              </div>
              <h6 class="text-primary mb-3">
                <i class="fas fa-money-bill-wave"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑŸÖÿ™ÿπÿØÿØÿ©
              </h6>
              <div id="paymentInstallmentsList">
                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿØŸÅÿπÿßÿ™ ŸáŸÜÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="paymentType" class="form-label">ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπÿ©</label>
                <select class="form-control" id="paymentType" name="payment_type">
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÜŸàÿπ</option>
                  <option value="rent">ÿ•Ÿäÿ¨ÿßÿ±</option>
                  <option value="sale">ÿ®Ÿäÿπ</option>
                  <option value="deposit">ÿπÿ±ÿ®ŸàŸÜ</option>
                  <option value="maintenance">ÿµŸäÿßŸÜÿ©</option>
                  <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="paymentMethod" class="form-label">ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</label>
                <select class="form-control" id="paymentMethod" name="payment_method">
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ∑ÿ±ŸäŸÇÿ©</option>
                  <option value="cash">ŸÜŸÇÿØÿßŸã</option>
                  <option value="bank_transfer">ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä</option>
                  <option value="check">ÿ¥ŸäŸÉ</option>
                  <option value="card">ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ</option>
                  <option value="other">ÿ£ÿÆÿ±Ÿâ</option>
                </select>
              </div>
            </div>
            

            

            
            <div class="mb-3">
              <label for="paymentDescription" class="form-label">ŸàÿµŸÅ ÿßŸÑÿØŸÅÿπÿ©</label>
              <textarea class="form-control" id="paymentDescription" name="description" rows="3"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="paymentDocuments" class="form-label">ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑÿØŸÅÿπÿ©</label>
              <input type="file" class="form-control" id="paymentDocuments" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="form-text">ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ÿπÿØÿ© ŸÖŸÑŸÅÿßÿ™ (PDF, Word, ÿµŸàÿ±)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button type="button" class="btn btn-success" onclick="savePayment()">
            <i class="fas fa-save"></i>
            ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸÅÿπÿ©
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Invoice Modal -->
  <div class="modal fade" id="addInvoiceModal" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addInvoiceModalLabel">
            <i class="fas fa-file-invoice"></i>
            ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿßÿ™Ÿàÿ±ÿ© ÿ¨ÿØŸäÿØÿ©
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addInvoiceForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceBuilding" class="form-label">ÿßŸÑÿ®ŸÜÿßŸäÿ© *</label>
                <select class="form-control" id="invoiceBuilding" name="building_id" required onchange="loadUnitsForInvoice()">
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceUnit" class="form-label">ÿßŸÑŸàÿ≠ÿØÿ© *</label>
                <select class="form-control" id="invoiceUnit" name="unit_id" required disabled onchange="updateInvoiceTenant()">
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã</option>
                </select>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceType" class="form-label">ŸÜŸàÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© *</label>
                <select class="form-control" id="invoiceType" name="invoice_type" required>
                  <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÜŸàÿπ</option>
                  <option value="electricity">ŸÉŸáÿ±ÿ®ÿßÿ°</option>
                  <option value="sewage">ÿµÿ±ŸÅ ÿµÿ≠Ÿä</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceAmount" class="form-label">ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (ÿØÿ±ŸáŸÖ) *</label>
                <input type="number" class="form-control" id="invoiceAmount" name="amount" min="0" step="0.01" required>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceDate" class="form-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© *</label>
                <input type="date" class="form-control" id="invoiceDate" name="invoice_date" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceTenant" class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</label>
                <input type="text" class="form-control" id="invoiceTenant" name="tenant_name" readonly>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceStatus" class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
                <select class="form-control" id="invoiceStatus" name="status">
                  <option value="unpaid">ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ</option>
                  <option value="paid">ŸÖÿØŸÅŸàÿπ</option>
                  <option value="overdue">ŸÖÿ™ÿ£ÿÆÿ±</option>
                  <option value="cancelled">ŸÖŸÑÿ∫Ÿä</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceDueDate" class="form-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</label>
                <input type="date" class="form-control" id="invoiceDueDate" name="due_date">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="invoiceNumber" class="form-label">ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
                <input type="text" class="form-control" id="invoiceNumber" name="invoice_number">
              </div>
              <div class="col-md-6 mb-3">
                <label for="invoiceProvider" class="form-label">ŸÖÿ≤ŸàÿØ ÿßŸÑÿÆÿØŸÖÿ©</label>
                <input type="text" class="form-control" id="invoiceProvider" name="provider">
              </div>
            </div>
            
            <div class="mb-3">
              <label for="invoiceDescription" class="form-label">ŸàÿµŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
              <textarea class="form-control" id="invoiceDescription" name="description" rows="3"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="invoiceDocuments" class="form-label">ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</label>
              <input type="file" class="form-control" id="invoiceDocuments" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="form-text">ŸäŸÖŸÉŸÜŸÉ ÿ±ŸÅÿπ ÿπÿØÿ© ŸÖŸÑŸÅÿßÿ™ (PDF, Word, ÿµŸàÿ±)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button type="button" class="btn btn-success" onclick="saveInvoice()">
            <i class="fas fa-save"></i>
            ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Check user authentication
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.id) {
        window.location.href = '/login';
        return;
      }
      
      // Store user ID globally
      window.currentUserId = user.id;
      
      // Load initial data for view system
      loadBuildingsForView();
    });

    // Modal functions for Add operations
    function openAddBuildingModal() {
      // Reset form
      document.getElementById('addBuildingForm').reset();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addBuildingModal'));
      modal.show();
    }

    // Save building function
    async function saveBuilding() {
      try {
        const form = document.getElementById('addBuildingForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const name = formData.get('name');
        if (!name.trim()) {
          alert('ÿßÿ≥ŸÖ ÿßŸÑÿ®ŸÜÿßŸäÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addBuildingModal .btn-success');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/buildings?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ®ŸÜÿßŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addBuildingModal'));
          modal.hide();
          form.reset();
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error saving building:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸÜÿßŸäÿ©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addBuildingModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸÜÿßŸäÿ©';
        saveBtn.disabled = false;
      }
    }

    async function openAddUnitModal() {
      // Reset form
      document.getElementById('addUnitForm').reset();
      
      // Load buildings for dropdown
      await loadBuildingsForUnits();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addUnitModal'));
      modal.show();
    }
    

    

    


    function openAddPaymentModal() {
      // Reset form
      document.getElementById('addPaymentForm').reset();
      
      // Load buildings for dropdown
      loadBuildingsForPayments();
      
      // Disable unit selection until building is selected
      document.getElementById('paymentUnit').disabled = true;
      document.getElementById('paymentUnit').innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã</option>';
      
      // Set default date to today
      document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
      
      // Hide installments container initially
      document.getElementById('paymentInstallmentsContainer').style.display = 'none';
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
      modal.show();
    }
    
    // ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ© ŸÅŸä ŸÜŸÖŸàÿ∞ÿ¨ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸÅÿπÿ©
    function generatePaymentInstallments() {
      const installmentsCount = parseInt(document.getElementById('paymentInstallments').value) || 1;
      const paymentAmount = parseFloat(document.getElementById('paymentAmount').value) || 0;
      const paymentDate = document.getElementById('paymentDate').value;
      const paymentType = document.getElementById('paymentType').value;
      const paymentMethod = document.getElementById('paymentMethod').value;
      
      const installmentsContainer = document.getElementById('paymentInstallmentsContainer');
      const installmentsList = document.getElementById('paymentInstallmentsList');
      
      // ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿØŸÅÿπÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿπÿØÿØ
      if (installmentsCount > 1) {
        installmentsContainer.style.display = 'block';
        // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿπŸÜÿØ Ÿàÿ¨ŸàÿØ ÿØŸÅÿπÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©
        document.getElementById('paymentAmount').readOnly = true;
        document.getElementById('paymentAmount').style.backgroundColor = '#f8f9fa';
      } else {
        installmentsContainer.style.display = 'none';
        // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
        document.getElementById('paymentAmount').readOnly = false;
        document.getElementById('paymentAmount').style.backgroundColor = '';
        return;
      }
      
      // ÿ≠ÿ≥ÿßÿ® ŸÇŸäŸÖÿ© ŸÉŸÑ ÿØŸÅÿπÿ©
      const installmentAmount = paymentAmount / installmentsCount;
      
      let installmentsHtml = '';
      
      for (let i = 1; i <= installmentsCount; i++) {
        // ÿ≠ÿ≥ÿßÿ® ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿ© (ÿ¥Ÿáÿ± Ÿàÿßÿ≠ÿØ ÿ®ŸäŸÜ ŸÉŸÑ ÿØŸÅÿπÿ©)
        const dueDate = new Date();
        if (paymentDate) {
          dueDate.setTime(new Date(paymentDate).getTime());
        }
        dueDate.setMonth(dueDate.getMonth() + i);
        const formattedDueDate = dueDate.toISOString().split('T')[0];
        
        installmentsHtml += `
          <div class="card mb-3 payment-installment-card">
            <div class="card-header bg-info text-white">
              <h6 class="mb-0">
                <i class="fas fa-money-bill"></i> ÿßŸÑÿØŸÅÿπÿ© ÿ±ŸÇŸÖ ${i} ŸÖŸÜ ${installmentsCount}
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <label class="form-label">ŸÇŸäŸÖÿ© ÿßŸÑÿØŸÅÿπÿ© (ÿØÿ±ŸáŸÖ)</label>
                  <input type="number" class="form-control payment-installment-amount" 
                         name="payment_installment_amount_${i}" 
                         value="${installmentAmount.toFixed(2)}" 
                         min="0" step="0.01" required>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</label>
                  <input type="date" class="form-control payment-installment-due-date" 
                         name="payment_installment_due_date_${i}" 
                         value="${formattedDueDate}" required>
                </div>
                <div class="col-md-4 mb-2">
                  <label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπÿ©</label>
                  <select class="form-control payment-installment-status" name="payment_installment_status_${i}">
                    <option value="pending">ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±</option>
                    <option value="paid">ŸÖÿØŸÅŸàÿπ</option>
                    <option value="overdue">ŸÖÿ™ÿ£ÿÆÿ±</option>
                    <option value="cancelled">ŸÖŸÑÿ∫Ÿä</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-2">
                  <label class="form-label">ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπÿ©</label>
                  <select class="form-control payment-installment-type" name="payment_installment_type_${i}">
                    <option value="rent" ${paymentType === 'rent' ? 'selected' : ''}>ÿ•Ÿäÿ¨ÿßÿ±</option>
                    <option value="sale" ${paymentType === 'sale' ? 'selected' : ''}>ÿ®Ÿäÿπ</option>
                    <option value="deposit" ${paymentType === 'deposit' ? 'selected' : ''}>ÿπÿ±ÿ®ŸàŸÜ</option>
                    <option value="maintenance" ${paymentType === 'maintenance' ? 'selected' : ''}>ÿµŸäÿßŸÜÿ©</option>
                    <option value="other" ${paymentType === 'other' ? 'selected' : ''}>ÿ£ÿÆÿ±Ÿâ</option>
                  </select>
                </div>
                <div class="col-md-6 mb-2">
                  <label class="form-label">ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</label>
                  <select class="form-control payment-installment-method" name="payment_installment_method_${i}">
                    <option value="cash" ${paymentMethod === 'cash' ? 'selected' : ''}>ŸÜŸÇÿØÿßŸã</option>
                    <option value="bank_transfer" ${paymentMethod === 'bank_transfer' ? 'selected' : ''}>ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä</option>
                    <option value="check" ${paymentMethod === 'check' ? 'selected' : ''}>ÿ¥ŸäŸÉ</option>
                    <option value="card" ${paymentMethod === 'card' ? 'selected' : ''}>ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ</option>
                    <option value="other" ${paymentMethod === 'other' ? 'selected' : ''}>ÿ£ÿÆÿ±Ÿâ</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-12 mb-2">
                  <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿØŸÅÿπÿ©</label>
                  <input type="text" class="form-control payment-installment-notes" 
                         name="payment_installment_notes_${i}" 
                         placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿØŸÅÿπÿ©">
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      installmentsList.innerHTML = installmentsHtml;
      
      // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑŸÑÿØŸÅÿπÿßÿ™
      addPaymentInstallmentEventListeners();
    }
    
    // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸÅÿπ
    function addPaymentInstallmentEventListeners() {
      const installmentCards = document.querySelectorAll('.payment-installment-card');
      
      installmentCards.forEach((card, index) => {
        const amountInput = card.querySelector('.payment-installment-amount');
        const dueDateInput = card.querySelector('.payment-installment-due-date');
        
        if (amountInput) {
          amountInput.addEventListener('change', function() {
            updatePaymentTotalAmount();
          });
        }
        
        if (dueDateInput) {
          dueDateInput.addEventListener('change', function() {
            validatePaymentDueDates();
          });
        }
      });
    }
    
    // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ¨ŸÖÿßŸÑŸä ŸÖÿ®ŸÑÿ∫ ÿßŸÑÿØŸÅÿπÿßÿ™
    function updatePaymentTotalAmount() {
      const amountInputs = document.querySelectorAll('.payment-installment-amount');
      let total = 0;
      
      amountInputs.forEach(input => {
        total += parseFloat(input.value) || 0;
      });
      
      console.log('ÿ•ÿ¨ŸÖÿßŸÑŸä ÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸÅÿπ:', total);
    }
    
    // ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿßÿ™
    function validatePaymentDueDates() {
      const dueDateInputs = document.querySelectorAll('.payment-installment-due-date');
      const dates = [];
      
      dueDateInputs.forEach(input => {
        if (input.value) {
          dates.push(new Date(input.value));
        }
      });
      
      // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÖÿ±ÿ™ÿ®ÿ©
      for (let i = 1; i < dates.length; i++) {
        if (dates[i] <= dates[i-1]) {
          alert('Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ ŸÖÿ±ÿ™ÿ®ÿ© ÿ™ÿ±ÿ™Ÿäÿ®ÿßŸã ÿ™ÿµÿßÿπÿØŸäÿßŸã');
          return false;
        }
      }
      
      return true;
    }

    function openAddInvoiceModal() {
      // Reset form
      document.getElementById('addInvoiceForm').reset();
      
      // Load buildings for dropdown
      loadBuildingsForInvoices();
      
      // Disable unit selection until building is selected
      document.getElementById('invoiceUnit').disabled = true;
      document.getElementById('invoiceUnit').innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã</option>';
      
      // Set default date to today
      document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addInvoiceModal'));
      modal.show();
    }

    // Modal functions for View operations
    function openViewBuildingsModal() {
      alert('ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÜÿßŸÅÿ∞ÿ© ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™ ŸÇÿ±Ÿäÿ®ÿßŸã');
    }

    async function openViewUnitsModal() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/units?token=' + token);
        const units = await response.json();
        
        // ÿ•ŸÜÿ¥ÿßÿ° modal ÿØŸäŸÜÿßŸÖŸäŸÉŸä
        const modalHtml = `
          <div class="modal fade" id="viewUnitsModal" tabindex="-1" aria-labelledby="viewUnitsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewUnitsModalLabel">
                    <i class="fas fa-home"></i>
                    ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿßŸÑŸàÿ≠ÿØÿßÿ™
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>ÿ±ŸÇŸÖ ÿßŸÑŸàÿ≠ÿØÿ©</th>
                          <th>ŸÜŸàÿπ ÿßŸÑŸàÿ≠ÿØÿ©</th>
                          <th>ŸÇŸäŸÖÿ© ÿßŸÑÿ•Ÿäÿ¨ÿßÿ±</th>
                          <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</th>
                          <th>Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</th>
                          <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                          <th>ÿπÿØÿØ ÿßŸÑÿØŸÅÿπÿßÿ™</th>
                          <th>ÿ®ÿØÿßŸäÿ© ÿßŸÑÿπŸÇÿØ</th>
                          <th>ŸÜŸáÿßŸäÿ© ÿßŸÑÿπŸÇÿØ</th>
                          <th>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°</th>
                          <th>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿßÿ°</th>
                          <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                          <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${units.map(unit => `
                          <tr>
                            <td>${unit.unit_number || '-'}</td>
                            <td>${getUnitTypeName(unit.unit_type)}</td>
                            <td>${unit.rent_value ? formatPrice(unit.rent_value) : '-'}</td>
                            <td>${unit.tenant_name || '-'}</td>
                            <td>${unit.tenant_phone || '-'}</td>
                            <td>${unit.tenant_email || '-'}</td>
                            <td>${unit.installments || 1}</td>
                            <td>${unit.contract_start_date || '-'}</td>
                            <td>${unit.contract_end_date || '-'}</td>
                            <td>${unit.electricity_account || '-'}</td>
                            <td>${unit.water_account || '-'}</td>
                            <td>
                              <span class="badge ${unit.status === 'available' ? 'bg-success' : 'bg-warning'}">
                                ${unit.status === 'available' ? 'ŸÖÿ™ÿßÿ≠ÿ©' : 'ŸÖÿ§ÿ¨ÿ±ÿ©'}
                              </span>
                            </td>
                            <td>
                              <button class="btn btn-sm btn-warning" onclick="editUnit(${unit.id})">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="deleteUnit(${unit.id})">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // ÿ•ÿ≤ÿßŸÑÿ© modal ÿ≥ÿßÿ®ŸÇ ÿ•ÿ∞ÿß Ÿàÿ¨ÿØ
        const existingModal = document.getElementById('viewUnitsModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© modal ÿ¨ÿØŸäÿØ
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ÿπÿ±ÿ∂ modal
        const modal = new bootstrap.Modal(document.getElementById('viewUnitsModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading units:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™');
      }
    }
    
    function getUnitTypeName(type) {
      const types = {
        'studio': 'ÿßÿ≥ÿ™ÿØŸäŸà',
        '1-bedroom': 'ÿ∫ÿ±ŸÅÿ© ŸàÿµÿßŸÑÿ©',
        '2-bedroom': 'ÿ∫ÿ±ŸÅÿ™ŸäŸÜ ŸàÿµÿßŸÑÿ©',
        '3-bedroom': 'ÿ´ŸÑÿßÿ´ ÿ∫ÿ±ŸÅ ŸàÿµÿßŸÑÿ©',
        'commercial': 'ÿ™ÿ¨ÿßÿ±Ÿä',
        'villa': 'ŸÅŸäŸÑÿß'
      };
      return types[type] || type;
    }
    
    function formatPrice(price) {
      return new Intl.NumberFormat('ar-EG', {
        style: 'currency',
        currency: 'AED'
      }).format(price);
    }
    
    async function editUnit(unitId) {
      try {
        console.log('Starting editUnit for unitId:', unitId);
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ modal
        const modalElement = document.getElementById('addUnitModal');
        if (!modalElement) {
          console.error('Modal addUnitModal not found!');
          alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨');
          return;
        }
        
        console.log('Loading buildings...');
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™ ÿ£ŸàŸÑÿßŸã
        await loadBuildingsForUnits();
        console.log('Buildings loaded successfully');
        
        console.log('Fetching unit data...');
        const response = await fetch(`/api/units/${unitId}?token=${token}`);
        const unit = await response.json();
        console.log('Unit data:', unit);
        
        if (response.ok) {
          console.log('Filling form with unit data...');
          
          // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ±
          const elements = {
            unitName: document.getElementById('unitName'),
            unitBuilding: document.getElementById('unitBuilding'),
            unitType: document.getElementById('unitType'),
            unitRentValue: document.getElementById('unitRentValue'),
            unitTenantName: document.getElementById('unitTenantName'),
            unitTenantPhone: document.getElementById('unitTenantPhone'),
            unitTenantEmail: document.getElementById('unitTenantEmail'),
            unitContractStart: document.getElementById('unitContractStart'),
            unitContractEnd: document.getElementById('unitContractEnd'),
            unitElectricityAccount: document.getElementById('unitElectricityAccount'),
            unitWaterAccount: document.getElementById('unitWaterAccount'),
            unitDescription: document.getElementById('unitDescription')
          };
          
          // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÜÿßÿµÿ±
          for (const [key, element] of Object.entries(elements)) {
            if (!element) {
              console.error(`Element ${key} not found!`);
              alert(`ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨: ${key} ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ`);
              return;
            }
          }
          
          // ŸÖŸÑÿ° ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿπÿØŸäŸÑ
          elements.unitName.value = unit.unit_number || '';
          elements.unitBuilding.value = unit.building_id || '';
          elements.unitType.value = unit.unit_type || '';
          elements.unitRentValue.value = unit.rent_value || '';
          elements.unitTenantName.value = unit.tenant_name || '';
          elements.unitTenantPhone.value = unit.tenant_phone || '';
          elements.unitTenantEmail.value = unit.tenant_email || '';
          elements.unitContractStart.value = unit.contract_start_date || '';
          elements.unitContractEnd.value = unit.contract_end_date || '';
          elements.unitElectricityAccount.value = unit.electricity_account || '';
          elements.unitWaterAccount.value = unit.water_account || '';
          elements.unitDescription.value = unit.description || '';
          
          console.log('Form filled successfully');
          
          // ÿ™ÿ∫ŸäŸäÿ± ÿπŸÜŸàÿßŸÜ modal
          const modalLabel = document.getElementById('addUnitModalLabel');
          if (modalLabel) {
            modalLabel.innerHTML = '<i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿ©';
          }
          
          // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿ±ŸÅ ÿßŸÑŸàÿ≠ÿØÿ© ŸÑŸÑŸÜŸÖŸàÿ∞ÿ¨
          const form = document.getElementById('addUnitForm');
          if (form) {
            form.setAttribute('data-edit-id', unitId);
          }
          
          // ÿ™ÿ∫ŸäŸäÿ± ÿ≤ÿ± ÿßŸÑÿ≠ŸÅÿ∏
          const saveBtn = document.querySelector('#addUnitModal .btn-success');
          if (saveBtn) {
            saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™';
            saveBtn.onclick = updateUnit;
          }
          
          console.log('Showing modal...');
          // ÿπÿ±ÿ∂ modal
          const modal = new bootstrap.Modal(modalElement);
          modal.show();
          console.log('Modal shown successfully');
        } else {
          console.error('Error response:', response.status, response.statusText);
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàÿ≠ÿØÿ©');
        }
      } catch (error) {
        console.error('Error loading unit:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸàÿ≠ÿØÿ©');
      }
    }
    
    async function updateUnit() {
      try {
        const form = document.getElementById('addUnitForm');
        const unitId = form.getAttribute('data-edit-id');
        
        if (!unitId) {
          alert('ŸÖÿπÿ±ŸÅ ÿßŸÑŸàÿ≠ÿØÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
          return;
        }
        
        const formData = new FormData(form);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
        const unitNumber = formData.get('unit_number');
        const unitType = formData.get('unit_type');
        const buildingId = formData.get('building_id');
        const rentValue = formData.get('rent_value');
        const tenantName = formData.get('tenant_name');
        const tenantPhone = formData.get('tenant_phone');
        
        if (!unitNumber || !unitNumber.trim()) {
          alert('ÿ±ŸÇŸÖ ÿßŸÑŸàÿ≠ÿØÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        if (!unitType) {
          alert('ŸÜŸàÿπ ÿßŸÑŸàÿ≠ÿØÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        if (!buildingId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©');
          return;
        }
        
        if (!rentValue || rentValue <= 0) {
          alert('ŸÇŸäŸÖÿ© ÿßŸÑÿ•Ÿäÿ¨ÿßÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ©');
          return;
        }
        
        if (!tenantName || !tenantName.trim()) {
          alert('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ± ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        if (!tenantPhone || !tenantPhone.trim()) {
          alert('Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ± ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
        saveBtn.disabled = true;
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
        const response = await fetch(`/api/units/${unitId}?token=${token}`, {
          method: 'PUT',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿ≠ÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addUnitModal'));
          modal.hide();
          form.reset();
          
          // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
          // document.getElementById('addUnitModalLabel').innerHTML = '<i class="fas fa-home"></i> ÿ•ÿ∂ÿßŸÅÿ© Ÿàÿ≠ÿØÿ© ÿ¨ÿØŸäÿØÿ©';
          form.removeAttribute('data-edit-id');
          saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸàÿ≠ÿØÿ©';
          saveBtn.onclick = saveUnit;
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error updating unit:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸàÿ≠ÿØÿ©');
      } finally {
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≤ÿ±
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸàÿ≠ÿØÿ©';
        saveBtn.disabled = false;
      }
    }
    
    async function deleteUnit(unitId) {
      if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸàÿ≠ÿØÿ©ÿü')) {
        return;
      }
      
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units/${unitId}?token=${token}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸàÿ≠ÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™
          openViewUnitsModal();
        } else {
          const result = await response.json();
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error deleting unit:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸàÿ≠ÿØÿ©');
      }
    }

    async function openViewPaymentsModal() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/payments?token=' + token);
        const payments = await response.json();
        
        // ÿ•ŸÜÿ¥ÿßÿ° modal ÿØŸäŸÜÿßŸÖŸäŸÉŸä
        const modalHtml = `
          <div class="modal fade" id="viewPaymentsModal" tabindex="-1" aria-labelledby="viewPaymentsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewPaymentsModalLabel">
                    <i class="fas fa-money-bill-wave"></i>
                    ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿßŸÑÿØŸÅÿπÿßÿ™
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>ÿßŸÑÿ®ŸÜÿßŸäÿ©</th>
                          <th>ÿßŸÑŸàÿ≠ÿØÿ©</th>
                          <th>ŸÇŸäŸÖÿ© ÿßŸÑÿØŸÅÿπÿ©</th>
                          <th>ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπÿ©</th>
                          <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿ©</th>
                          <th>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</th>
                          <th>ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ</th>
                          <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                          <th>ÿßŸÑŸàÿµŸÅ</th>
                          <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${payments.map(payment => `
                          <tr>
                            <td>${payment.building_name || '-'}</td>
                            <td>${payment.unit_number || '-'}</td>
                            <td>${payment.amount ? formatPrice(payment.amount) : '-'}</td>
                            <td>${getPaymentTypeName(payment.payment_type)}</td>
                            <td>${payment.payment_date || '-'}</td>
                            <td>${getPaymentMethodName(payment.payment_method)}</td>
                            <td>
                              <span class="badge ${getPaymentStatusBadge(payment.status)}">
                                ${getPaymentStatusName(payment.status)}
                              </span>
                            </td>
                            <td>${payment.due_date || '-'}</td>
                            <td>${payment.description || '-'}</td>
                            <td>
                              <button class="btn btn-sm btn-warning" onclick="editPayment(${payment.id})">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="deletePayment(${payment.id})">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // ÿ•ÿ≤ÿßŸÑÿ© modal ÿ≥ÿßÿ®ŸÇ ÿ•ÿ∞ÿß Ÿàÿ¨ÿØ
        const existingModal = document.getElementById('viewPaymentsModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© modal ÿ¨ÿØŸäÿØ
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ÿπÿ±ÿ∂ modal
        const modal = new bootstrap.Modal(document.getElementById('viewPaymentsModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading payments:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™');
      }
    }
    
    function getPaymentTypeName(type) {
      const types = {
        'rent': 'ÿ•Ÿäÿ¨ÿßÿ±',
        'sale': 'ÿ®Ÿäÿπ',
        'deposit': 'ÿπÿ±ÿ®ŸàŸÜ',
        'maintenance': 'ÿµŸäÿßŸÜÿ©',
        'other': 'ÿ£ÿÆÿ±Ÿâ'
      };
      return types[type] || type;
    }
    
    function getPaymentMethodName(method) {
      const methods = {
        'cash': 'ŸÜŸÇÿØÿßŸã',
        'bank_transfer': 'ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä',
        'check': 'ÿ¥ŸäŸÉ',
        'card': 'ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ',
        'other': 'ÿ£ÿÆÿ±Ÿâ'
      };
      return methods[method] || method;
    }
    
    function getPaymentStatusName(status) {
      const statuses = {
        'paid': 'ŸÖÿØŸÅŸàÿπ',
        'pending': 'ŸÖÿπŸÑŸÇ',
        'overdue': 'ŸÖÿ™ÿ£ÿÆÿ±'
      };
      return statuses[status] || status;
    }
    
    function getPaymentStatusBadge(status) {
      const badges = {
        'paid': 'bg-success',
        'pending': 'bg-warning',
        'overdue': 'bg-danger'
      };
      return badges[status] || 'bg-secondary';
    }
    
    async function editPayment(paymentId) {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/payments/${paymentId}?token=${token}`);
        const payment = await response.json();
        
        if (response.ok) {
          // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™ ÿ£ŸàŸÑÿßŸã
          await loadBuildingsForPayments();
          
          // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™ ŸÑŸÑÿ®ŸÜÿßŸäÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©
          if (payment.building_id) {
            await loadUnitsForPayment();
          }
          
          // ŸÖŸÑÿ° ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          document.getElementById('paymentBuilding').value = payment.building_id || '';
          document.getElementById('paymentUnit').value = payment.unit_id || '';
          document.getElementById('paymentAmount').value = payment.amount || '';
          document.getElementById('paymentDate').value = payment.payment_date || '';
          document.getElementById('paymentType').value = payment.payment_type || '';
          document.getElementById('paymentMethod').value = payment.payment_method || '';
          document.getElementById('paymentDescription').value = payment.description || '';
          
          // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿ≠ŸÇŸÑ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®ŸÑÿ∫
          document.getElementById('paymentAmount').readOnly = false;
          document.getElementById('paymentAmount').style.backgroundColor = '';
          
          // ÿ•ÿÆŸÅÿßÿ° ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
          document.getElementById('paymentInstallmentsContainer').style.display = 'none';
          
          // ÿ™ÿ∫ŸäŸäÿ± ÿπŸÜŸàÿßŸÜ modal
          document.getElementById('addPaymentModalLabel').innerHTML = '<i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿØŸÅÿπÿ©';
          
          // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸÅÿπÿ© ŸÑŸÑŸÜŸÖŸàÿ∞ÿ¨
          const form = document.getElementById('addPaymentForm');
          form.setAttribute('data-edit-id', paymentId);
          
          // ÿ™ÿ∫ŸäŸäÿ± ÿ≤ÿ± ÿßŸÑÿ≠ŸÅÿ∏
          const saveBtn = document.querySelector('#addPaymentModal .btn-success');
          saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™';
          saveBtn.onclick = updatePayment;
          
          // ÿπÿ±ÿ∂ modal
          const modal = new bootstrap.Modal(document.getElementById('addPaymentModal'));
          modal.show();
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸÅÿπÿ©');
        }
      } catch (error) {
        console.error('Error loading payment:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸÅÿπÿ©');
      }
    }
    
    async function updatePayment() {
      try {
        const form = document.getElementById('addPaymentForm');
        const paymentId = form.getAttribute('data-edit-id');
        
        if (!paymentId) {
          alert('ŸÖÿπÿ±ŸÅ ÿßŸÑÿØŸÅÿπÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
          return;
        }
        
        const formData = new FormData(form);
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
        const buildingId = formData.get('building_id');
        const unitId = formData.get('unit_id');
        const amount = formData.get('amount');
        const paymentDate = formData.get('payment_date');
        
        if (!buildingId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©');
          return;
        }
        if (!unitId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©');
          return;
        }
        if (!amount || amount <= 0) {
          alert('ŸÇŸäŸÖÿ© ÿßŸÑÿØŸÅÿπÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©');
          return;
        }
        if (!paymentDate) {
          alert('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
        saveBtn.disabled = true;
        
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®
        const response = await fetch(`/api/payments/${paymentId}?token=${token}`, {
          method: 'PUT',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸÅÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
          modal.hide();
          form.reset();
          
          // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
          document.getElementById('addPaymentModalLabel').innerHTML = '<i class="fas fa-money-bill-wave"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ©';
          form.removeAttribute('data-edit-id');
          saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸÅÿπÿ©';
          saveBtn.onclick = savePayment;
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error updating payment:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸÅÿπÿ©');
      } finally {
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≤ÿ±
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸÅÿπÿ©';
        saveBtn.disabled = false;
      }
    }
    
    async function deletePayment(paymentId) {
      if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿØŸÅÿπÿ©ÿü')) {
        return;
      }
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch(`/api/payments/${paymentId}?token=${token}`, {
          method: 'DELETE'
        });
        let result = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            result = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿØŸÅÿπÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          alert('ÿ™ÿπÿ∞ÿ± ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸÅÿπÿ©: ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑÿØŸÅÿπÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ.');
          return;
        }
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸÅÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          openViewPaymentsModal();
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result && result.error ? result.error : 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error deleting payment:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿØŸÅÿπÿ©');
      }
    }

    async function openViewInvoicesModal() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/invoices?token=' + token);
        const invoices = await response.json();
        
        // ÿ•ŸÜÿ¥ÿßÿ° modal ÿØŸäŸÜÿßŸÖŸäŸÉŸä
        const modalHtml = `
          <div class="modal fade" id="viewInvoicesModal" tabindex="-1" aria-labelledby="viewInvoicesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="viewInvoicesModalLabel">
                    <i class="fas fa-file-invoice"></i>
                    ÿßÿ≥ÿ™ÿπÿ±ÿßÿ∂ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>ÿßŸÑÿ®ŸÜÿßŸäÿ©</th>
                          <th>ÿßŸÑŸàÿ≠ÿØÿ©</th>
                          <th>ŸÜŸàÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                          <th>ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                          <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                          <th>ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</th>
                          <th>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                          <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                          <th>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                          <th>ŸÖÿ≤ŸàÿØ ÿßŸÑÿÆÿØŸÖÿ©</th>
                          <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${invoices.map(invoice => `
                          <tr>
                            <td>${invoice.building_name || '-'}</td>
                            <td>${invoice.unit_number || '-'}</td>
                            <td>${getInvoiceTypeName(invoice.invoice_type)}</td>
                            <td>${invoice.amount ? formatPrice(invoice.amount) : '-'}</td>
                            <td>${invoice.invoice_date || '-'}</td>
                            <td>${invoice.tenant_name || '-'}</td>
                            <td>
                              <span class="badge ${getInvoiceStatusBadge(invoice.status)}">
                                ${getInvoiceStatusName(invoice.status)}
                              </span>
                            </td>
                            <td>${invoice.due_date || '-'}</td>
                            <td>${invoice.invoice_number || '-'}</td>
                            <td>${invoice.provider || '-'}</td>
                            <td>
                              <button class="btn btn-sm btn-warning" onclick="editInvoice(${invoice.id})">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // ÿ•ÿ≤ÿßŸÑÿ© modal ÿ≥ÿßÿ®ŸÇ ÿ•ÿ∞ÿß Ÿàÿ¨ÿØ
        const existingModal = document.getElementById('viewInvoicesModal');
        if (existingModal) {
          existingModal.remove();
        }
        
        // ÿ•ÿ∂ÿßŸÅÿ© modal ÿ¨ÿØŸäÿØ
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // ÿπÿ±ÿ∂ modal
        const modal = new bootstrap.Modal(document.getElementById('viewInvoicesModal'));
        modal.show();
        
      } catch (error) {
        console.error('Error loading invoices:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±');
      }
    }
    
    function getInvoiceTypeName(type) {
      const types = {
        'electricity': 'ŸÉŸáÿ±ÿ®ÿßÿ°',
        'sewage': 'ÿµÿ±ŸÅ ÿµÿ≠Ÿä',
        'water': 'ŸÖŸäÿßŸá',
        'gas': 'ÿ∫ÿßÿ≤',
        'internet': 'ÿ•ŸÜÿ™ÿ±ŸÜÿ™',
        'other': 'ÿ£ÿÆÿ±Ÿâ'
      };
      return types[type] || type;
    }
    
    function getInvoiceStatusName(status) {
      const statuses = {
        'unpaid': 'ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ',
        'paid': 'ŸÖÿØŸÅŸàÿπ',
        'overdue': 'ŸÖÿ™ÿ£ÿÆÿ±',
        'cancelled': 'ŸÖŸÑÿ∫Ÿä'
      };
      return statuses[status] || status;
    }
    
    function getInvoiceStatusBadge(status) {
      const badges = {
        'unpaid': 'bg-warning',
        'paid': 'bg-success',
        'overdue': 'bg-danger',
        'cancelled': 'bg-secondary'
      };
      return badges[status] || 'bg-secondary';
    }
    
    function getInstallmentStatusName(status) {
      const statuses = {
        'pending': 'ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
        'paid': 'ŸÖÿØŸÅŸàÿπ',
        'overdue': 'ŸÖÿ™ÿ£ÿÆÿ±',
        'cancelled': 'ŸÖŸÑÿ∫Ÿä'
      };
      return statuses[status] || status;
    }
    
    function getInstallmentStatusBadge(status) {
      const badges = {
        'pending': 'bg-warning',
        'paid': 'bg-success',
        'overdue': 'bg-danger',
        'cancelled': 'bg-secondary'
      };
      return badges[status] || 'bg-secondary';
    }
    
    // New View System Functions
    async function loadBuildingsForView() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        console.log('Loading buildings for view...'); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        console.log('Buildings loaded:', buildings); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        
        const select = document.getElementById('viewBuildingSelect');
        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß</option>';
        
        if (buildings && buildings.length > 0) {
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
          
          console.log(`Loaded ${buildings.length} buildings`);
        } else {
          select.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸÜÿßŸäÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</option>';
          console.log('No buildings found');
        }
      } catch (error) {
        console.error('Error loading buildings for view:', error);
        const select = document.getElementById('viewBuildingSelect');
        select.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™</option>';
      }
    }
    
    async function loadUnitsForView() {
      try {
        const buildingId = document.getElementById('viewBuildingSelect').value;
        const unitSelect = document.getElementById('viewUnitSelect');
        
        if (!buildingId) {
          unitSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß</option>';
          unitSelect.disabled = true;
          hideResults();
          return;
        }
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
        unitSelect.innerHTML = '<option value="">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™...</option>';
        unitSelect.disabled = true;
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        console.log('Loading units for building ID:', buildingId); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ID ÿßŸÑÿ®ŸÜÿßŸäÿ©
        
        const response = await fetch(`/api/units?token=${token}&building_id=${buildingId}`);
        let units = null;
        
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            units = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          console.error('Error parsing units:', jsonErr);
          unitSelect.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
          unitSelect.disabled = true;
          hideResults();
          return;
        }
        
        console.log('Units loaded:', units); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        
        unitSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ŸÑÿπÿ±ÿ∂ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß</option>';
        unitSelect.disabled = false;
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} - ${getUnitTypeName(unit.unit_type)} - ${unit.tenant_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
            unitSelect.appendChild(option);
          });
          
          console.log(`Loaded ${units.length} units for building ${buildingId}`);
        } else {
          unitSelect.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≠ÿØÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>';
          console.log('No units found for building:', buildingId);
        }
        
        hideResults();
      } catch (error) {
        console.error('Error loading units for view:', error);
        const unitSelect = document.getElementById('viewUnitSelect');
        unitSelect.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
        unitSelect.disabled = true;
        hideResults();
      }
    }
    
    async function loadUnitDetails() {
      try {
        const unitId = document.getElementById('viewUnitSelect').value;
        if (!unitId) {
          hideResults();
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        console.log('Loading unit details for ID:', unitId); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ID ÿßŸÑŸàÿ≠ÿØÿ©
        
        // ÿ•ÿ∏Ÿáÿßÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ
        const resultsContainer = document.getElementById('viewResults');
        const resultsTitle = document.getElementById('resultsTitle');
        const resultsContent = document.getElementById('resultsContent');
        
        resultsTitle.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿ©...';
        resultsContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</p></div>';
        resultsContainer.style.display = 'block';
        
        const response = await fetch(`/api/units/${unitId}?token=${token}`);
        let unit = null;
        
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            unit = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑŸàÿ≠ÿØÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          console.error('Error parsing unit details:', jsonErr);
          alert('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿ©: ŸÇÿØ ÿ™ŸÉŸàŸÜ ÿßŸÑŸàÿ≠ÿØÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ© ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ.');
          hideResults();
          return;
        }
        
        if (response.ok && unit) {
          console.log('Unit details loaded successfully:', unit); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          showUnitDetails(unit);
          
          // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
          await loadRelatedData(unitId);
        } else {
          console.error('Failed to load unit details. Response status:', response.status);
          hideResults();
        }
      } catch (error) {
        console.error('Error loading unit details:', error);
        hideResults();
      }
    }
    
    async function loadRelatedData(unitId) {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑŸàÿ≠ÿØÿ©
        const paymentsResponse = await fetch(`/api/payments?token=${token}&unit_id=${unitId}`);
        let payments = [];
        try {
          const contentType = paymentsResponse.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            payments = await paymentsResponse.json();
          }
        } catch (e) {
          console.error('Error loading payments:', e);
        }
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑŸàÿ≠ÿØÿ©
        const invoicesResponse = await fetch(`/api/invoices?token=${token}&unit_id=${unitId}`);
        let invoices = [];
        try {
          const contentType = invoicesResponse.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            invoices = await invoicesResponse.json();
          }
        } catch (e) {
          console.error('Error loading invoices:', e);
        }
        
        // ÿπÿ±ÿ∂ ŸÖŸÑÿÆÿµ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
        showRelatedDataSummary(payments, invoices);
        
      } catch (error) {
        console.error('Error loading related data:', error);
      }
    }
    
    function showRelatedDataSummary(payments, invoices) {
      const resultsContent = document.getElementById('resultsContent');
      const currentContent = resultsContent.innerHTML;
      
      console.log('Showing related data summary - Payments:', payments.length, 'Invoices:', invoices.length);
      
      const summaryHtml = `
        <div class="row mt-3">
          <div class="col-12">
            <h6 class="text-primary">
              <i class="fas fa-chart-bar"></i> ŸÖŸÑÿÆÿµ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ©
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-primary">
                      <i class="fas fa-money-bill-wave"></i> ÿßŸÑÿØŸÅÿπÿßÿ™
                    </h5>
                    <h3 class="text-success">${payments.length}</h3>
                    <p class="card-text">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑŸàÿ≠ÿØÿ©</p>
                    <button class="btn btn-info btn-sm" onclick="loadDataByType('payments')">
                      <i class="fas fa-eye"></i> ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-primary">
                      <i class="fas fa-file-invoice"></i> ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±
                    </h5>
                    <h3 class="text-warning">${invoices.length}</h3>
                    <p class="card-text">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑŸàÿ≠ÿØÿ©</p>
                    <button class="btn btn-info btn-sm" onclick="loadDataByType('invoices')">
                      <i class="fas fa-eye"></i> ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-success">
                  <i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      resultsContent.innerHTML = currentContent + summaryHtml;
    }
    
    function showUnitDetails(unit) {
      const resultsContainer = document.getElementById('viewResults');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsContent = document.getElementById('resultsContent');
      
      console.log('Showing unit details:', unit); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      
      resultsTitle.innerHTML = '<i class="fas fa-home"></i> ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿ©';
      
      const detailsHtml = `
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠
        </div>
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-building"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸàÿ≠ÿØÿ©
            </h6>
            <table class="table table-borderless table-striped">
              <tr><td><strong>ÿ±ŸÇŸÖ ÿßŸÑŸàÿ≠ÿØÿ©:</strong></td><td>${unit.unit_number || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ŸÜŸàÿπ ÿßŸÑŸàÿ≠ÿØÿ©:</strong></td><td>${getUnitTypeName(unit.unit_type)}</td></tr>
              <tr><td><strong>ŸÇŸäŸÖÿ© ÿßŸÑÿ•Ÿäÿ¨ÿßÿ±:</strong></td><td>${unit.rent_value ? formatPrice(unit.rent_value) : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ÿßŸÑÿ®ŸÜÿßŸäÿ©:</strong></td><td>${unit.building_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong></td><td><span class="badge ${unit.status === 'available' ? 'bg-success' : 'bg-warning'}">${unit.status === 'available' ? 'ŸÖÿ™ÿßÿ≠ÿ©' : 'ŸÖÿ§ÿ¨ÿ±ÿ©'}</span></td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-user"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±
            </h6>
            <table class="table table-borderless table-striped">
              <tr><td><strong>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±:</strong></td><td>${unit.tenant_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±:</strong></td><td>${unit.tenant_phone || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</strong></td><td>${unit.tenant_email || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ÿπÿØÿØ ÿßŸÑÿØŸÅÿπÿßÿ™:</strong></td><td>${unit.installments || 1}</td></tr>
              <tr><td><strong>ÿ®ÿØÿßŸäÿ© ÿßŸÑÿπŸÇÿØ:</strong></td><td>${unit.contract_start_date || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ŸÜŸáÿßŸäÿ© ÿßŸÑÿπŸÇÿØ:</strong></td><td>${unit.contract_end_date || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
            </table>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-tools"></i> ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿßÿ™
            </h6>
            <table class="table table-borderless table-striped">
              <tr><td><strong>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°:</strong></td><td>${unit.electricity_account || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
              <tr><td><strong>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿßÿ°:</strong></td><td>${unit.water_account || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary">
              <i class="fas fa-cogs"></i> ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™
            </h6>
            <div class="d-flex gap-2">
              <button class="btn btn-warning btn-sm" onclick="editUnit(${unit.id})">
                <i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿ©
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteUnit(${unit.id})">
                <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ ÿßŸÑŸàÿ≠ÿØÿ©
              </button>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <div class="alert alert-success">
              <i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠
              <br>
              <small>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±: ${unit.tenant_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} | Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±: ${unit.tenant_phone || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</small>
            </div>
          </div>
        </div>
      `;
      
      resultsContent.innerHTML = detailsHtml;
      resultsContainer.style.display = 'block';
    }
    
    async function loadDataByType(dataType = null) {
      try {
        const selectedDataType = dataType || document.getElementById('viewDataType').value;
        const buildingId = document.getElementById('viewBuildingSelect').value;
        const unitId = document.getElementById('viewUnitSelect').value;
        
        if (!selectedDataType) {
          hideResults();
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        let url = '';
        let title = '';
        
        switch (selectedDataType) {
          case 'units':
            url = buildingId ? `/api/units?token=${token}&building_id=${buildingId}` : `/api/units?token=${token}`;
            title = 'ÿßŸÑŸàÿ≠ÿØÿßÿ™';
            break;
          case 'payments':
            url = unitId ? `/api/payments?token=${token}&unit_id=${unitId}` : `/api/payments?token=${token}`;
            title = 'ÿßŸÑÿØŸÅÿπÿßÿ™';
            break;
          case 'invoices':
            url = unitId ? `/api/invoices?token=${token}&unit_id=${unitId}` : `/api/invoices?token=${token}`;
            title = 'ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±';
            break;
        }
        
        console.log('Loading data from URL:', url); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ URL
        
        const response = await fetch(url);
        let data = null;
        
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            data = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          console.error('JSON parsing error:', jsonErr);
          showDataResults([], selectedDataType, title); // ÿπÿ±ÿ∂ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™
          return;
        }
        
        console.log('Data loaded:', data); // ŸÑŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        showDataResults(data, selectedDataType, title);
        
      } catch (error) {
        console.error('Error loading data by type:', error);
        showDataResults([], dataType || document.getElementById('viewDataType').value, '');
      }
    }
    
    function showDataResults(data, dataType, title) {
      const resultsContainer = document.getElementById('viewResults');
      const resultsTitle = document.getElementById('resultsTitle');
      const resultsContent = document.getElementById('resultsContent');
      
      console.log('Showing data results:', { dataType, title, dataLength: data ? data.length : 0 });
      
      resultsTitle.innerHTML = `<i class="fas fa-list"></i> ${title}`;
      
      if (!data || data.length === 0) {
        resultsContent.innerHTML = `
          <div class="text-center text-muted">
            <i class="fas fa-info-circle"></i> ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™
            <br>
            <small>ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${title} ŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ÿ®ÿßŸÑŸàÿ≠ÿØÿ© ÿßŸÑŸÖÿ≠ÿØÿØÿ©</small>
          </div>
        `;
        resultsContainer.style.display = 'block';
        return;
      }
      
      let tableHtml = '';
      
      switch (dataType) {
        case 'units':
          tableHtml = createUnitsTable(data);
          break;
        case 'payments':
          tableHtml = createPaymentsTable(data);
          break;
        case 'invoices':
          tableHtml = createInvoicesTable(data);
          break;
      }
      
      resultsContent.innerHTML = `
        <div class="alert alert-success">
          <i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${data.length} ${title}
        </div>
        ${tableHtml}
      `;
      resultsContainer.style.display = 'block';
    }
    
    function createUnitsTable(units) {
      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ÿ±ŸÇŸÖ ÿßŸÑŸàÿ≠ÿØÿ©</th>
                <th>ŸÜŸàÿπ ÿßŸÑŸàÿ≠ÿØÿ©</th>
                <th>ŸÇŸäŸÖÿ© ÿßŸÑÿ•Ÿäÿ¨ÿßÿ±</th>
                <th>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</th>
                <th>Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</th>
                <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                <th>ÿπÿØÿØ ÿßŸÑÿØŸÅÿπÿßÿ™</th>
                <th>ÿ®ÿØÿßŸäÿ© ÿßŸÑÿπŸÇÿØ</th>
                <th>ŸÜŸáÿßŸäÿ© ÿßŸÑÿπŸÇÿØ</th>
                <th>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÉŸáÿ±ÿ®ÿßÿ°</th>
                <th>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿßÿ°</th>
                <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
              </tr>
            </thead>
            <tbody>
              ${units.map(unit => `
                <tr>
                  <td><strong>${unit.unit_number || '-'}</strong></td>
                  <td>${getUnitTypeName(unit.unit_type)}</td>
                  <td><span class="text-success fw-bold">${unit.rent_value ? formatPrice(unit.rent_value) : '-'}</span></td>
                  <td><span class="text-primary">${unit.tenant_name || '-'}</span></td>
                  <td><span class="text-info">${unit.tenant_phone || '-'}</span></td>
                  <td>${unit.tenant_email || '-'}</td>
                  <td><span class="badge bg-secondary">${unit.installments || 1}</span></td>
                  <td>${unit.contract_start_date || '-'}</td>
                  <td>${unit.contract_end_date || '-'}</td>
                  <td><span class="text-warning">${unit.electricity_account || '-'}</span></td>
                  <td><span class="text-info">${unit.water_account || '-'}</span></td>
                  <td>
                    <span class="badge ${unit.status === 'available' ? 'bg-success' : 'bg-warning'}">
                      ${unit.status === 'available' ? 'ŸÖÿ™ÿßÿ≠ÿ©' : 'ŸÖÿ§ÿ¨ÿ±ÿ©'}
                    </span>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editUnit(${unit.id})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUnit(${unit.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div class="mt-3">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> ÿ™ŸÖ ÿπÿ±ÿ∂ ${units.length} Ÿàÿ≠ÿØÿ© ŸÖÿπ ÿ¨ŸÖŸäÿπ ÿ™ŸÅÿßÿµŸäŸÑŸáÿß
          </div>
        </div>
      `;
    }
    
    function createPaymentsTable(payments) {
      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ÿßŸÑÿ®ŸÜÿßŸäÿ©</th>
                <th>ÿßŸÑŸàÿ≠ÿØÿ©</th>
                <th>ŸÇŸäŸÖÿ© ÿßŸÑÿØŸÅÿπÿ©</th>
                <th>ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπÿ©</th>
                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿ©</th>
                <th>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</th>
                <th>ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ</th>
                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                <th>ÿßŸÑŸàÿµŸÅ</th>
                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
              </tr>
            </thead>
            <tbody>
              ${payments.map(payment => `
                <tr>
                  <td>${payment.building_name || '-'}</td>
                  <td>${payment.unit_number || '-'}</td>
                  <td>${payment.amount ? formatPrice(payment.amount) : '-'}</td>
                  <td>${getPaymentTypeName(payment.payment_type)}</td>
                  <td>${payment.payment_date || '-'}</td>
                  <td>${getPaymentMethodName(payment.payment_method)}</td>
                  <td>
                    <span class="badge ${getPaymentStatusBadge(payment.status)}">
                      ${getPaymentStatusName(payment.status)}
                    </span>
                  </td>
                  <td>${payment.due_date || '-'}</td>
                  <td>${payment.description || '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editPayment(${payment.id})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deletePayment(${payment.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    function createInvoicesTable(invoices) {
      return `
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ÿßŸÑÿ®ŸÜÿßŸäÿ©</th>
                <th>ÿßŸÑŸàÿ≠ÿØÿ©</th>
                <th>ŸÜŸàÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                <th>ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                <th>ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±</th>
                <th>ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                <th>ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©</th>
                <th>ŸÖÿ≤ŸàÿØ ÿßŸÑÿÆÿØŸÖÿ©</th>
                <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
              </tr>
            </thead>
            <tbody>
              ${invoices.map(invoice => `
                <tr>
                  <td>${invoice.building_name || '-'}</td>
                  <td>${invoice.unit_number || '-'}</td>
                  <td>${getInvoiceTypeName(invoice.invoice_type)}</td>
                  <td>${invoice.amount ? formatPrice(invoice.amount) : '-'}</td>
                  <td>${invoice.invoice_date || '-'}</td>
                  <td>${invoice.tenant_name || '-'}</td>
                  <td>
                    <span class="badge ${getInvoiceStatusBadge(invoice.status)}">
                      ${getInvoiceStatusName(invoice.status)}
                    </span>
                  </td>
                  <td>${invoice.due_date || '-'}</td>
                  <td>${invoice.invoice_number || '-'}</td>
                  <td>${invoice.provider || '-'}</td>
                  <td>
                    <button class="btn btn-sm btn-warning" onclick="editInvoice(${invoice.id})">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteInvoice(${invoice.id})">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    function hideResults() {
      const resultsContainer = document.getElementById('viewResults');
      if (resultsContainer) {
        resultsContainer.style.display = 'none';
        console.log('Results hidden');
      }
    }
    
    // Quick Actions Functions
    async function loadAllBuildings() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        showDataResults(buildings, 'buildings', 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™');
      } catch (error) {
        console.error('Error loading all buildings:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™');
      }
    }
    
    async function loadAllUnits() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch('/api/units?token=' + token);
        let units = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            units = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          showDataResults([], 'units', 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿ≠ÿØÿßÿ™');
          return;
        }
        showDataResults(units, 'units', 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿ≠ÿØÿßÿ™');
      } catch (error) {
        console.error('Error loading all units:', error);
        showDataResults([], 'units', 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿ≠ÿØÿßÿ™');
      }
    }
    
    async function loadAllPayments() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch('/api/payments?token=' + token);
        let payments = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            payments = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          showDataResults([], 'payments', 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸÅÿπÿßÿ™');
          return;
        }
        showDataResults(payments, 'payments', 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸÅÿπÿßÿ™');
      } catch (error) {
        console.error('Error loading all payments:', error);
        showDataResults([], 'payments', 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿØŸÅÿπÿßÿ™');
      }
    }
    
    async function loadAllInvoices() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        const response = await fetch('/api/invoices?token=' + token);
        let invoices = null;
        try {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            invoices = await response.json();
          } else {
            throw new Error('ÿßŸÑÿ±ÿØ ŸÖŸÜ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÑŸäÿ≥ JSON (ŸÇÿØ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ®ÿßŸÑÿÆÿßÿØŸÖ)');
          }
        } catch (jsonErr) {
          showDataResults([], 'invoices', 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±');
          return;
        }
        showDataResults(invoices, 'invoices', 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±');
      } catch (error) {
        console.error('Error loading all invoices:', error);
        showDataResults([], 'invoices', 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿ™Ÿäÿ±');
      }
    }

    // Helper functions to load dropdowns
    async function loadBuildingsForUnits() {
      try {
        console.log('loadBuildingsForUnits: Starting...');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        console.log('loadBuildingsForUnits: Token:', token);
        
        const response = await fetch('/api/buildings?token=' + token);
        console.log('loadBuildingsForUnits: Response status:', response.status);
        const buildings = await response.json();
        console.log('loadBuildingsForUnits: Buildings data:', buildings);
        
        const select = document.getElementById('unitBuilding');
        console.log('loadBuildingsForUnits: Found select element:', select);
        
        if (!select) {
          console.error('loadBuildingsForUnits: unitBuilding element not found!');
          return;
        }
        
        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>';
        
        if (buildings && buildings.length > 0) {
          console.log('loadBuildingsForUnits: Adding', buildings.length, 'buildings to dropdown');
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
          console.log('loadBuildingsForUnits: Dropdown populated successfully');
        } else {
          console.log('loadBuildingsForUnits: No buildings found');
          select.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸÜÿßŸäÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</option>';
        }
      } catch (error) {
        console.error('Error loading buildings:', error);
        const select = document.getElementById('unitBuilding');
        if (select) {
          select.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™</option>';
        }
      }
    }
    
    async function loadBuildingsForPayments() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        const select = document.getElementById('paymentBuilding');
        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>';
        
        if (buildings && buildings.length > 0) {
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸÜÿßŸäÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</option>';
        }
      } catch (error) {
        console.error('Error loading buildings for payments:', error);
        const select = document.getElementById('paymentBuilding');
        select.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™</option>';
      }
    }
    
    async function loadBuildingsForInvoices() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/buildings?token=' + token);
        const buildings = await response.json();
        
        const select = document.getElementById('invoiceBuilding');
        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>';
        
        if (buildings && buildings.length > 0) {
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸÜÿßŸäÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</option>';
        }
      } catch (error) {
        console.error('Error loading buildings for invoices:', error);
        const select = document.getElementById('invoiceBuilding');
        select.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸÜÿßŸäÿßÿ™</option>';
      }
    }
    
    async function loadUnitsForInvoice() {
      try {
        const buildingId = document.getElementById('invoiceBuilding').value;
        const unitSelect = document.getElementById('invoiceUnit');
        
        if (!buildingId) {
          unitSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã</option>';
          unitSelect.disabled = true;
          // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±
          document.getElementById('invoiceTenant').value = '';
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units?token=${token}&building_id=${buildingId}`);
        const units = await response.json();
        
        unitSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©</option>';
        unitSelect.disabled = false;
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} - ${getUnitTypeName(unit.unit_type)} - ${unit.tenant_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
            unitSelect.appendChild(option);
          });
        } else {
          unitSelect.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≠ÿØÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>';
        }
        
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±
        document.getElementById('invoiceTenant').value = '';
      } catch (error) {
        console.error('Error loading units for invoice:', error);
        const unitSelect = document.getElementById('invoiceUnit');
        unitSelect.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
        unitSelect.disabled = true;
        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ±
        document.getElementById('invoiceTenant').value = '';
      }
    }
    
    async function updateInvoiceTenant() {
      try {
        const unitId = document.getElementById('invoiceUnit').value;
        
        if (!unitId) {
          document.getElementById('invoiceTenant').value = '';
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units/${unitId}?token=${token}`);
        const unit = await response.json();
        
        if (response.ok && unit) {
          document.getElementById('invoiceTenant').value = unit.tenant_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        } else {
          document.getElementById('invoiceTenant').value = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
        }
      } catch (error) {
        console.error('Error loading unit details:', error);
        document.getElementById('invoiceTenant').value = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
      }
    }
    
    async function loadUnitsForPayment() {
      try {
        const buildingId = document.getElementById('paymentBuilding').value;
        const unitSelect = document.getElementById('paymentUnit');
        
        if (!buildingId) {
          unitSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ© ÿ£ŸàŸÑÿßŸã</option>';
          unitSelect.disabled = true;
          return;
        }
        
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch(`/api/units?token=${token}&building_id=${buildingId}`);
        const units = await response.json();
        
        unitSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©</option>';
        unitSelect.disabled = false;
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} - ${getUnitTypeName(unit.unit_type)} - ${unit.tenant_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}`;
            unitSelect.appendChild(option);
          });
        } else {
          unitSelect.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≠ÿØÿßÿ™ ŸÅŸä Ÿáÿ∞Ÿá ÿßŸÑÿ®ŸÜÿßŸäÿ©</option>';
        }
      } catch (error) {
        console.error('Error loading units for payment:', error);
        const unitSelect = document.getElementById('paymentUnit');
        unitSelect.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
        unitSelect.disabled = true;
      }
    }

    async function loadUnitsForPayments() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/units?token=' + token);
        const units = await response.json();
        
        const select = document.getElementById('paymentUnit');
        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©</option>';
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} - ${getUnitTypeName(unit.unit_type)}`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≠ÿØÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</option>';
        }
      } catch (error) {
        console.error('Error loading units:', error);
        const select = document.getElementById('paymentUnit');
        select.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
      }
    }

    async function loadUnitsForInvoices() {
      try {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        const response = await fetch('/api/units?token=' + token);
        const units = await response.json();
        
        const select = document.getElementById('invoiceUnit');
        select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©</option>';
        
        if (units && units.length > 0) {
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} - ${getUnitTypeName(unit.unit_type)}`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ Ÿàÿ≠ÿØÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</option>';
        }
      } catch (error) {
        console.error('Error loading units:', error);
        const select = document.getElementById('invoiceUnit');
        select.innerHTML = '<option value="">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
      }
    }

    // Save functions
    async function saveUnit() {
      try {
        const form = document.getElementById('addUnitForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const unitNumber = formData.get('unit_number');
        const unitType = formData.get('unit_type');
        const buildingId = formData.get('building_id');
        const rentValue = formData.get('rent_value');
        const tenantName = formData.get('tenant_name');
        const tenantPhone = formData.get('tenant_phone');
        
        if (!unitNumber || !unitNumber.trim()) {
          alert('ÿ±ŸÇŸÖ ÿßŸÑŸàÿ≠ÿØÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        if (!unitType) {
          alert('ŸÜŸàÿπ ÿßŸÑŸàÿ≠ÿØÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        if (!buildingId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©');
          return;
        }
        
        if (!rentValue || rentValue <= 0) {
          alert('ŸÇŸäŸÖÿ© ÿßŸÑÿ•Ÿäÿ¨ÿßÿ± ŸÖÿ∑ŸÑŸàÿ®ÿ©');
          return;
        }
        
        if (!tenantName || !tenantName.trim()) {
          alert('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ± ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        if (!tenantPhone || !tenantPhone.trim()) {
          alert('Ÿáÿßÿ™ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿ£ÿ¨ÿ± ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/units?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸàÿ≠ÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addUnitModal'));
          modal.hide();
          form.reset();
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error saving unit:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸàÿ≠ÿØÿ©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addUnitModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸàÿ≠ÿØÿ©';
        saveBtn.disabled = false;
      }
    }

    async function savePayment() {
      try {
        const form = document.getElementById('addPaymentForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const buildingId = formData.get('building_id');
        const unitId = formData.get('unit_id');
        const amount = formData.get('amount');
        const paymentDate = formData.get('payment_date');
        const installmentsCount = parseInt(formData.get('installments')) || 1;
        
        if (!buildingId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©');
          return;
        }
        if (!unitId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©');
          return;
        }
        if (!amount || amount <= 0) {
          alert('ŸÇŸäŸÖÿ© ÿßŸÑÿØŸÅÿπÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©');
          return;
        }
        if (!paymentDate) {
          alert('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿπÿØÿØ ÿßŸÑÿØŸÅÿπÿßÿ™ > 1ÿå ÿ£ÿ∂ŸÅ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
        if (installmentsCount > 1) {
          const installmentsContainer = document.getElementById('paymentInstallmentsContainer');
          if (installmentsContainer.style.display !== 'none') {
            console.log(`Processing ${installmentsCount} installments...`);
            
            // ÿ•ÿ≤ÿßŸÑÿ© ÿ≠ŸÇŸÑ amount ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿä ŸÑÿ™ÿ¨ŸÜÿ® ÿ™ÿ∂ŸÖŸäŸÜŸá ŸÅŸä ÿßŸÑÿ∑ŸÑÿ®
            formData.delete('amount');
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
            for (let i = 1; i <= installmentsCount; i++) {
              const installmentAmount = document.querySelector(`input[name="payment_installment_amount_${i}"]`);
              const installmentDueDate = document.querySelector(`input[name="payment_installment_due_date_${i}"]`);
              const installmentStatus = document.querySelector(`select[name="payment_installment_status_${i}"]`);
              const installmentType = document.querySelector(`select[name="payment_installment_type_${i}"]`);
              const installmentMethod = document.querySelector(`select[name="payment_installment_method_${i}"]`);
              const installmentNotes = document.querySelector(`input[name="payment_installment_notes_${i}"]`);
              
              console.log(`Installment ${i} elements:`, {
                amount: installmentAmount,
                dueDate: installmentDueDate,
                status: installmentStatus,
                type: installmentType,
                method: installmentMethod,
                notes: installmentNotes
              });
              
              // ÿ∑ÿ®ÿßÿπÿ© ÿ™ŸÅÿßÿµŸäŸÑ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿ™ÿ¥ÿÆŸäÿµ
              if (installmentAmount) {
                console.log(`Installment ${i} amount element found:`, installmentAmount.value);
              } else {
                console.log(`Installment ${i} amount element NOT found`);
              }
              
              if (installmentDueDate) {
                console.log(`Installment ${i} due date element found:`, installmentDueDate.value);
              } else {
                console.log(`Installment ${i} due date element NOT found`);
              }
              
              if (installmentAmount && installmentDueDate) {
                const amountValue = installmentAmount.value;
                const dueDateValue = installmentDueDate.value;
                const statusValue = installmentStatus ? installmentStatus.value : 'pending';
                const typeValue = installmentType ? installmentType.value : formData.get('payment_type');
                const methodValue = installmentMethod ? installmentMethod.value : formData.get('payment_method');
                const notesValue = installmentNotes ? installmentNotes.value : '';
                
                console.log(`Adding installment ${i} data:`, {
                  amount: amountValue,
                  dueDate: dueDateValue,
                  status: statusValue,
                  type: typeValue,
                  method: methodValue,
                  notes: notesValue
                });
                
                formData.append(`payment_installment_amount_${i}`, amountValue);
                formData.append(`payment_installment_due_date_${i}`, dueDateValue);
                formData.append(`payment_installment_status_${i}`, statusValue);
                formData.append(`payment_installment_type_${i}`, typeValue);
                formData.append(`payment_installment_method_${i}`, methodValue);
                formData.append(`payment_installment_notes_${i}`, notesValue);
              } else {
                console.log(`Skipping installment ${i} - missing required elements`);
              }
            }
            
            // ÿ∑ÿ®ÿßÿπÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©
            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
              console.log(`${key}: ${value}`);
            }
          }
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/payments?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          const paymentsAdded = result.paymentsAdded || 1;
          alert(`ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${paymentsAdded} ÿØŸÅÿπÿ© ÿ®ŸÜÿ¨ÿßÿ≠!`);
          const modal = bootstrap.Modal.getInstance(document.getElementById('addPaymentModal'));
          modal.hide();
          form.reset();
          
          // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿØŸÅÿπÿßÿ™ ÿßŸÑÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ©
          document.getElementById('paymentInstallmentsContainer').style.display = 'none';
          document.getElementById('paymentAmount').readOnly = false;
          document.getElementById('paymentAmount').style.backgroundColor = '';
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error saving payment:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸÅÿπÿ©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addPaymentModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑÿØŸÅÿπÿ©';
        saveBtn.disabled = false;
      }
    }

    async function saveInvoice() {
      try {
        const form = document.getElementById('addInvoiceForm');
        const formData = new FormData(form);
        
        // Validate required fields
        const buildingId = formData.get('building_id');
        const unitId = formData.get('unit_id');
        const invoiceType = formData.get('invoice_type');
        const amount = formData.get('amount');
        const invoiceDate = formData.get('invoice_date');
        
        if (!buildingId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÜÿßŸäÿ©');
          return;
        }
        if (!unitId) {
          alert('ÿßÿÆÿ™ÿ± ÿßŸÑŸàÿ≠ÿØÿ©');
          return;
        }
        if (!invoiceType) {
          alert('ŸÜŸàÿπ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        if (!amount || amount <= 0) {
          alert('ŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        if (!invoiceDate) {
          alert('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ŸÖÿ∑ŸÑŸàÿ®');
          return;
        }
        
        // Show loading
        const saveBtn = document.querySelector('#addInvoiceModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...';
        saveBtn.disabled = true;
        
        // Get user token
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;
        
        // Send request
        const response = await fetch('/api/invoices?token=' + token, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠!');
          const modal = bootstrap.Modal.getInstance(document.getElementById('addInvoiceModal'));
          modal.hide();
          form.reset();
        } else {
          alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + (result.error || 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
        }
      } catch (error) {
        console.error('Error saving invoice:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©');
      } finally {
        // Reset button
        const saveBtn = document.querySelector('#addInvoiceModal .btn-success');
        saveBtn.innerHTML = '<i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©';
        saveBtn.disabled = false;
      }
    }

    // Payment Status Functions
    let currentUser = null;
    let payments = [];

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
    async function loadUser() {
      try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ URL
        let token = localStorage.getItem('token');
        if (!token) {
          // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ŸÖŸÜ URL
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping user load');
          return;
        }

        const response = await fetch(`/api/users?token=${token}`);
        const users = await response.json();
        currentUser = users.find(user => user.id == token);
        
        if (!currentUser) {
          console.log('User not found, skipping user load');
          return;
        }
      } catch (error) {
        console.error('Error loading user:', error);
        // ŸÑÿß ŸÜÿπŸäÿØ ÿßŸÑÿ™Ÿàÿ¨ŸäŸáÿå ŸÅŸÇÿ∑ ŸÜÿ∑ÿ®ÿπ ÿßŸÑÿÆÿ∑ÿ£
      }
    }

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ®ÿßŸÜŸä
    async function loadBuildings() {
      try {
        console.log('Loading buildings...');
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping buildings load');
          return;
        }
        
        console.log('Fetching buildings with token:', token);
        const response = await fetch(`/api/buildings?token=${token}`);
        console.log('Buildings response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const buildings = await response.json();
        console.log('Buildings loaded:', buildings.length);
        console.log('Buildings data:', buildings);
        
        const buildingSelect = document.getElementById('buildingSelect');
        if (buildingSelect) {
          buildingSelect.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ®ÿßŸÜŸä</option>';
          
          buildings.forEach(building => {
            const option = document.createElement('option');
            option.value = building.id;
            option.textContent = building.name;
            buildingSelect.appendChild(option);
          });
          console.log('Buildings dropdown populated with', buildings.length, 'buildings');
        } else {
          console.error('buildingSelect element not found');
        }
      } catch (error) {
        console.error('Error loading buildings:', error);
      }
    }

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸàÿ≠ÿØÿßÿ™
    async function loadUnits(buildingId = '') {
      try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping units load');
          return;
        }
        
        let url = `/api/units?token=${token}`;
        if (buildingId) {
          url += `&building_id=${buildingId}`;
        }
        
        const response = await fetch(url);
        const units = await response.json();
        
        const unitSelect = document.getElementById('unitSelect');
        if (unitSelect) {
          unitSelect.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸàÿ≠ÿØÿßÿ™</option>';
          
          units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = `${unit.unit_number} - ${unit.unit_type}`;
            unitSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading units:', error);
      }
    }

    // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™
    async function loadPayments() {
      try {
        console.log('Loading payments...');
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          console.log('No token found, skipping payments load');
          return;
        }
        
        const unitId = document.getElementById('unitSelect')?.value || '';
        
        let url = `/api/payments?token=${token}`;
        if (unitId) {
          url += `&unit_id=${unitId}`;
        }
        
        console.log('Fetching payments from:', url);
        const response = await fetch(url);
        console.log('Payments response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const payments = await response.json();
        console.log('Payments loaded:', payments.length);
        console.log('Payments data:', payments);
        
        displayPayments(payments);
      } catch (error) {
        console.error('Error loading payments:', error);
      }
    }

    // ÿπÿ±ÿ∂ ÿßŸÑÿØŸÅÿπÿßÿ™
    function displayPayments(payments) {
      console.log('Displaying payments:', payments);
      const paymentsList = document.getElementById('paymentsList');
      if (!paymentsList) {
        console.error('paymentsList element not found');
        return;
      }
      
      console.log('Found paymentsList element, clearing content...');
      paymentsList.innerHTML = '';
      
      if (!payments || payments.length === 0) {
        console.log('No payments to display');
        paymentsList.innerHTML = `
          <div class="col-12 text-center">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØŸÅÿπÿßÿ™</p>
          </div>
        `;
        return;
      }
      
      console.log('Creating payment cards for', payments.length, 'payments');
      payments.forEach((payment, index) => {
        console.log(`Creating card for payment ${index + 1}:`, payment);
        const paymentCard = createPaymentCard(payment);
        paymentsList.appendChild(paymentCard);
      });
      
      console.log('Payment cards created successfully');
    }

    // ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑÿØŸÅÿπ
    function createPaymentCard(payment) {
      console.log('Creating payment card for payment:', payment);
      
      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4 mb-4';
      
      const statusClass = getStatusClass(payment.calculated_status);
      const progressPercent = payment.payment_percentage || 0;
      
      console.log('Payment card data:', {
        id: payment.id,
        unit_number: payment.unit_number,
        amount: payment.amount,
        paid_amount: payment.paid_amount,
        remaining_amount: payment.remaining_amount,
        calculated_status: payment.calculated_status,
        status_arabic: payment.status_arabic,
        progressPercent: progressPercent
      });
      
      col.innerHTML = `
        <div class="card payment-card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-credit-card"></i>
              ÿØŸÅÿπÿ© #${payment.id}
            </h6>
            <span class="status-badge ${statusClass}">
              ${payment.status_arabic}
            </span>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <strong>ÿßŸÑŸàÿ≠ÿØÿ©:</strong> ${payment.unit_number}
            </div>
            <div class="mb-3">
              <strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</strong> ${payment.amount} ÿØÿ±ŸáŸÖ
            </div>
            <div class="mb-3">
              <strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ:</strong> ${payment.paid_amount || 0} ÿØÿ±ŸáŸÖ
            </div>
            <div class="mb-3">
              <strong>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:</strong> ${payment.remaining_amount} ÿØÿ±ŸáŸÖ
            </div>
            <div class="mb-3">
              <strong>ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿØŸÅÿπ:</strong>
              <div class="progress">
                <div class="progress-bar" style="width: ${progressPercent}%"></div>
              </div>
              <small class="text-muted">${progressPercent}%</small>
            </div>
            <div class="mb-3">
              <strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ:</strong> ${payment.due_date}
            </div>
            <div class="mb-3">
              <strong>ÿßŸÑŸàÿµŸÅ:</strong> ${payment.description || 'ŸÑÿß ŸäŸàÿ¨ÿØ ŸàÿµŸÅ'}
            </div>
            ${payment.receipt_documents ? `
              <div class="mb-3">
                <strong>ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿ®ÿ∂:</strong>
                <div class="mt-2">
                  ${payment.receipt_documents.split(',').map(doc => 
                    `<a href="/uploads/${doc}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                      <i class="fas fa-file"></i> ${doc}
                    </a>`
                  ).join('')}
                </div>
              </div>
            ` : ''}
          </div>
          <div class="card-footer">
            <button class="btn btn-primary btn-sm w-100" onclick="openUpdateModal(${payment.id})">
              <i class="fas fa-edit"></i>
              ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≠ÿßŸÑÿ©
            </button>
          </div>
        </div>
      `;
      
      console.log('Payment card created successfully');
      return col;
    }

    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÅÿ¶ÿ© ÿßŸÑÿ≠ÿßŸÑÿ©
    function getStatusClass(status) {
      switch (status) {
        case 'paid_full':
          return 'status-paid-full';
        case 'paid_partial':
          return 'status-paid-partial';
        case 'overdue':
          return 'status-overdue';
        default:
          return 'status-pending';
      }
    }

    // ŸÅÿ™ÿ≠ modal ÿßŸÑÿ™ÿ≠ÿØŸäÿ´
    async function openUpdateModal(paymentId) {
      try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
          return;
        }
        
        const response = await fetch(`/api/payments/${paymentId}/details?token=${token}`);
        const payment = await response.json();
        
        document.getElementById('paymentId').value = payment.id;
        document.getElementById('totalAmount').value = payment.amount;
        document.getElementById('paidAmount').value = payment.paid_amount || 0;
        document.getElementById('paymentStatus').value = payment.payment_status || 'pending';
        document.getElementById('paymentDateActual').value = payment.payment_date_actual || '';
        document.getElementById('paymentNotes').value = '';
        document.getElementById('selectedFiles').innerHTML = '';
        
        const modal = new bootstrap.Modal(document.getElementById('updatePaymentModal'));
        modal.show();
      } catch (error) {
        console.error('Error loading payment details:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸÅÿπ');
      }
    }

    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸÅÿπ
    async function updatePayment() {
      const paymentId = document.getElementById('paymentId').value;
      const paidAmount = parseFloat(document.getElementById('paidAmount').value);
      const paymentStatus = document.getElementById('paymentStatus').value;
      const paymentDateActual = document.getElementById('paymentDateActual').value;
      const notes = document.getElementById('paymentNotes').value;
      
      if (!paidAmount || paidAmount < 0) {
        alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ ÿµÿ≠Ÿäÿ≠');
        return;
      }
      
      const formData = new FormData();
      formData.append('paid_amount', paidAmount);
      formData.append('payment_status', paymentStatus);
      if (paymentDateActual) {
        formData.append('payment_date_actual', paymentDateActual);
      }
      if (notes) {
        formData.append('notes', notes);
      }
      
      // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©
      const fileInput = document.getElementById('receiptDocuments');
      for (let file of fileInput.files) {
        formData.append('receipt_documents', file);
      }
      
      try {
        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ token ŸÖŸÜ localStorage ÿ£Ÿà ŸÖŸÜ URL
        let token = localStorage.getItem('token');
        if (!token) {
          const urlParams = new URLSearchParams(window.location.search);
          token = urlParams.get('token');
        }
        
        if (!token) {
          alert('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ±ŸÖÿ≤ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ');
          return;
        }
        
        const response = await fetch(`/api/payments/${paymentId}/payment-status?token=${token}`, {
          method: 'PUT',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
          
          // ÿ•ÿ∫ŸÑÿßŸÇ Modal Ÿàÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
          bootstrap.Modal.getInstance(document.getElementById('updatePaymentModal')).hide();
          await loadPayments();
        } else {
          const error = await response.json();
          alert('ÿÆÿ∑ÿ£: ' + error.error);
        }
      } catch (error) {
        console.error('Error updating payment:', error);
        alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØŸÅÿπ');
      }
    }

    // ÿ•ÿπÿØÿßÿØ drag and drop ŸÑŸÑŸÖŸÑŸÅÿßÿ™
    function setupFileUpload() {
      const fileUpload = document.getElementById('fileUpload');
      const fileInput = document.getElementById('receiptDocuments');
      const selectedFiles = document.getElementById('selectedFiles');
      
      fileUpload.addEventListener('click', () => fileInput.click());
      
      fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('dragover');
      });
      
      fileUpload.addEventListener('dragleave', () => {
        fileUpload.classList.remove('dragover');
      });
      
      fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('dragover');
        fileInput.files = e.dataTransfer.files;
        updateSelectedFiles();
      });
      
      fileInput.addEventListener('change', updateSelectedFiles);
      
      function updateSelectedFiles() {
        selectedFiles.innerHTML = '';
        for (let file of fileInput.files) {
          const fileDiv = document.createElement('div');
          fileDiv.className = 'alert alert-info d-flex justify-content-between align-items-center';
          fileDiv.innerHTML = `
            <span><i class="fas fa-file"></i> ${file.name}</span>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()">
              <i class="fas fa-times"></i>
            </button>
          `;
          selectedFiles.appendChild(fileDiv);
        }
      }
    }

    // ÿ•ÿπÿØÿßÿØ event listeners ŸÑŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ¨ÿØŸäÿØ
    document.addEventListener('DOMContentLoaded', function() {
      // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ¨ÿØŸäÿØ
      const buildingSelect = document.getElementById('buildingSelect');
      const unitSelect = document.getElementById('unitSelect');
      
      if (buildingSelect) {
        buildingSelect.addEventListener('change', function() {
          loadUnits(this.value);
        });
      }
      
      if (unitSelect) {
        unitSelect.addEventListener('change', loadPayments);
      }

      // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ®ŸàŸäÿ® ÿßŸÑÿ¨ÿØŸäÿØ ÿπŸÜÿØ ŸÅÿ™ÿ≠Ÿá
      const paymentStatusTab = document.getElementById('payment-status-tab');
      if (paymentStatusTab) {
        paymentStatusTab.addEventListener('shown.bs.tab', async function() {
          console.log('Payment status tab opened');
          try {
            console.log('Starting to load data for payment status tab...');
            await loadUser();
            console.log('User loaded successfully');
            await loadBuildings();
            console.log('Buildings loaded successfully');
            await loadUnits();
            console.log('Units loaded successfully');
            await loadPayments();
            console.log('Payments loaded successfully');
            setupFileUpload();
            console.log('File upload setup completed');
          } catch (error) {
            console.error('Error initializing payment status tab:', error);
          }
        });
      }
      
      // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ™ÿ®ŸàŸäÿ® ŸÖŸÅÿ™Ÿàÿ≠
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, checking if payment status tab is active...');
        const paymentStatusTab = document.getElementById('payment-status-tab');
        const paymentStatusPane = document.getElementById('payment-status');
        
        if (paymentStatusTab && paymentStatusTab.classList.contains('active')) {
          console.log('Payment status tab is active, loading data...');
          loadUser().then(() => {
            loadBuildings().then(() => {
              loadUnits().then(() => {
                loadPayments();
              });
            });
          });
        }
      });
    });
  </script>

  <!-- Modal ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ -->
  <div class="modal fade" id="updatePaymentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">
            <i class="fas fa-edit"></i>
            ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="updatePaymentForm">
            <input type="hidden" id="paymentId">
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</label>
                  <input type="text" id="totalAmount" class="form-control" readonly>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ:</label>
                  <input type="number" id="paidAmount" class="form-control" step="0.01" required>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ:</label>
                  <select id="paymentStatus" class="form-select" required>
                    <option value="pending">ŸÖÿπŸÑŸÇ</option>
                    <option value="paid_partial">ÿØŸÅÿπ ÿ¨ÿ≤ÿ¶Ÿä</option>
                    <option value="paid_full">ÿØŸÅÿπ ŸÉŸÑŸä</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿØŸÅÿπ ÿßŸÑŸÅÿπŸÑŸä:</label>
                  <input type="date" id="paymentDateActual" class="form-control">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">ŸÖÿ≥ÿ™ŸÜÿØÿßÿ™ ÿßŸÑŸÇÿ®ÿ∂:</label>
              <div class="file-upload" id="fileUpload">
                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">ÿßÿ≥ÿ≠ÿ® ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸáŸÜÿß ÿ£Ÿà ÿßÿ∂ÿ∫ÿ∑ ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÑŸÅÿßÿ™</p>
                <input type="file" id="receiptDocuments" multiple accept="image/*,.pdf" style="display: none;">
                <div id="selectedFiles" class="mt-3"></div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</label>
              <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÿ•ŸÑÿ∫ÿßÿ°</button>
          <button type="button" class="btn btn-primary" onclick="updatePayment()">
            <i class="fas fa-save"></i>
            ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™
          </button>
        </div>
      </div>
    </div>
  </div>
</body>
</html> 