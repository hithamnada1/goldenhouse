<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>عقود الإيجار - جولدن هوس للعقارات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background: #f8f9fa; }
    .header {
      background: linear-gradient(135deg, #23272f 0%, #181c22 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    .form-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    .nav-tabs .nav-link {
      color: #6c757d;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: bold;
    }
    .nav-tabs .nav-link.active {
      color: #bfa046;
      border-bottom: 3px solid #bfa046;
      background: none;
    }
    textarea {
      min-height: 1000px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
    }
    
    .terms-card {
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      min-height: 200px;
    }
    
    .terms-card:hover {
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      transform: translateY(-3px);
      border-color: #bfa046;
    }
    
    .terms-card.editing {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    .terms-card h6 {
      color: #bfa046;
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1.1rem;
      border-bottom: 2px solid #f8f9fa;
      padding-bottom: 0.5rem;
    }
    
    .terms-card .content {
      min-height: 120px;
      line-height: 1.6;
    }
    
    .terms-card .edit-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #bfa046;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .terms-card:hover .edit-btn {
      opacity: 1;
    }
    
    .terms-card .save-btn {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }
    
    .terms-card.editing .save-btn {
      display: inline-block;
    }
    
    .terms-display {
      transition: all 0.3s ease;
    }
    
    #numberedTerms li {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #bfa046;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-0">
            <img src="images/logo.png" alt="شعار الشركة" style="height: 50px; margin-left: 15px; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
<span style="display:none; font-size: 1.5em; margin-left: 15px;">🏠</span>
            عقود الإيجار
          </h1>
        </div>
        <div class="col-md-4 text-end">
          <a href="/" class="btn btn-outline-light">العودة للصفحة الرئيسية</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="form-container">
      <form id="contractForm">
        <!-- Main Tabs -->
        <ul class="nav nav-tabs mb-4" id="contractTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="add-contract-tab" data-bs-toggle="tab" data-bs-target="#add-contract" type="button" role="tab">
              إضافة عقد جديد
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="contractTabsContent">
          <!-- Add Contract Tab -->
          <div class="tab-pane fade show active" id="add-contract" role="tabpanel">
            <!-- Contract Sub-tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" type="button" role="tab" onclick="goToTab(0)">
                  البيانات الشخصية
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="contract-tab" type="button" role="tab" onclick="goToTab(1)">
                  بيانات العقد
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="municipality-tab" type="button" role="tab" onclick="goToTab(2)">
                  بيانات البلدية
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="terms-tab" type="button" role="tab" onclick="goToTab(3)">
                  الشروط والأحكام
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="internal-tab" type="button" role="tab" onclick="goToTab(4)">
                  تفاصيل داخلية
                </button>
              </li>
            </ul>

            <!-- Contract Sub-tab Content -->
            <div class="tab-content" id="contractSubTabsContent">
              <!-- Personal Data Tab -->
              <div class="tab-pane fade show active" id="personal" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">اسم العميل</label>
                  <input type="text" class="form-control" name="clientName">
                </div>
                <div class="mb-3">
                  <label class="form-label">رقم الهاتف</label>
                  <input type="text" class="form-control" name="clientPhone">
                </div>
                <div class="mb-3">
                  <label class="form-label">البريد الإلكتروني</label>
                  <input type="email" class="form-control" name="clientEmail">
                </div>
                
                <!-- قسم المستندات -->
                <div class="mb-3">
                  <label class="form-label">
                    <i class="fas fa-file-upload"></i>
                    مستندات العميل
                  </label>
                  <div class="border rounded p-3 bg-light">
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">الهوية الشخصية</label>
                        <input type="file" class="form-control form-control-sm" name="identityDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">جواز السفر</label>
                        <input type="file" class="form-control form-control-sm" name="passportDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">إثبات العنوان</label>
                        <input type="file" class="form-control form-control-sm" name="addressDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">إثبات الدخل</label>
                        <input type="file" class="form-control form-control-sm" name="incomeDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">مستندات إضافية</label>
                        <input type="file" class="form-control form-control-sm" name="additionalDocuments" accept=".pdf,.jpg,.jpeg,.png" multiple>
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">ملاحظات المستندات</label>
                        <textarea class="form-control form-control-sm" name="documentsNotes" placeholder="ملاحظات حول المستندات المرفقة" rows="2"></textarea>
                      </div>
                    </div>
                    
                    <!-- عرض المستندات المرفقة -->
                    <div id="uploadedDocuments" class="mt-3" style="display: none;">
                      <h6 class="text-primary">المستندات المرفقة:</h6>
                      <div id="documentsList" class="small">
                        <!-- سيتم ملء هذا بواسطة JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-primary" onclick="nextTab()">التالي</button>
                </div>
              </div>

              <!-- Contract Data Tab -->
              <div class="tab-pane fade" id="contract" role="tabpanel">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <strong>ملاحظة:</strong> سيتم إنشاء رقم العقد تلقائياً عند الحفظ مع التاريخ والوقت الحالي
                </div>
                <div class="mb-3">
                  <label class="form-label">رقم الوحدة</label>
                  <input type="text" class="form-control" name="unitNumber">
                </div>
                <div class="mb-3">
                  <label class="form-label">قيمة الإيجار السنوي</label>
                  <input type="number" class="form-control" name="rentValue">
                </div>
                <div class="mb-3">
                  <label class="form-label">عدد الدفعات</label>
                  <input type="number" class="form-control" name="installments">
                </div>
                <div class="mb-3">
                  <label class="form-label">مبلغ التأمين</label>
                  <input type="number" class="form-control" name="insurance">
                </div>
                <div class="mb-3">
                  <label class="form-label">عمولة المكتب</label>
                  <input type="number" class="form-control" name="officeCommission">
                </div>
                <div class="mb-3">
                  <label class="form-label">Service Fees</label>
                  <input type="number" class="form-control" name="serviceFees" placeholder="Enter service fees">
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">السابق</button>
                  <button type="button" class="btn btn-primary" onclick="nextTab()">التالي</button>
                </div>
              </div>

              <!-- Municipality Data Tab -->
              <div class="tab-pane fade" id="municipality" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">رسوم التصديق</label>
                  <input type="number" class="form-control" name="municipalityFile" placeholder="أدخل رسوم التصديق">
                </div>
                <div class="mb-3">
                  <label class="form-label">رسوم الصرف الصحي</label>
                  <input type="number" class="form-control" name="municipalityDate" placeholder="أدخل رسوم الصرف الصحي">
                </div>
                <div class="mb-3">
                  <label class="form-label">رسوم الأونلاين</label>
                  <input type="number" class="form-control" name="onlineFees" placeholder="أدخل رسوم الأونلاين">
                </div>
                <div class="mb-3">
                  <label class="form-label">رسوم الكهرباء</label>
                  <input type="number" class="form-control" name="electricityFees" placeholder="أدخل رسوم الكهرباء">
                </div>
                <div class="mb-3">
                  <label class="form-label">رسوم أخرى</label>
                  <input type="number" class="form-control" name="waterFees" placeholder="أدخل رسوم أخرى">
                </div>
                <div class="mb-3">
                  <label class="form-label">ملاحظات إضافية</label>
                  <textarea class="form-control" name="municipalityNotes" placeholder="أدخل أي ملاحظات إضافية"></textarea>
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">السابق</button>
                  <button type="button" class="btn btn-primary" onclick="nextTab()">التالي</button>
                </div>
              </div>

              <!-- Terms and Conditions Tab -->
              <div class="tab-pane fade" id="terms" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">الشروط والأحكام - بطاقات منفصلة قابلة للتعديل</label>
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>ملاحظة:</strong> يمكنك تعديل أي من الشروط بالضغط على البطاقة وتعديل المحتوى
                  </div>
                </div>
                
                <!-- Cards Display -->
                <div id="termsCardsContainer" class="terms-display">
                  <div class="row" id="termsCards">
                    <!-- سيتم ملء هذا بواسطة JavaScript -->
                  </div>
                  <textarea class="form-control mt-3" name="terms" id="termsTextCards" style="display: none;"></textarea>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">السابق</button>
                  <button type="button" class="btn btn-primary" onclick="nextTab()">التالي</button>
                </div>
              </div>

              <!-- Internal Details Tab -->
              <div class="tab-pane fade" id="internal-details" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">تفاصيل داخلية</label>
                  <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>ملاحظة:</strong> هذه التفاصيل للاستخدام الداخلي فقط
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user"></i>
                        وسيط صاحب الزبون
                      </label>
                      <div class="input-group">
                        <select class="form-control" name="brokerName" id="brokerSelect">
                          <option value="">اختر وسيط صاحب الزبون</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="openAddBrokerModal()">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user-tie"></i>
                        وسيط صاحب الوحدة
                      </label>
                      <div class="input-group">
                        <select class="form-control" name="brokerNameUnit" id="brokerSelectUnit">
                          <option value="">اختر وسيط صاحب الوحدة</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="openAddBrokerModal()">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">العمولة الإجمالية</label>
                      <input type="number" class="form-control" name="totalCommission" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">الخارج من العمولة</label>
                      <input type="number" class="form-control" name="commissionDeduction" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">قيمة التصديقات</label>
                      <input type="number" class="form-control" name="attestationValueInternal" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-stamp"></i>
                        التصديقات للمندوب
                      </label>
                      <input type="number" class="form-control" name="representativeAttestation" placeholder="0.00" min="0" step="0.01">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">الخارج من التصديقات</label>
                      <input type="number" class="form-control" name="attestationDeduction" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user"></i>
                        عمولة المندوب صاحب الزبون
                      </label>
                      <input type="number" class="form-control" name="representativeCommission" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user-tie"></i>
                        عمولة المندوب صاحب الوحدة
                      </label>
                      <input type="number" class="form-control" name="representativeCommissionUnit" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-file-contract"></i>
                        التخليص
                      </label>
                      <div class="input-group">
                        <select class="form-control" name="clearanceName" id="clearanceSelect">
                          <option value="">اختر وسيط التخليص</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="openAddBrokerModal()">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-money-bill-wave"></i>
                        قيمة التخليص
                      </label>
                      <input type="number" class="form-control" name="clearanceValue" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">عمولة المكتب</label>
                      <input type="number" class="form-control" name="officeCommissionInternal" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">ملاحظات إضافية</label>
                      <textarea class="form-control" name="internalNotes" rows="4" placeholder="ملاحظات داخلية إضافية..."></textarea>
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">السابق</button>
                  <button type="submit" class="btn btn-success">حفظ العقد</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <div>
            <a href="/" class="btn btn-outline-secondary">العودة للصفحة الرئيسية</a>
          </div>
          <div>
            <button type="button" class="btn btn-success" id="saveBtn" onclick="console.log('Save button clicked!'); document.getElementById('contractForm').dispatchEvent(new Event('submit'));">حفظ العقد</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Broker Modal -->
<div class="modal fade" id="addBrokerModal" tabindex="-1" aria-labelledby="addBrokerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBrokerModalLabel">
          <i class="fas fa-user-plus"></i>
          إضافة وسيط جديد
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addBrokerForm">
          <div class="mb-3">
            <label for="newBrokerName" class="form-label">اسم الوسيط</label>
            <input type="text" class="form-control" id="newBrokerName" required>
          </div>
          <div class="mb-3">
            <label for="newBrokerPhone" class="form-label">رقم الهاتف</label>
            <input type="tel" class="form-control" id="newBrokerPhone">
          </div>
          <div class="mb-3">
            <label for="newBrokerEmail" class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="newBrokerEmail">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-primary" onclick="addNewBroker()">
          <i class="fas fa-save"></i>
          حفظ الوسيط
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate Modal for Unit Broker -->
<div class="modal fade" id="addBrokerModalUnit" tabindex="-1" aria-labelledby="addBrokerModalUnitLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBrokerModalUnitLabel">
          <i class="fas fa-user-plus"></i>
          إضافة وسيط جديد (صاحب الوحدة)
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addBrokerFormUnit">
          <div class="mb-3">
            <label for="newBrokerNameUnit" class="form-label">اسم الوسيط</label>
            <input type="text" class="form-control" id="newBrokerNameUnit" required>
          </div>
          <div class="mb-3">
            <label for="newBrokerPhoneUnit" class="form-label">رقم الهاتف</label>
            <input type="tel" class="form-control" id="newBrokerPhoneUnit">
          </div>
          <div class="mb-3">
            <label for="newBrokerEmailUnit" class="form-label">البريد الإلكتروني</label>
            <input type="email" class="form-control" id="newBrokerEmailUnit">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-primary" onclick="addNewBrokerUnit()">
          <i class="fas fa-save"></i>
          حفظ الوسيط
        </button>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    console.log('=== CONTRACTS.HTML SCRIPT STARTED ===');
    
    // Load page when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOM CONTENT LOADED ===');
      console.log('Document ready...');
      
      // Initialize terms cards
      renderCards();
      
      // Set initial terms text
      const termsTextarea = document.getElementById('termsTextCards');
      if (termsTextarea) {
        termsTextarea.value = getTermsAsText();
      }
    });



    // Terms and conditions data
    const termsData = [
      {
        title: "الهوية والوثائق المطلوبة",
        content: "يجب احضار صور من بطاقة الهوية الإماراتة وجواز السفر ساريا المفعول وغير منتهين حسب تعليمات دائرة البلدية والتخطيط لانهاء التعاقد وانهاء إجراءات العقد"
      },
      {
        title: "مسؤولية المستأجر تجاه البلدية",
        content: "المستأجر هو المسئول عن موافقة البلدية عن العقد وفى حالة وجود اى مشكلة من قبل المسـتأجر تمنع موافقة البلدية على تصديق العقد سواء لدية وحده أخرى او اى شيء اخر يتحملها المستأجر فقط"
      },
      {
        title: "الشيكات والتوقيعات",
        content: "احضار الشيكات الشخصية باسم صاحب العقد فقط وتوقيع الشيكات بنفسه لدينا ولا يجوز احضار الشيكات موقعه لتكملة أقساط التعاقد على الوحدة السكنية"
      },
      {
        title: "السكن العائلي",
        content: "السكن عائلى ووجب احضار صورة من عقد الزواج والابناء"
      },
      {
        title: "الدفعات والالتزامات",
        content: "على العميل دفع الدفعة الايجارية المتفق عليها واحضار الشيكات الخاصه بصاحب العقد فقط في المدة المتفق عليها وهى (    ​ ) أيام من دفع العربون وفى حالة التأخر عن المدة المحددة او الاخلال بأحد الشروط لا يحق استرداد العمولة مع خصم ١٥ يوم من القيمة الايجارية ولا تتحمل الشركة مسؤلية اى أوراق مقدمه من العميل غير صحيحة او منقوصة"
      },
      {
        title: "Identity and Required Documents",
        content: "Photocopies of the Emirates ID card, valid passport and other copies must be brought according to the instructions of the Attendance and Registration Department for registration, signing and termination of contracts"
      },
      {
        title: "Tenant's Responsibility for Municipality",
        content: "The tenant is responsible for the municipality's approval of the contract, and if there is any problem on the part of the tenant that prevents the municipality from approving the contract, whether he has another unit or anything else, that is, it is borne by the tenant only"
      },
      {
        title: "Checks and Signatures",
        content: "Bring personal checks in the name of the contract holder only and sign the checks himself with us. It is not permissible to bring signed checks to complete the housing unit contract installments"
      },
      {
        title: "Family Housing",
        content: "You must bring family housing and a copy of the marriage and children's contract"
      },
      {
        title: "Payments and Obligations",
        content: "The customer must pay the agreed upon rental amount and bring checks belonging to the contract owner only during the agreed upon period, which is (​​) days after deposit payment. In the event of delay beyond the specified period or violation of one of the conditions, the commission will not be refunded, with a deduction of 15 days from the rental value. The company does not bear responsibility for any incorrect or incomplete papers submitted by the customer"
      },
      {
        title: "العربون غير مسترد",
        content: "<span style='color: red; font-weight: bold;'>العربون غير مسترد نهائياً في حالة رجوع العميل ولا يحق المطالبة به لدى أي جهة وهذا اتفاق لا يجوز العدول عنه</span>"
      }
    ];

    // Function to get terms as text
    function getTermsAsText() {
      console.log('=== GETTING TERMS AS TEXT ===');
      const text = termsData.map((term, index) => {
        // إزالة HTML tags للحصول على النص النقي
        const cleanContent = term.content.replace(/<[^>]*>/g, '');
        return `${index + 1}- ${term.title}\n${cleanContent}`;
      }).join('\n\n');
      console.log('Terms text length:', text.length);
      return text;
    }



    // Function to render cards
    function renderCards() {
      const container = document.getElementById('termsCards');
      container.innerHTML = termsData.map((term, index) => 
        `<div class="col-md-6">
          <div class="terms-card" data-index="${index}">
            <button class="edit-btn" onclick="editTerm(${index})" title="تعديل">
              <i class="fas fa-edit"></i>
            </button>
            <h6>${term.title}</h6>
            <div class="content" id="content-${index}">${term.content}</div>
            <textarea class="form-control mt-2" id="edit-${index}" style="display: none; min-height: 100px;">${term.content.replace(/<[^>]*>/g, '')}</textarea>
            <button class="save-btn" onclick="saveTerm(${index})">حفظ التعديل</button>
          </div>
        </div>`
      ).join('');
    }

    // Contract form tab navigation logic
    const contractTabs = ["personal", "contract", "municipality", "terms", "internal-details"];
    let currentContractTab = 0;
    
    function showContractTab(idx) {
      console.log('showContractTab called with idx:', idx);
      
      const tabPanes = document.querySelectorAll('#contractSubTabsContent .tab-pane');
      const navLinks = document.querySelectorAll('#add-contract .nav-link');
      
      console.log('Found tab panes:', tabPanes.length);
      console.log('Found nav links:', navLinks.length);
      
      tabPanes.forEach((el, i) => {
        el.classList.remove('show', 'active');
        if (i === idx) {
          el.classList.add('show', 'active');
          console.log('Activated tab pane:', i);
        }
      });
      
      navLinks.forEach((el, i) => {
        el.classList.remove('active');
        if (i === idx) {
          el.classList.add('active');
          console.log('Activated nav link:', i);
        }
      });
    }
    
    // Navigation functions for contract tabs
    function goToTab(idx) {
      console.log('goToTab called with idx:', idx);
      currentContractTab = idx;
      showContractTab(currentContractTab);
    }
    
    function nextTab() {
      console.log('nextTab called, current tab:', currentContractTab);
      if (currentContractTab < 5) { // Updated to 5 for the new tab
        currentContractTab++;
        console.log('Moving to tab:', currentContractTab);
        showContractTab(currentContractTab);
      }
    }
    
    function prevTab() {
      console.log('prevTab called, current tab:', currentContractTab);
      if (currentContractTab > 0) {
        currentContractTab--;
        console.log('Moving to tab:', currentContractTab);
        showContractTab(currentContractTab);
      }
    }
    
    // Initialize tabs
    showContractTab(currentContractTab);

    // Initialize form when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the form
      console.log('Contract form initialized');
      

      
      // Check if we're editing a contract
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit');
      
      if (editId) {
        console.log('Editing contract with ID:', editId);
        loadContractForEdit(editId);
      }
      
      // Initialize terms display
      renderCards();
      

    
    // Edit term function
    window.editTerm = function(index) {
      const card = document.querySelector(`[data-index="${index}"]`);
      const content = document.getElementById(`content-${index}`);
      const textarea = document.getElementById(`edit-${index}`);
      
      card.classList.add('editing');
      content.style.display = 'none';
      textarea.style.display = 'block';
      textarea.focus();
    };
    
    // Save term function
    window.saveTerm = function(index) {
      const card = document.querySelector(`[data-index="${index}"]`);
      const content = document.getElementById(`content-${index}`);
      const textarea = document.getElementById(`edit-${index}`);
      
      // Update the data - preserve HTML for special terms like the deposit clause
      let newContent = textarea.value;
      if (termsData[index].title === "العربون غير مسترد") {
        newContent = `<span style='color: red; font-weight: bold;'>${textarea.value}</span>`;
      }
      termsData[index].content = newContent;
      
      // Update the display
      content.innerHTML = newContent;
      content.style.display = 'block';
      textarea.style.display = 'none';
      card.classList.remove('editing');
      
      // Update the hidden textarea for form submission
      document.getElementById('termsTextCards').value = getTermsAsText();
    };
      

    });

    // Form submit function
    async function submitForm() {
      alert('تم الضغط على زر الحفظ (debug)'); // للتأكد أن الوظيفة تعمل
      // التحقق من صحة البيانات
      const form = document.getElementById('contractForm');
      console.log('Form found:', form);
      console.log('Form elements:', form ? form.elements : 'No form');
      
      if (!form) {
        console.error('Form not found!');
        alert('خطأ: لم يتم العثور على النموذج');
        return;
      }
      
      const formData = new FormData(form);
      console.log('FormData entries:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }
      let data = Object.fromEntries(formData.entries());
      console.log('Form data collected:', data);
      
      // الحصول على الشروط من البطاقات
      let terms = document.getElementById('termsTextCards').value;
      console.log('Initial terms from textarea:', terms);
      
      // إذا كانت البطاقات فارغة، استخدم البيانات الأصلية
      if (!terms || terms.trim() === '') {
        console.log('Terms empty, getting from cards...');
        terms = getTermsAsText();
        console.log('Terms from cards:', terms);
        document.getElementById('termsTextCards').value = terms;
      }
      
      console.log('Final terms content:', terms);
      
      // إضافة الشروط للبيانات
      data.terms = terms;
      
      // الحصول على بيانات وسيط صاحب الزبون من القائمة المنسدلة
      const brokerSelect = document.getElementById('brokerSelect');
      console.log('Client broker select element:', brokerSelect);
      console.log('Client broker select value:', brokerSelect ? brokerSelect.value : 'No select');
      if (brokerSelect && brokerSelect.value) {
        data.brokerName = brokerSelect.value;
        data.brokerId = brokerSelect.value; // استخدام القيمة كنص للتوافق مع الكود الحالي
        console.log('Client broker data added:', { brokerName: data.brokerName, brokerId: data.brokerId });
      }

      // الحصول على بيانات وسيط صاحب الوحدة من القائمة المنسدلة
      const brokerSelectUnit = document.getElementById('brokerSelectUnit');
      console.log('Unit broker select element:', brokerSelectUnit);
      console.log('Unit broker select value:', brokerSelectUnit ? brokerSelectUnit.value : 'No select');
      if (brokerSelectUnit && brokerSelectUnit.value) {
        data.brokerNameUnit = brokerSelectUnit.value;
        console.log('Unit broker data added:', { brokerNameUnit: data.brokerNameUnit });
      }

      // الحصول على بيانات التخليص من القائمة المنسدلة
      const clearanceSelect = document.getElementById('clearanceSelect');
      console.log('Clearance select element:', clearanceSelect);
      console.log('Clearance select value:', clearanceSelect ? clearanceSelect.value : 'No select');
      if (clearanceSelect && clearanceSelect.value) {
        data.clearanceName = clearanceSelect.value;
        console.log('Clearance data added:', { clearanceName: data.clearanceName });
      }

      // التأكد من أن البيانات موجودة في FormData
      console.log('=== CHECKING FORM DATA ===');
      console.log('FormData entries before processing:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }
      
      // إضافة البيانات المفقودة من النموذج
      if (data.brokerName) {
        formData.set('brokerName', data.brokerName);
        console.log('Added brokerName to FormData:', data.brokerName);
      }
      if (data.brokerNameUnit) {
        formData.set('brokerNameUnit', data.brokerNameUnit);
        console.log('Added brokerNameUnit to FormData:', data.brokerNameUnit);
      }
      if (data.clearanceName) {
        formData.set('clearanceName', data.clearanceName);
        console.log('Added clearanceName to FormData:', data.clearanceName);
      }
      
      // إضافة الشروط من البيانات المخزنة
      const termsText = getTermsAsText();
      if (termsText && termsText.trim()) {
        formData.set('terms', termsText);
        console.log('Added terms from termsData:', termsText);
      } else {
        // إذا لم تكن هناك شروط، أضف قيمة افتراضية
        formData.set('terms', 'الشروط والأحكام القياسية');
        console.log('Added default terms');
      }
      
      // إعادة إنشاء data object من FormData المحدث
      data = Object.fromEntries(formData.entries());
      console.log('Updated data object:', data);
      
      // التحقق من الحقول المطلوبة
      const requiredFields = ['clientName', 'clientPhone', 'unitNumber', 'rentValue', 'installments', 'terms'];
      console.log('Checking required fields:', requiredFields);
      console.log('Available data fields:', Object.keys(data));
      
      const missingFields = requiredFields.filter(field => !data[field] || data[field].toString().trim() === '');
      console.log('Missing fields:', missingFields);
      
      if (missingFields.length > 0) {
        alert('يرجى ملء جميع الحقول المطلوبة:\n' + missingFields.join(', '));
        return;
      }
      
      // تحويل القيم الرقمية
      const numericFields = ['rentValue', 'installments', 'insurance', 'officeCommission', 'serviceFees', 'municipalityFile', 'municipalityDate', 'onlineFees', 'electricityFees', 'waterFees', 'representativeAttestation', 'totalCommission', 'commissionDeduction', 'attestationValueInternal', 'attestationDeduction', 'representativeCommission', 'representativeCommissionUnit', 'clearanceValue', 'officeCommissionInternal'];
      numericFields.forEach(field => {
        if (data[field]) {
          data[field] = parseFloat(data[field]) || 0;
        }
      });
      
      console.log('Sending data:', data);
      
      // إظهار رسالة تحميل
      const saveBtn = document.getElementById('saveBtn');
      console.log('Save button found:', saveBtn);
      console.log('Save button text:', saveBtn ? saveBtn.textContent : 'No button');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'جاري الحفظ...';
      saveBtn.disabled = true;
      
      try {
        // Check if we're editing or creating
        const editId = form.dataset.editId;
        const url = editId ? `/api/contract/${editId}` : '/api/contract';
        const method = editId ? 'PUT' : 'POST';
        
        console.log('Sending request to:', url);
        console.log('Request method:', method);
        console.log('Request data:', data);
        
        let res;
        if (method === 'POST') {
          // إرسال البيانات مع الملفات
          const formData = new FormData();
          
          // إضافة البيانات النصية
          Object.keys(data).forEach(key => {
            formData.append(key, data[key]);
          });
          
          // إضافة الملفات
          const fileInputs = form.querySelectorAll('input[type="file"]');
          fileInputs.forEach(input => {
            if (input.files && input.files.length > 0) {
              for (let i = 0; i < input.files.length; i++) {
                formData.append(input.name, input.files[i]);
              }
            }
          });
          
          // إضافة token المصادقة - استخدام query parameter
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          const token = user.id;
          
          // التحقق من وجود معرف المستخدم
          if (!token) {
            alert('خطأ: معرف المستخدم مطلوب. يرجى تسجيل الدخول مرة أخرى.');
            return;
          }
          
          res = await fetch(`${url}?token=${token}`, {
            method: method,
            body: formData
          });
        } else {
          // للتحديث، إرسال JSON
          // إضافة token المصادقة - استخدام query parameter
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          const token = user.id;
          
          // التحقق من وجود معرف المستخدم
          if (!token) {
            alert('خطأ: معرف المستخدم مطلوب. يرجى تسجيل الدخول مرة أخرى.');
            return;
          }
          
          res = await fetch(`${url}?token=${token}`, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        if (res.ok) {
          const result = await res.json();
          console.log('=== SUCCESS ===');
          console.log('Success result:', result);
          
          alert('تم حفظ العقد بنجاح!');
          
          // إعادة توجيه إلى صفحة العقود
          window.location.href = '/view-contracts';
          
          // إذا تم اختيار وسيط من القائمة، أضف معاملة تلقائياً (فقط عند إنشاء عقد جديد)
          if (data.brokerName && data.brokerName.trim() !== '' && !editId) {
            try {
              const brokerTransaction = {
                broker_id: null, // سنستخدم اسم الوسيط بدلاً من ID
                contract_number: data.contractNumber || `CON-${result.id}`,
                client_name: data.clientName,
                unit_number: data.unitNumber,
                rent_value: parseFloat(data.rentValue) || 0,
                commission_amount: parseFloat(data.commissionAmount) || 0,
                total_commission: parseFloat(data.totalCommission) || 0,
                commission_deduction: parseFloat(data.commissionDeduction) || 0,
                attestation_value: parseFloat(data.attestationValueInternal) || 0,
                attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                representative_commission: parseFloat(data.representativeCommission) || 0,
                office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                transaction_date: new Date().toISOString().split('T')[0],
                notes: `عقد إيجار - ${data.clientName} - الوحدة: ${data.unitNumber}`
              };
              
              const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(brokerTransaction)
              });
              
              if (transactionRes.ok) {
                console.log('Broker transaction added successfully');
                // إضافة إشعار للمستخدم
                alert(`تم إضافة معاملة للوسيط "${data.brokerName}" تلقائياً في نظام الوسطاء`);
              } else {
                console.error('Failed to add broker transaction');
              }
            } catch (transactionError) {
              console.error('Error adding broker transaction:', transactionError);
            }
          }
          
          // إذا تم إدخال اسم الوسيط يدوياً (بدون اختيار من القائمة)، أضف معاملة تلقائياً
          if (data.brokerName && data.brokerName.trim() !== '' && !editId) {
            try {
              const brokerTransaction = {
                broker_id: null, // لا يوجد broker_id لأن الوسيط تم إدخاله يدوياً
                contract_number: data.contractNumber || `CON-${result.id}`,
                client_name: data.clientName,
                unit_number: data.unitNumber,
                rent_value: parseFloat(data.rentValue) || 0,
                commission_amount: parseFloat(data.commissionAmount) || 0,
                total_commission: parseFloat(data.totalCommission) || 0,
                commission_deduction: parseFloat(data.commissionDeduction) || 0,
                attestation_value: parseFloat(data.attestationValueInternal) || 0,
                attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                representative_commission: parseFloat(data.representativeCommission) || 0,
                office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                transaction_date: new Date().toISOString().split('T')[0],
                notes: `عقد إيجار - ${data.clientName} - الوحدة: ${data.unitNumber} - الوسيط: ${data.brokerName}`
              };
              
              const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(brokerTransaction)
              });
              
              if (transactionRes.ok) {
                console.log('Broker transaction added for manual broker name');
                alert(`تم إضافة معاملة للوسيط "${data.brokerName}" تلقائياً في نظام الوسطاء`);
              } else {
                console.error('Failed to add broker transaction for manual broker name');
              }
            } catch (transactionError) {
              console.error('Error adding broker transaction for manual broker name:', transactionError);
            }
          }
          
          if (editId) {
            // إذا تم تحديث العقد وتم اختيار وسيط جديد، أضف معاملة
            if (data.brokerName && data.brokerName.trim() !== '') {
              try {
                const brokerTransaction = {
                  broker_id: null, // سنستخدم اسم الوسيط بدلاً من ID
                  contract_number: data.contractNumber || `CON-${editId}`,
                  client_name: data.clientName,
                  unit_number: data.unitNumber,
                  rent_value: parseFloat(data.rentValue) || 0,
                  commission_amount: parseFloat(data.commissionAmount) || 0,
                  total_commission: parseFloat(data.totalCommission) || 0,
                  commission_deduction: parseFloat(data.commissionDeduction) || 0,
                  attestation_value: parseFloat(data.attestationValueInternal) || 0,
                  attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                  representative_commission: parseFloat(data.representativeCommission) || 0,
                  office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                  transaction_date: new Date().toISOString().split('T')[0],
                  notes: `تحديث عقد إيجار - ${data.clientName} - الوحدة: ${data.unitNumber}`
                };
                
                const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(brokerTransaction)
                });
                
                if (transactionRes.ok) {
                  console.log('Broker transaction added for updated contract');
                  alert(`تم تحديث العقد بنجاح!\nتم إضافة معاملة للوسيط "${data.brokerName}" تلقائياً في نظام الوسطاء`);
                } else {
                  console.error('Failed to add broker transaction for updated contract');
                  alert('تم تحديث العقد بنجاح!');
                }
              } catch (transactionError) {
                console.error('Error adding broker transaction for updated contract:', transactionError);
                alert('تم تحديث العقد بنجاح!');
              }
            } else if (data.brokerName && data.brokerName.trim() !== '') {
              // إذا تم إدخال اسم الوسيط يدوياً عند التحديث
              try {
                const brokerTransaction = {
                  broker_id: null, // لا يوجد broker_id لأن الوسيط تم إدخاله يدوياً
                  contract_number: data.contractNumber || `CON-${editId}`,
                  client_name: data.clientName,
                  unit_number: data.unitNumber,
                  rent_value: parseFloat(data.rentValue) || 0,
                  commission_amount: parseFloat(data.commissionAmount) || 0,
                  total_commission: parseFloat(data.totalCommission) || 0,
                  commission_deduction: parseFloat(data.commissionDeduction) || 0,
                  attestation_value: parseFloat(data.attestationValueInternal) || 0,
                  attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                  representative_commission: parseFloat(data.representativeCommission) || 0,
                  office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                  transaction_date: new Date().toISOString().split('T')[0],
                  notes: `تحديث عقد إيجار - ${data.clientName} - الوحدة: ${data.unitNumber} - الوسيط: ${data.brokerName}`
                };
                
                const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(brokerTransaction)
                });
                
                if (transactionRes.ok) {
                  console.log('Broker transaction added for manual broker name in update');
                  alert(`تم تحديث العقد بنجاح!\nتم إضافة معاملة للوسيط "${data.brokerName}" تلقائياً في نظام الوسطاء`);
                } else {
                  console.error('Failed to add broker transaction for manual broker name in update');
                  alert('تم تحديث العقد بنجاح!');
                }
              } catch (transactionError) {
                console.error('Error adding broker transaction for manual broker name in update:', transactionError);
                alert('تم تحديث العقد بنجاح!');
              }
            } else {
              alert('تم تحديث العقد بنجاح!');
            }
            // Redirect back to view contracts page
            window.location.href = '/view-contracts';
          } else {
            console.log('Showing success alert for new contract');
            alert(`تم حفظ العقد بنجاح!\nرقم العقد: ${result.contract_number}\nتاريخ الإنشاء: ${result.created_at}`);
          }
          
          // مسح النموذج بدلاً من إعادة تحميل الصفحة (فقط إذا لم يكن تعديل)
          if (!editId) {
            console.log('Resetting form for new contract');
            document.getElementById('contractForm').reset();
            document.getElementById('termsTextCards').value = getTermsAsText();
            currentContractTab = 0;
            showContractTab(0);
            renderCards(); // إعادة عرض البطاقات
            // إعادة تحميل الوسطاء
            loadBrokers();
          }
          
        } else {
          console.error('Response not OK. Status:', res.status);
          // إظهار نص الخطأ البرمجي بالكامل للمستخدم
          const errorText = await res.text();
          console.error('Error response:', errorText);
          
          let errorMessage = 'حدث خطأ في حفظ العقد';
          try {
            const errorData = JSON.parse(errorText);
            errorMessage = errorData.error || errorMessage;
          } catch (e) {
            console.log('Could not parse error response as JSON');
            errorMessage = errorText || errorMessage;
          }
          
          alert('خطأ في حفظ العقد: ' + errorMessage);
        }
      } catch (error) {
        console.error('=== NETWORK ERROR ===');
        console.error('Network error:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        alert('حدث خطأ في الاتصال بالخادم (network):\n' + (error.message || error));
      } finally {
        // إعادة تفعيل الزر
        console.log('Re-enabling save button');
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
      console.log('=== SUBMITFORM FUNCTION ENDED ===');
    };
    
    console.log('=== CONTRACTS.JS LOADED ===');
    
    // Form submit handler - using DOMContentLoaded to ensure form exists
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOM CONTENT LOADED ===');
      const form = document.getElementById('contractForm');
      console.log('Form found on DOM ready:', form);
      
      if (form) {
        form.onsubmit = function(e) {
          console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
          console.log('Event:', e);
          console.log('Form:', this);
          e.preventDefault();
          
          // --- تحسين: الانتقال تلقائياً للتبويب الذي فيه الحقل الناقص ---
          const requiredFields = ['clientName', 'clientPhone', 'unitNumber', 'rentValue', 'installments'];
          const fieldTabMap = {
            clientName: 0, clientPhone: 0, clientEmail: 0,
            unitNumber: 1, rentValue: 1, installments: 1, insurance: 1, officeCommission: 1, serviceFees: 1,
            municipalityFile: 2, municipalityDate: 2, onlineFees: 2, electricityFees: 2, waterFees: 2, municipalityNotes: 2,
            terms: 3,
            brokerName: 4, totalCommission: 4, commissionDeduction: 4, attestationValueInternal: 4, attestationDeduction: 4, representativeCommission: 4, representativeAttestation: 4, officeCommissionInternal: 4, internalNotes: 4
          };
          let missingField = null;
          for (let i = 0; i < requiredFields.length; i++) {
            const fieldName = requiredFields[i];
            const field = form.elements[fieldName];
            if (!field || !field.value || field.value.trim() === '') {
              missingField = fieldName;
              break;
            }
          }
          // التحقق من الشروط
          const termsField = document.getElementById('termsTextCards');
          if (!missingField && (!termsField || !termsField.value || termsField.value.trim() === '')) {
            missingField = 'terms';
          }
          if (missingField) {
            // انتقل للتبويب المناسب وضع focus على الحقل
            const tabIdx = fieldTabMap[missingField] || 0;
            if (typeof goToTab === 'function') {
              goToTab(tabIdx);
            }
            setTimeout(() => {
              let field = (missingField === 'terms') ? document.getElementById('termsTextCards') : form.elements[missingField];
              if (field && typeof field.focus === 'function') {
                field.focus();
              }
            }, 300);
            alert('يرجى ملء الحقل المطلوب: ' + missingField);
            return;
          }
          // --- نهاية التحسين ---
          
          console.log('All required fields are filled, calling submitForm...');
          submitForm();
          console.log('submitForm called');
          console.log('=== FORM SUBMIT EVENT ENDED ===');
        };
        console.log('Form submit handler attached successfully');
        
        // Load brokers and clearances on page load
        loadBrokers();
        loadClearances();
        
        // Initialize terms cards
        renderCards();
      } else {
        console.error('Form not found on DOM ready!');
      }
    });
    


    // Load contract for editing
    async function loadContractForEdit(contractId) {
      try {
        console.log('Loading contract for edit:', contractId);
        
        // إضافة token المصادقة - استخدام query parameter
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;

        const response = await fetch(`/api/contract/${contractId}?token=${token}`, {
          method: 'GET'
        });
        
        if (!response.ok) {
          throw new Error('فشل في جلب بيانات العقد');
        }
        
        const contract = await response.json();
        console.log('Contract data loaded:', contract);
        
        // Fill form fields with contract data
        const form = document.getElementById('contractForm');
        
        // Personal Data
        form.elements['clientName'].value = contract.client_name || '';
        form.elements['clientPhone'].value = contract.client_phone || '';
        form.elements['clientEmail'].value = contract.client_email || '';
        
        // تحميل ملاحظات المستندات
        form.elements['documentsNotes'].value = contract.documents_notes || '';
        
        // عرض المستندات المحفوظة
        displaySavedDocuments(contract);
        
        // Contract Data
        form.elements['unitNumber'].value = contract.unit_number || '';
        form.elements['rentValue'].value = contract.rent_value || '';
        form.elements['installments'].value = contract.installments || '';
        form.elements['insurance'].value = contract.insurance || '';
        form.elements['officeCommission'].value = contract.office_commission || '';
        form.elements['serviceFees'].value = contract.service_fees || '';
        
        // Municipality Data
        form.elements['municipalityFile'].value = contract.municipality_file || '';
        form.elements['municipalityDate'].value = contract.municipality_date || '';
        form.elements['onlineFees'].value = contract.online_fees || '';
        form.elements['electricityFees'].value = contract.electricity_fees || '';
        form.elements['waterFees'].value = contract.water_fees || '';
        form.elements['municipalityNotes'].value = contract.municipality_notes || '';
        
        // Internal Details
        // Set client broker name in select dropdown
        const brokerSelect = document.getElementById('brokerSelect');
        if (brokerSelect && contract.broker_name) {
          // Find the option with matching value
          const options = Array.from(brokerSelect.options);
          const matchingOption = options.find(option => option.value === contract.broker_name);
          if (matchingOption) {
            brokerSelect.value = contract.broker_name;
          } else {
            // If broker not in list, add it as a new option
            const newOption = document.createElement('option');
            newOption.value = contract.broker_name;
            newOption.textContent = contract.broker_name;
            brokerSelect.appendChild(newOption);
            brokerSelect.value = contract.broker_name;
          }
        }

        // Set unit broker name in select dropdown
        const brokerSelectUnit = document.getElementById('brokerSelectUnit');
        if (brokerSelectUnit && contract.broker_name_unit) {
          // Find the option with matching value
          const options = Array.from(brokerSelectUnit.options);
          const matchingOption = options.find(option => option.value === contract.broker_name_unit);
          if (matchingOption) {
            brokerSelectUnit.value = contract.broker_name_unit;
          } else {
            // If broker not in list, add it as a new option
            const newOption = document.createElement('option');
            newOption.value = contract.broker_name_unit;
            newOption.textContent = contract.broker_name_unit;
            brokerSelectUnit.appendChild(newOption);
            brokerSelectUnit.value = contract.broker_name_unit;
          }
        }

        // Set clearance name in select dropdown
        const clearanceSelect = document.getElementById('clearanceSelect');
        if (clearanceSelect && contract.clearance_name) {
          // Find the option with matching value
          const options = Array.from(clearanceSelect.options);
          const matchingOption = options.find(option => option.value === contract.clearance_name);
          if (matchingOption) {
            clearanceSelect.value = contract.clearance_name;
          } else {
            // If clearance broker not in list, add it as a new option
            const newOption = document.createElement('option');
            newOption.value = contract.clearance_name;
            newOption.textContent = contract.clearance_name;
            clearanceSelect.appendChild(newOption);
            clearanceSelect.value = contract.clearance_name;
          }
        }
        form.elements['totalCommission'].value = contract.total_commission || '';
        form.elements['commissionDeduction'].value = contract.commission_deduction || '';
        form.elements['attestationValueInternal'].value = contract.attestation_value || '';
        form.elements['attestationDeduction'].value = contract.attestation_deduction || '';
        form.elements['representativeCommission'].value = contract.representative_commission || '';
        form.elements['representativeCommissionUnit'].value = contract.representative_commission_unit || '';
        form.elements['clearanceValue'].value = contract.clearance_value || '';
        form.elements['representativeAttestation'].value = contract.representative_attestation || '';
        form.elements['officeCommissionInternal'].value = contract.office_commission_internal || '';
        form.elements['internalNotes'].value = contract.internal_notes || '';
        
        // Terms
        if (contract.terms) {
          document.getElementById('termsTextCards').value = contract.terms;
          // Update terms cards display
          updateTermsDisplay(contract.terms);
        }
        

        
        // Store contract ID for update
        form.dataset.editId = contractId;
        
        // Update page title and button
        const titleElement = document.querySelector('h2');
        if (titleElement) {
          titleElement.textContent = 'تعديل العقد';
        }
        const saveBtn = document.querySelector('button[type="submit"]');
        if (saveBtn) {
          saveBtn.textContent = 'حفظ التعديلات';
        }
        
        console.log('Contract form filled successfully');
        
      } catch (error) {
        console.error('Error loading contract for edit:', error);
        alert('حدث خطأ في تحميل بيانات العقد للتعديل');
      }
    }
    
    // Update terms display with loaded terms
    function updateTermsDisplay(termsText) {
      // Parse terms and update cards
      const termsLines = termsText.split('\n').filter(line => line.trim());
      const updatedTermsData = [];
      
      for (let i = 0; i < termsLines.length; i += 2) {
        if (i + 1 < termsLines.length) {
          const title = termsLines[i].replace(/^\d+\.\s*/, '');
          let content = termsLines[i + 1];
          
          // إضافة HTML للبند الخاص بالعربون
          if (title === "العربون غير مسترد") {
            content = `<span style='color: red; font-weight: bold;'>${content}</span>`;
          }
          
          updatedTermsData.push({
            title: title,
            content: content
          });
        }
      }
      
      if (updatedTermsData.length > 0) {
        // Update global termsData
        window.termsData = updatedTermsData;
        renderCards();
      }
    }

    // إدارة المستندات المرفقة
    function handleDocumentUpload() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      const documentsList = document.getElementById('documentsList');
      const uploadedDocuments = document.getElementById('uploadedDocuments');
      
      let uploadedFiles = [];
      
      fileInputs.forEach(input => {
        if (input.files && input.files.length > 0) {
          for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            const fileType = getFileTypeIcon(file.type);
            uploadedFiles.push({
              name: file.name,
              size: formatFileSize(file.size),
              type: fileType,
              inputName: input.name
            });
          }
        }
      });
      
      if (uploadedFiles.length > 0) {
        documentsList.innerHTML = uploadedFiles.map(file => `
          <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <div>
              <i class="${file.type}"></i>
              <span class="ms-2">${file.name}</span>
              <small class="text-muted">(${file.size})</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDocument('${file.inputName}', '${file.name}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `).join('');
        uploadedDocuments.style.display = 'block';
      } else {
        uploadedDocuments.style.display = 'none';
      }
    }
    
    // تحديد أيقونة نوع الملف
    function getFileTypeIcon(mimeType) {
      if (mimeType.includes('pdf')) return 'fas fa-file-pdf text-danger';
      if (mimeType.includes('image')) return 'fas fa-file-image text-success';
      if (mimeType.includes('word')) return 'fas fa-file-word text-primary';
      if (mimeType.includes('excel')) return 'fas fa-file-excel text-success';
      return 'fas fa-file text-secondary';
    }
    
    // تنسيق حجم الملف
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // إزالة مستند
    function removeDocument(inputName, fileName) {
      const input = document.querySelector(`input[name="${inputName}"]`);
      if (input) {
        input.value = '';
        handleDocumentUpload(); // تحديث القائمة
      }
    }
    
    // إضافة مستمعي الأحداث للملفات
    document.addEventListener('DOMContentLoaded', function() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('change', handleDocumentUpload);
      });
    });
    
    // عرض المستندات المحفوظة
    function displaySavedDocuments(contract) {
      const documentsList = document.getElementById('documentsList');
      const uploadedDocuments = document.getElementById('uploadedDocuments');
      
      let savedFiles = [];
      
      // إضافة المستندات المحفوظة
      if (contract.identity_document) {
        savedFiles.push({
          name: 'الهوية الشخصية',
          filename: contract.identity_document,
          type: 'fas fa-id-card text-primary'
        });
      }
      if (contract.passport_document) {
        savedFiles.push({
          name: 'جواز السفر',
          filename: contract.passport_document,
          type: 'fas fa-passport text-success'
        });
      }
      if (contract.address_document) {
        savedFiles.push({
          name: 'إثبات العنوان',
          filename: contract.address_document,
          type: 'fas fa-map-marker-alt text-warning'
        });
      }
      if (contract.income_document) {
        savedFiles.push({
          name: 'إثبات الدخل',
          filename: contract.income_document,
          type: 'fas fa-money-bill-wave text-success'
        });
      }
      if (contract.additional_documents) {
        const additionalDocs = contract.additional_documents.split(',');
        additionalDocs.forEach((doc, index) => {
          savedFiles.push({
            name: `مستند إضافي ${index + 1}`,
            filename: doc,
            type: 'fas fa-file-alt text-secondary'
          });
        });
      }
      
      if (savedFiles.length > 0) {
        documentsList.innerHTML = savedFiles.map(file => `
          <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <div>
              <i class="${file.type}"></i>
              <span class="ms-2">${file.name}</span>
              <small class="text-muted">(${file.filename})</small>
            </div>
            <div>
              <a href="/uploads/${file.filename}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                <i class="fas fa-eye"></i>
              </a>
              <a href="/uploads/${file.filename}" download class="btn btn-sm btn-outline-success">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
        `).join('');
        uploadedDocuments.style.display = 'block';
      }
    }
    
    console.log('=== CONTRACTS.HTML SCRIPT ENDED ===');

    // دالة للحصول على token المستخدم
    function getToken() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      return user.id || '';
    }

    // Broker and Clearance Management Functions
    async function loadBrokers() {
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`);
        if (response.ok) {
          const brokers = await response.json();
          populateBrokerSelect(brokers);
        } else {
          console.error('Failed to load brokers');
        }
      } catch (error) {
        console.error('Error loading brokers:', error);
      }
    }

    async function loadClearances() {
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`);
        if (response.ok) {
          const brokers = await response.json();
          populateClearanceSelect(brokers);
        } else {
          console.error('Failed to load brokers for clearance');
        }
      } catch (error) {
        console.error('Error loading brokers for clearance:', error);
      }
    }

    function populateBrokerSelect(brokers) {
      const brokerSelect = document.getElementById('brokerSelect');
      const brokerSelectUnit = document.getElementById('brokerSelectUnit');
      
      // Clear existing options except the first one
      brokerSelect.innerHTML = '<option value="">اختر وسيط صاحب الزبون</option>';
      brokerSelectUnit.innerHTML = '<option value="">اختر وسيط صاحب الوحدة</option>';
      
      brokers.forEach(broker => {
        const option1 = document.createElement('option');
        option1.value = broker.name;
        option1.textContent = broker.name;
        brokerSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = broker.name;
        option2.textContent = broker.name;
        brokerSelectUnit.appendChild(option2);
      });
    }

    function populateClearanceSelect(brokers) {
      const clearanceSelect = document.getElementById('clearanceSelect');
      clearanceSelect.innerHTML = '<option value="">اختر وسيط التخليص</option>';
      
      brokers.forEach(broker => {
        const option = document.createElement('option');
        option.value = broker.name;
        option.textContent = broker.name;
        clearanceSelect.appendChild(option);
      });
    }

    function openAddBrokerModal() {
      const modal = new bootstrap.Modal(document.getElementById('addBrokerModal'));
      modal.show();
    }

    function openAddBrokerModalUnit() {
      const modal = new bootstrap.Modal(document.getElementById('addBrokerModalUnit'));
      modal.show();
    }

    async function addNewBroker() {
      const name = document.getElementById('newBrokerName').value.trim();
      const phone = document.getElementById('newBrokerPhone').value.trim();
      const email = document.getElementById('newBrokerEmail').value.trim();
      
      if (!name) {
        alert('يرجى إدخال اسم الوسيط');
        return;
      }
      
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, phone, email })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            alert('تم إضافة الوسيط بنجاح');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBrokerModal'));
            modal.hide();
            // Reload brokers
            loadBrokers();
            // Clear form
            document.getElementById('addBrokerForm').reset();
          } else {
            alert('فشل في إضافة الوسيط: ' + result.message);
          }
        } else {
          alert('فشل في إضافة الوسيط');
        }
      } catch (error) {
        console.error('Error adding broker:', error);
        alert('حدث خطأ أثناء إضافة الوسيط');
      }
    }

    async function addNewBrokerUnit() {
      const name = document.getElementById('newBrokerNameUnit').value.trim();
      const phone = document.getElementById('newBrokerPhoneUnit').value.trim();
      const email = document.getElementById('newBrokerEmailUnit').value.trim();
      
      if (!name) {
        alert('يرجى إدخال اسم الوسيط');
        return;
      }
      
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, phone, email })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            alert('تم إضافة الوسيط بنجاح');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBrokerModalUnit'));
            modal.hide();
            // Reload brokers
            loadBrokers();
            // Clear form
            document.getElementById('addBrokerFormUnit').reset();
          } else {
            alert('فشل في إضافة الوسيط: ' + result.message);
          }
        } else {
          alert('فشل في إضافة الوسيط');
        }
      } catch (error) {
        console.error('Error adding broker:', error);
        alert('حدث خطأ أثناء إضافة الوسيط');
      }
    }
    
    console.log('=== CONTRACTS.HTML SCRIPT ENDED ===');
  </script>
</body>
</html> 