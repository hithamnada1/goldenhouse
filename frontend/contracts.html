<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± - Ø¬ÙˆÙ„Ø¯Ù† Ù‡ÙˆØ³ Ù„Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body { background: #f8f9fa; }
    .header {
      background: linear-gradient(135deg, #23272f 0%, #181c22 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
    }
    .form-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 2rem;
    }
    .nav-tabs .nav-link {
      color: #6c757d;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: bold;
    }
    .nav-tabs .nav-link.active {
      color: #bfa046;
      border-bottom: 3px solid #bfa046;
      background: none;
    }
    textarea {
      min-height: 1000px;
      font-size: 14px;
      line-height: 1.6;
      resize: vertical;
    }
    
    .terms-card {
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      min-height: 200px;
    }
    
    .terms-card:hover {
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      transform: translateY(-3px);
      border-color: #bfa046;
    }
    
    .terms-card.editing {
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0,123,255,0.25);
    }
    
    .terms-card h6 {
      color: #bfa046;
      margin-bottom: 1rem;
      font-weight: bold;
      font-size: 1.1rem;
      border-bottom: 2px solid #f8f9fa;
      padding-bottom: 0.5rem;
    }
    
    .terms-card .content {
      min-height: 120px;
      line-height: 1.6;
    }
    
    .terms-card .edit-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #bfa046;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .terms-card:hover .edit-btn {
      opacity: 1;
    }
    
    .terms-card .save-btn {
      background: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.75rem;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      display: none;
    }
    
    .terms-card.editing .save-btn {
      display: inline-block;
    }
    
    .terms-display {
      transition: all 0.3s ease;
    }
    
    #numberedTerms li {
      margin-bottom: 1rem;
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #bfa046;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="mb-0">
            <img src="images/logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" style="height: 50px; margin-left: 15px; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
<span style="display:none; font-size: 1.5em; margin-left: 15px;">ğŸ </span>
            Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±
          </h1>
        </div>
        <div class="col-md-4 text-end">
          <a href="/" class="btn btn-outline-light">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="form-container">
      <form id="contractForm">
        <!-- Main Tabs -->
        <ul class="nav nav-tabs mb-4" id="contractTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="add-contract-tab" data-bs-toggle="tab" data-bs-target="#add-contract" type="button" role="tab">
              Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯
            </button>
          </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="contractTabsContent">
          <!-- Add Contract Tab -->
          <div class="tab-pane fade show active" id="add-contract" role="tabpanel">
            <!-- Contract Sub-tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" type="button" role="tab" onclick="goToTab(0)">
                  Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="contract-tab" type="button" role="tab" onclick="goToTab(1)">
                  Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="municipality-tab" type="button" role="tab" onclick="goToTab(2)">
                  Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="terms-tab" type="button" role="tab" onclick="goToTab(3)">
                  Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="internal-tab" type="button" role="tab" onclick="goToTab(4)">
                  ØªÙØ§ØµÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠØ©
                </button>
              </li>
            </ul>

            <!-- Contract Sub-tab Content -->
            <div class="tab-content" id="contractSubTabsContent">
              <!-- Personal Data Tab -->
              <div class="tab-pane fade show active" id="personal" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input type="text" class="form-control" name="clientName">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                  <input type="text" class="form-control" name="clientPhone">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                  <input type="email" class="form-control" name="clientEmail">
                </div>
                
                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª -->
                <div class="mb-3">
                  <label class="form-label">
                    <i class="fas fa-file-upload"></i>
                    Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                  </label>
                  <div class="border rounded p-3 bg-light">
                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
                        <input type="file" class="form-control form-control-sm" name="identityDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</label>
                        <input type="file" class="form-control form-control-sm" name="passportDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="file" class="form-control form-control-sm" name="addressDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯Ø®Ù„</label>
                        <input type="file" class="form-control form-control-sm" name="incomeDocument" accept=".pdf,.jpg,.jpeg,.png">
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                        <input type="file" class="form-control form-control-sm" name="additionalDocuments" accept=".pdf,.jpg,.jpeg,.png" multiple>
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</label>
                        <textarea class="form-control form-control-sm" name="documentsNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©" rows="2"></textarea>
                      </div>
                    </div>
                    
                    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø© -->
                    <div id="uploadedDocuments" class="mt-3" style="display: none;">
                      <h6 class="text-primary">Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©:</h6>
                      <div id="documentsList" class="small">
                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-primary" onclick="nextTab()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
              </div>

              <!-- Contract Data Tab -->
              <div class="tab-pane fade" id="contract" role="tabpanel">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                  <input type="text" class="form-control" name="unitNumber">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</label>
                  <input type="number" class="form-control" name="rentValue">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª</label>
                  <input type="number" class="form-control" name="installments">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†</label>
                  <input type="number" class="form-control" name="insurance">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…ÙƒØªØ¨</label>
                  <input type="number" class="form-control" name="officeCommission">
                </div>
                <div class="mb-3">
                  <label class="form-label">Service Fees</label>
                  <input type="number" class="form-control" name="serviceFees" placeholder="Enter service fees">
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                  <button type="button" class="btn btn-primary" onclick="nextTab()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
              </div>

              <!-- Municipality Data Tab -->
              <div class="tab-pane fade" id="municipality" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">Ø±Ø³ÙˆÙ… Ø§Ù„ØªØµØ¯ÙŠÙ‚</label>
                  <input type="number" class="form-control" name="municipalityFile" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„ØªØµØ¯ÙŠÙ‚">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø±Ø³ÙˆÙ… Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ</label>
                  <input type="number" class="form-control" name="municipalityDate" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø±Ø³ÙˆÙ… Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</label>
                  <input type="number" class="form-control" name="onlineFees" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø±Ø³ÙˆÙ… Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</label>
                  <input type="number" class="form-control" name="electricityFees" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ø±Ø³ÙˆÙ… Ø£Ø®Ø±Ù‰</label>
                  <input type="number" class="form-control" name="waterFees" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³ÙˆÙ… Ø£Ø®Ø±Ù‰">
                </div>
                <div class="mb-3">
                  <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                  <textarea class="form-control" name="municipalityNotes" placeholder="Ø£Ø¯Ø®Ù„ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                  <button type="button" class="btn btn-primary" onclick="nextTab()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
              </div>

              <!-- Terms and Conditions Tab -->
              <div class="tab-pane fade" id="terms" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… - Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„</label>
                  <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø£ÙŠ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ· Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                  </div>
                </div>
                
                <!-- Cards Display -->
                <div id="termsCardsContainer" class="terms-display">
                  <div class="row" id="termsCards">
                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                  </div>
                  <textarea class="form-control mt-3" name="terms" id="termsTextCards" style="display: none;"></textarea>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                  <button type="button" class="btn btn-primary" onclick="nextTab()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                </div>
              </div>

              <!-- Internal Details Tab -->
              <div class="tab-pane fade" id="internal-details" role="tabpanel">
                <div class="mb-3">
                  <label class="form-label">ØªÙØ§ØµÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠØ©</label>
                  <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ù‡ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user"></i>
                        ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†
                      </label>
                      <div class="input-group">
                        <select class="form-control" name="brokerName" id="brokerSelect">
                          <option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="openAddBrokerModal()">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user-tie"></i>
                        ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø©
                      </label>
                      <div class="input-group">
                        <select class="form-control" name="brokerNameUnit" id="brokerSelectUnit">
                          <option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø©</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="openAddBrokerModal()">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</label>
                      <input type="number" class="form-control" name="totalCommission" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label>
                      <input type="number" class="form-control" name="commissionDeduction" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØµØ¯ÙŠÙ‚Ø§Øª</label>
                      <input type="number" class="form-control" name="attestationValueInternal" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-stamp"></i>
                        Ø§Ù„ØªØµØ¯ÙŠÙ‚Ø§Øª Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨
                      </label>
                      <input type="number" class="form-control" name="representativeAttestation" placeholder="0.00" min="0" step="0.01">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Ø§Ù„Ø®Ø§Ø±Ø¬ Ù…Ù† Ø§Ù„ØªØµØ¯ÙŠÙ‚Ø§Øª</label>
                      <input type="number" class="form-control" name="attestationDeduction" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user"></i>
                        Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ØµØ§Ø­Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†
                      </label>
                      <input type="number" class="form-control" name="representativeCommission" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-user-tie"></i>
                        Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ ØµØ§Ø­Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø©
                      </label>
                      <input type="number" class="form-control" name="representativeCommissionUnit" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-file-contract"></i>
                        Ø§Ù„ØªØ®Ù„ÙŠØµ
                      </label>
                      <div class="input-group">
                        <select class="form-control" name="clearanceName" id="clearanceSelect">
                          <option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠØ· Ø§Ù„ØªØ®Ù„ÙŠØµ</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" onclick="openAddBrokerModal()">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">
                        <i class="fas fa-money-bill-wave"></i>
                        Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ®Ù„ÙŠØµ
                      </label>
                      <input type="number" class="form-control" name="clearanceValue" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…ÙƒØªØ¨</label>
                      <input type="number" class="form-control" name="officeCommissionInternal" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                      <textarea class="form-control" name="internalNotes" rows="4" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-secondary" onclick="prevTab()">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                  <button type="submit" class="btn btn-success">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
          <div>
            <a href="/" class="btn btn-outline-secondary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
          </div>
          <div>
            <button type="button" class="btn btn-success" id="saveBtn" onclick="console.log('Save button clicked!'); document.getElementById('contractForm').dispatchEvent(new Event('submit'));">Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Broker Modal -->
<div class="modal fade" id="addBrokerModal" tabindex="-1" aria-labelledby="addBrokerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBrokerModalLabel">
          <i class="fas fa-user-plus"></i>
          Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠØ· Ø¬Ø¯ÙŠØ¯
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addBrokerForm">
          <div class="mb-3">
            <label for="newBrokerName" class="form-label">Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ·</label>
            <input type="text" class="form-control" id="newBrokerName" required>
          </div>
          <div class="mb-3">
            <label for="newBrokerPhone" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" class="form-control" id="newBrokerPhone">
          </div>
          <div class="mb-3">
            <label for="newBrokerEmail" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" class="form-control" id="newBrokerEmail">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-primary" onclick="addNewBroker()">
          <i class="fas fa-save"></i>
          Ø­ÙØ¸ Ø§Ù„ÙˆØ³ÙŠØ·
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate Modal for Unit Broker -->
<div class="modal fade" id="addBrokerModalUnit" tabindex="-1" aria-labelledby="addBrokerModalUnitLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addBrokerModalUnitLabel">
          <i class="fas fa-user-plus"></i>
          Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠØ· Ø¬Ø¯ÙŠØ¯ (ØµØ§Ø­Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø©)
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addBrokerFormUnit">
          <div class="mb-3">
            <label for="newBrokerNameUnit" class="form-label">Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ·</label>
            <input type="text" class="form-control" id="newBrokerNameUnit" required>
          </div>
          <div class="mb-3">
            <label for="newBrokerPhoneUnit" class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" class="form-control" id="newBrokerPhoneUnit">
          </div>
          <div class="mb-3">
            <label for="newBrokerEmailUnit" class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input type="email" class="form-control" id="newBrokerEmailUnit">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" class="btn btn-primary" onclick="addNewBrokerUnit()">
          <i class="fas fa-save"></i>
          Ø­ÙØ¸ Ø§Ù„ÙˆØ³ÙŠØ·
        </button>
      </div>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    console.log('=== CONTRACTS.HTML SCRIPT STARTED ===');
    
    // Load page when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOM CONTENT LOADED ===');
      console.log('Document ready...');
      
      // Initialize terms cards
      renderCards();
      
      // Set initial terms text
      const termsTextarea = document.getElementById('termsTextCards');
      if (termsTextarea) {
        termsTextarea.value = getTermsAsText();
      }
    });



    // Terms and conditions data
    const termsData = [
      {
        title: "Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©",
        content: "ÙŠØ¬Ø¨ Ø§Ø­Ø¶Ø§Ø± ØµÙˆØ± Ù…Ù† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªØ© ÙˆØ¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ± Ø³Ø§Ø±ÙŠØ§ Ø§Ù„Ù…ÙØ¹ÙˆÙ„ ÙˆØºÙŠØ± Ù…Ù†ØªÙ‡ÙŠÙ† Ø­Ø³Ø¨ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© ÙˆØ§Ù„ØªØ®Ø·ÙŠØ· Ù„Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯ ÙˆØ§Ù†Ù‡Ø§Ø¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯"
      },
      {
        title: "Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ØªØ¬Ø§Ù‡ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©",
        content: "Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„ Ø¹Ù† Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© Ø¹Ù† Ø§Ù„Ø¹Ù‚Ø¯ ÙˆÙÙ‰ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø§Ù‰ Ù…Ø´ÙƒÙ„Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³Ù€ØªØ£Ø¬Ø± ØªÙ…Ù†Ø¹ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¨Ù„Ø¯ÙŠØ© Ø¹Ù„Ù‰ ØªØµØ¯ÙŠÙ‚ Ø§Ù„Ø¹Ù‚Ø¯ Ø³ÙˆØ§Ø¡ Ù„Ø¯ÙŠØ© ÙˆØ­Ø¯Ù‡ Ø£Ø®Ø±Ù‰ Ø§Ùˆ Ø§Ù‰ Ø´ÙŠØ¡ Ø§Ø®Ø± ÙŠØªØ­Ù…Ù„Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙÙ‚Ø·"
      },
      {
        title: "Ø§Ù„Ø´ÙŠÙƒØ§Øª ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª",
        content: "Ø§Ø­Ø¶Ø§Ø± Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¨Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù‚Ø¯ ÙÙ‚Ø· ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø¨Ù†ÙØ³Ù‡ Ù„Ø¯ÙŠÙ†Ø§ ÙˆÙ„Ø§ ÙŠØ¬ÙˆØ² Ø§Ø­Ø¶Ø§Ø± Ø§Ù„Ø´ÙŠÙƒØ§Øª Ù…ÙˆÙ‚Ø¹Ù‡ Ù„ØªÙƒÙ…Ù„Ø© Ø£Ù‚Ø³Ø§Ø· Ø§Ù„ØªØ¹Ø§Ù‚Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø³ÙƒÙ†ÙŠØ©"
      },
      {
        title: "Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠ",
        content: "Ø§Ù„Ø³ÙƒÙ† Ø¹Ø§Ø¦Ù„Ù‰ ÙˆÙˆØ¬Ø¨ Ø§Ø­Ø¶Ø§Ø± ØµÙˆØ±Ø© Ù…Ù† Ø¹Ù‚Ø¯ Ø§Ù„Ø²ÙˆØ§Ø¬ ÙˆØ§Ù„Ø§Ø¨Ù†Ø§Ø¡"
      },
      {
        title: "Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙˆØ§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª",
        content: "Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø§ÙŠØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ ÙˆØ§Ø­Ø¶Ø§Ø± Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ø®Ø§ØµÙ‡ Ø¨ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù‚Ø¯ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ ÙˆÙ‡Ù‰ (    â€‹ ) Ø£ÙŠØ§Ù… Ù…Ù† Ø¯ÙØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ÙˆÙÙ‰ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ£Ø®Ø± Ø¹Ù† Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø§Ùˆ Ø§Ù„Ø§Ø®Ù„Ø§Ù„ Ø¨Ø£Ø­Ø¯ Ø§Ù„Ø´Ø±ÙˆØ· Ù„Ø§ ÙŠØ­Ù‚ Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© Ù…Ø¹ Ø®ØµÙ… Ù¡Ù¥ ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙŠØ¬Ø§Ø±ÙŠØ© ÙˆÙ„Ø§ ØªØªØ­Ù…Ù„ Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ø³Ø¤Ù„ÙŠØ© Ø§Ù‰ Ø£ÙˆØ±Ø§Ù‚ Ù…Ù‚Ø¯Ù…Ù‡ Ù…Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø§Ùˆ Ù…Ù†Ù‚ÙˆØµØ©"
      },
      {
        title: "Identity and Required Documents",
        content: "Photocopies of the Emirates ID card, valid passport and other copies must be brought according to the instructions of the Attendance and Registration Department for registration, signing and termination of contracts"
      },
      {
        title: "Tenant's Responsibility for Municipality",
        content: "The tenant is responsible for the municipality's approval of the contract, and if there is any problem on the part of the tenant that prevents the municipality from approving the contract, whether he has another unit or anything else, that is, it is borne by the tenant only"
      },
      {
        title: "Checks and Signatures",
        content: "Bring personal checks in the name of the contract holder only and sign the checks himself with us. It is not permissible to bring signed checks to complete the housing unit contract installments"
      },
      {
        title: "Family Housing",
        content: "You must bring family housing and a copy of the marriage and children's contract"
      },
      {
        title: "Payments and Obligations",
        content: "The customer must pay the agreed upon rental amount and bring checks belonging to the contract owner only during the agreed upon period, which is (â€‹â€‹) days after deposit payment. In the event of delay beyond the specified period or violation of one of the conditions, the commission will not be refunded, with a deduction of 15 days from the rental value. The company does not bear responsibility for any incorrect or incomplete papers submitted by the customer"
      },
      {
        title: "Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø³ØªØ±Ø¯",
        content: "<span style='color: red; font-weight: bold;'>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø³ØªØ±Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø­Ø§Ù„Ø© Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆÙ„Ø§ ÙŠØ­Ù‚ Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨Ù‡ Ù„Ø¯Ù‰ Ø£ÙŠ Ø¬Ù‡Ø© ÙˆÙ‡Ø°Ø§ Ø§ØªÙØ§Ù‚ Ù„Ø§ ÙŠØ¬ÙˆØ² Ø§Ù„Ø¹Ø¯ÙˆÙ„ Ø¹Ù†Ù‡</span>"
      }
    ];

    // Function to get terms as text
    function getTermsAsText() {
      console.log('=== GETTING TERMS AS TEXT ===');
      const text = termsData.map((term, index) => {
        // Ø¥Ø²Ø§Ù„Ø© HTML tags Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ Ø§Ù„Ù†Ù‚ÙŠ
        const cleanContent = term.content.replace(/<[^>]*>/g, '');
        return `${index + 1}- ${term.title}\n${cleanContent}`;
      }).join('\n\n');
      console.log('Terms text length:', text.length);
      return text;
    }



    // Function to render cards
    function renderCards() {
      const container = document.getElementById('termsCards');
      container.innerHTML = termsData.map((term, index) => 
        `<div class="col-md-6">
          <div class="terms-card" data-index="${index}">
            <button class="edit-btn" onclick="editTerm(${index})" title="ØªØ¹Ø¯ÙŠÙ„">
              <i class="fas fa-edit"></i>
            </button>
            <h6>${term.title}</h6>
            <div class="content" id="content-${index}">${term.content}</div>
            <textarea class="form-control mt-2" id="edit-${index}" style="display: none; min-height: 100px;">${term.content.replace(/<[^>]*>/g, '')}</textarea>
            <button class="save-btn" onclick="saveTerm(${index})">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          </div>
        </div>`
      ).join('');
    }

    // Contract form tab navigation logic
    const contractTabs = ["personal", "contract", "municipality", "terms", "internal-details"];
    let currentContractTab = 0;
    
    function showContractTab(idx) {
      console.log('showContractTab called with idx:', idx);
      
      const tabPanes = document.querySelectorAll('#contractSubTabsContent .tab-pane');
      const navLinks = document.querySelectorAll('#add-contract .nav-link');
      
      console.log('Found tab panes:', tabPanes.length);
      console.log('Found nav links:', navLinks.length);
      
      tabPanes.forEach((el, i) => {
        el.classList.remove('show', 'active');
        if (i === idx) {
          el.classList.add('show', 'active');
          console.log('Activated tab pane:', i);
        }
      });
      
      navLinks.forEach((el, i) => {
        el.classList.remove('active');
        if (i === idx) {
          el.classList.add('active');
          console.log('Activated nav link:', i);
        }
      });
    }
    
    // Navigation functions for contract tabs
    function goToTab(idx) {
      console.log('goToTab called with idx:', idx);
      currentContractTab = idx;
      showContractTab(currentContractTab);
    }
    
    function nextTab() {
      console.log('nextTab called, current tab:', currentContractTab);
      if (currentContractTab < 5) { // Updated to 5 for the new tab
        currentContractTab++;
        console.log('Moving to tab:', currentContractTab);
        showContractTab(currentContractTab);
      }
    }
    
    function prevTab() {
      console.log('prevTab called, current tab:', currentContractTab);
      if (currentContractTab > 0) {
        currentContractTab--;
        console.log('Moving to tab:', currentContractTab);
        showContractTab(currentContractTab);
      }
    }
    
    // Initialize tabs
    showContractTab(currentContractTab);

    // Initialize form when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the form
      console.log('Contract form initialized');
      

      
      // Check if we're editing a contract
      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit');
      
      if (editId) {
        console.log('Editing contract with ID:', editId);
        loadContractForEdit(editId);
      }
      
      // Initialize terms display
      renderCards();
      

    
    // Edit term function
    window.editTerm = function(index) {
      const card = document.querySelector(`[data-index="${index}"]`);
      const content = document.getElementById(`content-${index}`);
      const textarea = document.getElementById(`edit-${index}`);
      
      card.classList.add('editing');
      content.style.display = 'none';
      textarea.style.display = 'block';
      textarea.focus();
    };
    
    // Save term function
    window.saveTerm = function(index) {
      const card = document.querySelector(`[data-index="${index}"]`);
      const content = document.getElementById(`content-${index}`);
      const textarea = document.getElementById(`edit-${index}`);
      
      // Update the data - preserve HTML for special terms like the deposit clause
      let newContent = textarea.value;
      if (termsData[index].title === "Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø³ØªØ±Ø¯") {
        newContent = `<span style='color: red; font-weight: bold;'>${textarea.value}</span>`;
      }
      termsData[index].content = newContent;
      
      // Update the display
      content.innerHTML = newContent;
      content.style.display = 'block';
      textarea.style.display = 'none';
      card.classList.remove('editing');
      
      // Update the hidden textarea for form submission
      document.getElementById('termsTextCards').value = getTermsAsText();
    };
      

    });

    // Form submit function
    async function submitForm() {
      alert('ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø­ÙØ¸ (debug)'); // Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªØ¹Ù…Ù„
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const form = document.getElementById('contractForm');
      console.log('Form found:', form);
      console.log('Form elements:', form ? form.elements : 'No form');
      
      if (!form) {
        console.error('Form not found!');
        alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        return;
      }
      
      const formData = new FormData(form);
      console.log('FormData entries:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }
      let data = Object.fromEntries(formData.entries());
      console.log('Form data collected:', data);
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ù…Ù† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
      let terms = document.getElementById('termsTextCards').value;
      console.log('Initial terms from textarea:', terms);
      
      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙØ§Ø±ØºØ©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
      if (!terms || terms.trim() === '') {
        console.log('Terms empty, getting from cards...');
        terms = getTermsAsText();
        console.log('Terms from cards:', terms);
        document.getElementById('termsTextCards').value = terms;
      }
      
      console.log('Final terms content:', terms);
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙˆØ· Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      data.terms = terms;
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const brokerSelect = document.getElementById('brokerSelect');
      console.log('Client broker select element:', brokerSelect);
      console.log('Client broker select value:', brokerSelect ? brokerSelect.value : 'No select');
      if (brokerSelect && brokerSelect.value) {
        data.brokerName = brokerSelect.value;
        data.brokerId = brokerSelect.value; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© ÙƒÙ†Øµ Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
        console.log('Client broker data added:', { brokerName: data.brokerName, brokerId: data.brokerId });
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const brokerSelectUnit = document.getElementById('brokerSelectUnit');
      console.log('Unit broker select element:', brokerSelectUnit);
      console.log('Unit broker select value:', brokerSelectUnit ? brokerSelectUnit.value : 'No select');
      if (brokerSelectUnit && brokerSelectUnit.value) {
        data.brokerNameUnit = brokerSelectUnit.value;
        console.log('Unit broker data added:', { brokerNameUnit: data.brokerNameUnit });
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ®Ù„ÙŠØµ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
      const clearanceSelect = document.getElementById('clearanceSelect');
      console.log('Clearance select element:', clearanceSelect);
      console.log('Clearance select value:', clearanceSelect ? clearanceSelect.value : 'No select');
      if (clearanceSelect && clearanceSelect.value) {
        data.clearanceName = clearanceSelect.value;
        console.log('Clearance data added:', { clearanceName: data.clearanceName });
      }

      // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ FormData
      console.log('=== CHECKING FORM DATA ===');
      console.log('FormData entries before processing:');
      for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      if (data.brokerName) {
        formData.set('brokerName', data.brokerName);
        console.log('Added brokerName to FormData:', data.brokerName);
      }
      if (data.brokerNameUnit) {
        formData.set('brokerNameUnit', data.brokerNameUnit);
        console.log('Added brokerNameUnit to FormData:', data.brokerNameUnit);
      }
      if (data.clearanceName) {
        formData.set('clearanceName', data.clearanceName);
        console.log('Added clearanceName to FormData:', data.clearanceName);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙˆØ· Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
      const termsText = getTermsAsText();
      if (termsText && termsText.trim()) {
        formData.set('terms', termsText);
        console.log('Added terms from termsData:', termsText);
      } else {
        // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø´Ø±ÙˆØ·ØŒ Ø£Ø¶Ù Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        formData.set('terms', 'Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©');
        console.log('Added default terms');
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ data object Ù…Ù† FormData Ø§Ù„Ù…Ø­Ø¯Ø«
      data = Object.fromEntries(formData.entries());
      console.log('Updated data object:', data);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      const requiredFields = ['clientName', 'clientPhone', 'unitNumber', 'rentValue', 'installments', 'terms'];
      console.log('Checking required fields:', requiredFields);
      console.log('Available data fields:', Object.keys(data));
      
      const missingFields = requiredFields.filter(field => !data[field] || data[field].toString().trim() === '');
      console.log('Missing fields:', missingFields);
      
      if (missingFields.length > 0) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\n' + missingFields.join(', '));
        return;
      }
      
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
      const numericFields = ['rentValue', 'installments', 'insurance', 'officeCommission', 'serviceFees', 'municipalityFile', 'municipalityDate', 'onlineFees', 'electricityFees', 'waterFees', 'representativeAttestation', 'totalCommission', 'commissionDeduction', 'attestationValueInternal', 'attestationDeduction', 'representativeCommission', 'representativeCommissionUnit', 'clearanceValue', 'officeCommissionInternal'];
      numericFields.forEach(field => {
        if (data[field]) {
          data[field] = parseFloat(data[field]) || 0;
        }
      });
      
      console.log('Sending data:', data);
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
      const saveBtn = document.getElementById('saveBtn');
      console.log('Save button found:', saveBtn);
      console.log('Save button text:', saveBtn ? saveBtn.textContent : 'No button');
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      saveBtn.disabled = true;
      
      try {
        // Check if we're editing or creating
        const editId = form.dataset.editId;
        const url = editId ? `/api/contract/${editId}` : '/api/contract';
        const method = editId ? 'PUT' : 'POST';
        
        console.log('Sending request to:', url);
        console.log('Request method:', method);
        console.log('Request data:', data);
        
        let res;
        if (method === 'POST') {
          // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
          const formData = new FormData();
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†ØµÙŠØ©
          Object.keys(data).forEach(key => {
            formData.append(key, data[key]);
          });
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„ÙØ§Øª
          const fileInputs = form.querySelectorAll('input[type="file"]');
          fileInputs.forEach(input => {
            if (input.files && input.files.length > 0) {
              for (let i = 0; i < input.files.length; i++) {
                formData.append(input.name, input.files[i]);
              }
            }
          });
          
          // Ø¥Ø¶Ø§ÙØ© token Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… query parameter
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          const token = user.id;
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (!token) {
            alert('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            return;
          }
          
          res = await fetch(`${url}?token=${token}`, {
            method: method,
            body: formData
          });
        } else {
          // Ù„Ù„ØªØ­Ø¯ÙŠØ«ØŒ Ø¥Ø±Ø³Ø§Ù„ JSON
          // Ø¥Ø¶Ø§ÙØ© token Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… query parameter
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          const token = user.id;
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (!token) {
            alert('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            return;
          }
          
          res = await fetch(`${url}?token=${token}`, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        if (res.ok) {
          const result = await res.json();
          console.log('=== SUCCESS ===');
          console.log('Success result:', result);
          
          alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯
          window.location.href = '/view-contracts';
          
          // Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠØ· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ Ø£Ø¶Ù Ù…Ø¹Ø§Ù…Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯)
          if (data.brokerName && data.brokerName.trim() !== '' && !editId) {
            try {
              const brokerTransaction = {
                broker_id: null, // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ID
                contract_number: data.contractNumber || `CON-${result.id}`,
                client_name: data.clientName,
                unit_number: data.unitNumber,
                rent_value: parseFloat(data.rentValue) || 0,
                commission_amount: parseFloat(data.commissionAmount) || 0,
                total_commission: parseFloat(data.totalCommission) || 0,
                commission_deduction: parseFloat(data.commissionDeduction) || 0,
                attestation_value: parseFloat(data.attestationValueInternal) || 0,
                attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                representative_commission: parseFloat(data.representativeCommission) || 0,
                office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                transaction_date: new Date().toISOString().split('T')[0],
                notes: `Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± - ${data.clientName} - Ø§Ù„ÙˆØ­Ø¯Ø©: ${data.unitNumber}`
              };
              
              const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(brokerTransaction)
              });
              
              if (transactionRes.ok) {
                console.log('Broker transaction added successfully');
                // Ø¥Ø¶Ø§ÙØ© Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ù„ÙˆØ³ÙŠØ· "${data.brokerName}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ³Ø·Ø§Ø¡`);
              } else {
                console.error('Failed to add broker transaction');
              }
            } catch (transactionError) {
              console.error('Error adding broker transaction:', transactionError);
            }
          }
          
          // Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ· ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)ØŒ Ø£Ø¶Ù Ù…Ø¹Ø§Ù…Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if (data.brokerName && data.brokerName.trim() !== '' && !editId) {
            try {
              const brokerTransaction = {
                broker_id: null, // Ù„Ø§ ÙŠÙˆØ¬Ø¯ broker_id Ù„Ø£Ù† Ø§Ù„ÙˆØ³ÙŠØ· ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
                contract_number: data.contractNumber || `CON-${result.id}`,
                client_name: data.clientName,
                unit_number: data.unitNumber,
                rent_value: parseFloat(data.rentValue) || 0,
                commission_amount: parseFloat(data.commissionAmount) || 0,
                total_commission: parseFloat(data.totalCommission) || 0,
                commission_deduction: parseFloat(data.commissionDeduction) || 0,
                attestation_value: parseFloat(data.attestationValueInternal) || 0,
                attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                representative_commission: parseFloat(data.representativeCommission) || 0,
                office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                transaction_date: new Date().toISOString().split('T')[0],
                notes: `Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± - ${data.clientName} - Ø§Ù„ÙˆØ­Ø¯Ø©: ${data.unitNumber} - Ø§Ù„ÙˆØ³ÙŠØ·: ${data.brokerName}`
              };
              
              const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(brokerTransaction)
              });
              
              if (transactionRes.ok) {
                console.log('Broker transaction added for manual broker name');
                alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ù„ÙˆØ³ÙŠØ· "${data.brokerName}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ³Ø·Ø§Ø¡`);
              } else {
                console.error('Failed to add broker transaction for manual broker name');
              }
            } catch (transactionError) {
              console.error('Error adding broker transaction for manual broker name:', transactionError);
            }
          }
          
          if (editId) {
            // Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠØ· Ø¬Ø¯ÙŠØ¯ØŒ Ø£Ø¶Ù Ù…Ø¹Ø§Ù…Ù„Ø©
            if (data.brokerName && data.brokerName.trim() !== '') {
              try {
                const brokerTransaction = {
                  broker_id: null, // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ· Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ID
                  contract_number: data.contractNumber || `CON-${editId}`,
                  client_name: data.clientName,
                  unit_number: data.unitNumber,
                  rent_value: parseFloat(data.rentValue) || 0,
                  commission_amount: parseFloat(data.commissionAmount) || 0,
                  total_commission: parseFloat(data.totalCommission) || 0,
                  commission_deduction: parseFloat(data.commissionDeduction) || 0,
                  attestation_value: parseFloat(data.attestationValueInternal) || 0,
                  attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                  representative_commission: parseFloat(data.representativeCommission) || 0,
                  office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                  transaction_date: new Date().toISOString().split('T')[0],
                  notes: `ØªØ­Ø¯ÙŠØ« Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± - ${data.clientName} - Ø§Ù„ÙˆØ­Ø¯Ø©: ${data.unitNumber}`
                };
                
                const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(brokerTransaction)
                });
                
                if (transactionRes.ok) {
                  console.log('Broker transaction added for updated contract');
                  alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ù„ÙˆØ³ÙŠØ· "${data.brokerName}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ³Ø·Ø§Ø¡`);
                } else {
                  console.error('Failed to add broker transaction for updated contract');
                  alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                }
              } catch (transactionError) {
                console.error('Error adding broker transaction for updated contract:', transactionError);
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
              }
            } else if (data.brokerName && data.brokerName.trim() !== '') {
              // Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ· ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
              try {
                const brokerTransaction = {
                  broker_id: null, // Ù„Ø§ ÙŠÙˆØ¬Ø¯ broker_id Ù„Ø£Ù† Ø§Ù„ÙˆØ³ÙŠØ· ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
                  contract_number: data.contractNumber || `CON-${editId}`,
                  client_name: data.clientName,
                  unit_number: data.unitNumber,
                  rent_value: parseFloat(data.rentValue) || 0,
                  commission_amount: parseFloat(data.commissionAmount) || 0,
                  total_commission: parseFloat(data.totalCommission) || 0,
                  commission_deduction: parseFloat(data.commissionDeduction) || 0,
                  attestation_value: parseFloat(data.attestationValueInternal) || 0,
                  attestation_deduction: parseFloat(data.attestationDeduction) || 0,
                  representative_commission: parseFloat(data.representativeCommission) || 0,
                  office_commission_internal: parseFloat(data.officeCommissionInternal) || 0,
                  transaction_date: new Date().toISOString().split('T')[0],
                  notes: `ØªØ­Ø¯ÙŠØ« Ø¹Ù‚Ø¯ Ø¥ÙŠØ¬Ø§Ø± - ${data.clientName} - Ø§Ù„ÙˆØ­Ø¯Ø©: ${data.unitNumber} - Ø§Ù„ÙˆØ³ÙŠØ·: ${data.brokerName}`
                };
                
                const transactionRes = await fetch('/api/broker-transactions?token=' + token, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(brokerTransaction)
                });
                
                if (transactionRes.ok) {
                  console.log('Broker transaction added for manual broker name in update');
                  alert(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© Ù„Ù„ÙˆØ³ÙŠØ· "${data.brokerName}" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ³Ø·Ø§Ø¡`);
                } else {
                  console.error('Failed to add broker transaction for manual broker name in update');
                  alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                }
              } catch (transactionError) {
                console.error('Error adding broker transaction for manual broker name in update:', transactionError);
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
              }
            } else {
              alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
            }
            // Redirect back to view contracts page
            window.location.href = '/view-contracts';
          } else {
            console.log('Showing success alert for new contract');
            alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ù†Ø¬Ø§Ø­!\nØ±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯: ${result.contract_number}\nØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${result.created_at}`);
          }
          
          // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† ØªØ¹Ø¯ÙŠÙ„)
          if (!editId) {
            console.log('Resetting form for new contract');
            document.getElementById('contractForm').reset();
            document.getElementById('termsTextCards').value = getTermsAsText();
            currentContractTab = 0;
            showContractTab(0);
            renderCards(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ³Ø·Ø§Ø¡
            loadBrokers();
          }
          
        } else {
          console.error('Response not OK. Status:', res.status);
          // Ø¥Ø¸Ù‡Ø§Ø± Ù†Øµ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
          const errorText = await res.text();
          console.error('Error response:', errorText);
          
          let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯';
          try {
            const errorData = JSON.parse(errorText);
            errorMessage = errorData.error || errorMessage;
          } catch (e) {
            console.log('Could not parse error response as JSON');
            errorMessage = errorText || errorMessage;
          }
          
          alert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯: ' + errorMessage);
        }
      } catch (error) {
        console.error('=== NETWORK ERROR ===');
        console.error('Network error:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… (network):\n' + (error.message || error));
      } finally {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        console.log('Re-enabling save button');
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
      }
      console.log('=== SUBMITFORM FUNCTION ENDED ===');
    };
    
    console.log('=== CONTRACTS.JS LOADED ===');
    
    // Form submit handler - using DOMContentLoaded to ensure form exists
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== DOM CONTENT LOADED ===');
      const form = document.getElementById('contractForm');
      console.log('Form found on DOM ready:', form);
      
      if (form) {
        form.onsubmit = function(e) {
          console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
          console.log('Event:', e);
          console.log('Form:', this);
          e.preventDefault();
          
          // --- ØªØ­Ø³ÙŠÙ†: Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø°ÙŠ ÙÙŠÙ‡ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù†Ø§Ù‚Øµ ---
          const requiredFields = ['clientName', 'clientPhone', 'unitNumber', 'rentValue', 'installments'];
          const fieldTabMap = {
            clientName: 0, clientPhone: 0, clientEmail: 0,
            unitNumber: 1, rentValue: 1, installments: 1, insurance: 1, officeCommission: 1, serviceFees: 1,
            municipalityFile: 2, municipalityDate: 2, onlineFees: 2, electricityFees: 2, waterFees: 2, municipalityNotes: 2,
            terms: 3,
            brokerName: 4, totalCommission: 4, commissionDeduction: 4, attestationValueInternal: 4, attestationDeduction: 4, representativeCommission: 4, representativeAttestation: 4, officeCommissionInternal: 4, internalNotes: 4
          };
          let missingField = null;
          for (let i = 0; i < requiredFields.length; i++) {
            const fieldName = requiredFields[i];
            const field = form.elements[fieldName];
            if (!field || !field.value || field.value.trim() === '') {
              missingField = fieldName;
              break;
            }
          }
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙˆØ·
          const termsField = document.getElementById('termsTextCards');
          if (!missingField && (!termsField || !termsField.value || termsField.value.trim() === '')) {
            missingField = 'terms';
          }
          if (missingField) {
            // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙˆØ¶Ø¹ focus Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„
            const tabIdx = fieldTabMap[missingField] || 0;
            if (typeof goToTab === 'function') {
              goToTab(tabIdx);
            }
            setTimeout(() => {
              let field = (missingField === 'terms') ? document.getElementById('termsTextCards') : form.elements[missingField];
              if (field && typeof field.focus === 'function') {
                field.focus();
              }
            }, 300);
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ' + missingField);
            return;
          }
          // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ­Ø³ÙŠÙ† ---
          
          console.log('All required fields are filled, calling submitForm...');
          submitForm();
          console.log('submitForm called');
          console.log('=== FORM SUBMIT EVENT ENDED ===');
        };
        console.log('Form submit handler attached successfully');
        
        // Load brokers and clearances on page load
        loadBrokers();
        loadClearances();
        
        // Initialize terms cards
        renderCards();
      } else {
        console.error('Form not found on DOM ready!');
      }
    });
    


    // Load contract for editing
    async function loadContractForEdit(contractId) {
      try {
        console.log('Loading contract for edit:', contractId);
        
        // Ø¥Ø¶Ø§ÙØ© token Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ø§Ø³ØªØ®Ø¯Ø§Ù… query parameter
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        const token = user.id;

        const response = await fetch(`/api/contract/${contractId}?token=${token}`, {
          method: 'GET'
        });
        
        if (!response.ok) {
          throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯');
        }
        
        const contract = await response.json();
        console.log('Contract data loaded:', contract);
        
        // Fill form fields with contract data
        const form = document.getElementById('contractForm');
        
        // Personal Data
        form.elements['clientName'].value = contract.client_name || '';
        form.elements['clientPhone'].value = contract.client_phone || '';
        form.elements['clientEmail'].value = contract.client_email || '';
        
        // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª
        form.elements['documentsNotes'].value = contract.documents_notes || '';
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        displaySavedDocuments(contract);
        
        // Contract Data
        form.elements['unitNumber'].value = contract.unit_number || '';
        form.elements['rentValue'].value = contract.rent_value || '';
        form.elements['installments'].value = contract.installments || '';
        form.elements['insurance'].value = contract.insurance || '';
        form.elements['officeCommission'].value = contract.office_commission || '';
        form.elements['serviceFees'].value = contract.service_fees || '';
        
        // Municipality Data
        form.elements['municipalityFile'].value = contract.municipality_file || '';
        form.elements['municipalityDate'].value = contract.municipality_date || '';
        form.elements['onlineFees'].value = contract.online_fees || '';
        form.elements['electricityFees'].value = contract.electricity_fees || '';
        form.elements['waterFees'].value = contract.water_fees || '';
        form.elements['municipalityNotes'].value = contract.municipality_notes || '';
        
        // Internal Details
        // Set client broker name in select dropdown
        const brokerSelect = document.getElementById('brokerSelect');
        if (brokerSelect && contract.broker_name) {
          // Find the option with matching value
          const options = Array.from(brokerSelect.options);
          const matchingOption = options.find(option => option.value === contract.broker_name);
          if (matchingOption) {
            brokerSelect.value = contract.broker_name;
          } else {
            // If broker not in list, add it as a new option
            const newOption = document.createElement('option');
            newOption.value = contract.broker_name;
            newOption.textContent = contract.broker_name;
            brokerSelect.appendChild(newOption);
            brokerSelect.value = contract.broker_name;
          }
        }

        // Set unit broker name in select dropdown
        const brokerSelectUnit = document.getElementById('brokerSelectUnit');
        if (brokerSelectUnit && contract.broker_name_unit) {
          // Find the option with matching value
          const options = Array.from(brokerSelectUnit.options);
          const matchingOption = options.find(option => option.value === contract.broker_name_unit);
          if (matchingOption) {
            brokerSelectUnit.value = contract.broker_name_unit;
          } else {
            // If broker not in list, add it as a new option
            const newOption = document.createElement('option');
            newOption.value = contract.broker_name_unit;
            newOption.textContent = contract.broker_name_unit;
            brokerSelectUnit.appendChild(newOption);
            brokerSelectUnit.value = contract.broker_name_unit;
          }
        }

        // Set clearance name in select dropdown
        const clearanceSelect = document.getElementById('clearanceSelect');
        if (clearanceSelect && contract.clearance_name) {
          // Find the option with matching value
          const options = Array.from(clearanceSelect.options);
          const matchingOption = options.find(option => option.value === contract.clearance_name);
          if (matchingOption) {
            clearanceSelect.value = contract.clearance_name;
          } else {
            // If clearance broker not in list, add it as a new option
            const newOption = document.createElement('option');
            newOption.value = contract.clearance_name;
            newOption.textContent = contract.clearance_name;
            clearanceSelect.appendChild(newOption);
            clearanceSelect.value = contract.clearance_name;
          }
        }
        form.elements['totalCommission'].value = contract.total_commission || '';
        form.elements['commissionDeduction'].value = contract.commission_deduction || '';
        form.elements['attestationValueInternal'].value = contract.attestation_value || '';
        form.elements['attestationDeduction'].value = contract.attestation_deduction || '';
        form.elements['representativeCommission'].value = contract.representative_commission || '';
        form.elements['representativeCommissionUnit'].value = contract.representative_commission_unit || '';
        form.elements['clearanceValue'].value = contract.clearance_value || '';
        form.elements['representativeAttestation'].value = contract.representative_attestation || '';
        form.elements['officeCommissionInternal'].value = contract.office_commission_internal || '';
        form.elements['internalNotes'].value = contract.internal_notes || '';
        
        // Terms
        if (contract.terms) {
          document.getElementById('termsTextCards').value = contract.terms;
          // Update terms cards display
          updateTermsDisplay(contract.terms);
        }
        

        
        // Store contract ID for update
        form.dataset.editId = contractId;
        
        // Update page title and button
        const titleElement = document.querySelector('h2');
        if (titleElement) {
          titleElement.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯';
        }
        const saveBtn = document.querySelector('button[type="submit"]');
        if (saveBtn) {
          saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        }
        
        console.log('Contract form filled successfully');
        
      } catch (error) {
        console.error('Error loading contract for edit:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
      }
    }
    
    // Update terms display with loaded terms
    function updateTermsDisplay(termsText) {
      // Parse terms and update cards
      const termsLines = termsText.split('\n').filter(line => line.trim());
      const updatedTermsData = [];
      
      for (let i = 0; i < termsLines.length; i += 2) {
        if (i + 1 < termsLines.length) {
          const title = termsLines[i].replace(/^\d+\.\s*/, '');
          let content = termsLines[i + 1];
          
          // Ø¥Ø¶Ø§ÙØ© HTML Ù„Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†
          if (title === "Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† ØºÙŠØ± Ù…Ø³ØªØ±Ø¯") {
            content = `<span style='color: red; font-weight: bold;'>${content}</span>`;
          }
          
          updatedTermsData.push({
            title: title,
            content: content
          });
        }
      }
      
      if (updatedTermsData.length > 0) {
        // Update global termsData
        window.termsData = updatedTermsData;
        renderCards();
      }
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø±ÙÙ‚Ø©
    function handleDocumentUpload() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      const documentsList = document.getElementById('documentsList');
      const uploadedDocuments = document.getElementById('uploadedDocuments');
      
      let uploadedFiles = [];
      
      fileInputs.forEach(input => {
        if (input.files && input.files.length > 0) {
          for (let i = 0; i < input.files.length; i++) {
            const file = input.files[i];
            const fileType = getFileTypeIcon(file.type);
            uploadedFiles.push({
              name: file.name,
              size: formatFileSize(file.size),
              type: fileType,
              inputName: input.name
            });
          }
        }
      });
      
      if (uploadedFiles.length > 0) {
        documentsList.innerHTML = uploadedFiles.map(file => `
          <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <div>
              <i class="${file.type}"></i>
              <span class="ms-2">${file.name}</span>
              <small class="text-muted">(${file.size})</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeDocument('${file.inputName}', '${file.name}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `).join('');
        uploadedDocuments.style.display = 'block';
      } else {
        uploadedDocuments.style.display = 'none';
      }
    }
    
    // ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    function getFileTypeIcon(mimeType) {
      if (mimeType.includes('pdf')) return 'fas fa-file-pdf text-danger';
      if (mimeType.includes('image')) return 'fas fa-file-image text-success';
      if (mimeType.includes('word')) return 'fas fa-file-word text-primary';
      if (mimeType.includes('excel')) return 'fas fa-file-excel text-success';
      return 'fas fa-file text-secondary';
    }
    
    // ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ†Ø¯
    function removeDocument(inputName, fileName) {
      const input = document.querySelector(`input[name="${inputName}"]`);
      if (input) {
        input.value = '';
        handleDocumentUpload(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      }
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù…Ù„ÙØ§Øª
    document.addEventListener('DOMContentLoaded', function() {
      const fileInputs = document.querySelectorAll('input[type="file"]');
      fileInputs.forEach(input => {
        input.addEventListener('change', handleDocumentUpload);
      });
    });
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    function displaySavedDocuments(contract) {
      const documentsList = document.getElementById('documentsList');
      const uploadedDocuments = document.getElementById('uploadedDocuments');
      
      let savedFiles = [];
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      if (contract.identity_document) {
        savedFiles.push({
          name: 'Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©',
          filename: contract.identity_document,
          type: 'fas fa-id-card text-primary'
        });
      }
      if (contract.passport_document) {
        savedFiles.push({
          name: 'Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±',
          filename: contract.passport_document,
          type: 'fas fa-passport text-success'
        });
      }
      if (contract.address_document) {
        savedFiles.push({
          name: 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
          filename: contract.address_document,
          type: 'fas fa-map-marker-alt text-warning'
        });
      }
      if (contract.income_document) {
        savedFiles.push({
          name: 'Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯Ø®Ù„',
          filename: contract.income_document,
          type: 'fas fa-money-bill-wave text-success'
        });
      }
      if (contract.additional_documents) {
        const additionalDocs = contract.additional_documents.split(',');
        additionalDocs.forEach((doc, index) => {
          savedFiles.push({
            name: `Ù…Ø³ØªÙ†Ø¯ Ø¥Ø¶Ø§ÙÙŠ ${index + 1}`,
            filename: doc,
            type: 'fas fa-file-alt text-secondary'
          });
        });
      }
      
      if (savedFiles.length > 0) {
        documentsList.innerHTML = savedFiles.map(file => `
          <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
            <div>
              <i class="${file.type}"></i>
              <span class="ms-2">${file.name}</span>
              <small class="text-muted">(${file.filename})</small>
            </div>
            <div>
              <a href="/uploads/${file.filename}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                <i class="fas fa-eye"></i>
              </a>
              <a href="/uploads/${file.filename}" download class="btn btn-sm btn-outline-success">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
        `).join('');
        uploadedDocuments.style.display = 'block';
      }
    }
    
    console.log('=== CONTRACTS.HTML SCRIPT ENDED ===');

    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ token Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function getToken() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      return user.id || '';
    }

    // Broker and Clearance Management Functions
    async function loadBrokers() {
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`);
        if (response.ok) {
          const brokers = await response.json();
          populateBrokerSelect(brokers);
        } else {
          console.error('Failed to load brokers');
        }
      } catch (error) {
        console.error('Error loading brokers:', error);
      }
    }

    async function loadClearances() {
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`);
        if (response.ok) {
          const brokers = await response.json();
          populateClearanceSelect(brokers);
        } else {
          console.error('Failed to load brokers for clearance');
        }
      } catch (error) {
        console.error('Error loading brokers for clearance:', error);
      }
    }

    function populateBrokerSelect(brokers) {
      const brokerSelect = document.getElementById('brokerSelect');
      const brokerSelectUnit = document.getElementById('brokerSelectUnit');
      
      // Clear existing options except the first one
      brokerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„Ø²Ø¨ÙˆÙ†</option>';
      brokerSelectUnit.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠØ· ØµØ§Ø­Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø©</option>';
      
      brokers.forEach(broker => {
        const option1 = document.createElement('option');
        option1.value = broker.name;
        option1.textContent = broker.name;
        brokerSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = broker.name;
        option2.textContent = broker.name;
        brokerSelectUnit.appendChild(option2);
      });
    }

    function populateClearanceSelect(brokers) {
      const clearanceSelect = document.getElementById('clearanceSelect');
      clearanceSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ³ÙŠØ· Ø§Ù„ØªØ®Ù„ÙŠØµ</option>';
      
      brokers.forEach(broker => {
        const option = document.createElement('option');
        option.value = broker.name;
        option.textContent = broker.name;
        clearanceSelect.appendChild(option);
      });
    }

    function openAddBrokerModal() {
      const modal = new bootstrap.Modal(document.getElementById('addBrokerModal'));
      modal.show();
    }

    function openAddBrokerModalUnit() {
      const modal = new bootstrap.Modal(document.getElementById('addBrokerModalUnit'));
      modal.show();
    }

    async function addNewBroker() {
      const name = document.getElementById('newBrokerName').value.trim();
      const phone = document.getElementById('newBrokerPhone').value.trim();
      const email = document.getElementById('newBrokerEmail').value.trim();
      
      if (!name) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ·');
        return;
      }
      
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, phone, email })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ· Ø¨Ù†Ø¬Ø§Ø­');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBrokerModal'));
            modal.hide();
            // Reload brokers
            loadBrokers();
            // Clear form
            document.getElementById('addBrokerForm').reset();
          } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·: ' + result.message);
          }
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·');
        }
      } catch (error) {
        console.error('Error adding broker:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·');
      }
    }

    async function addNewBrokerUnit() {
      const name = document.getElementById('newBrokerNameUnit').value.trim();
      const phone = document.getElementById('newBrokerPhoneUnit').value.trim();
      const email = document.getElementById('newBrokerEmailUnit').value.trim();
      
      if (!name) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ·');
        return;
      }
      
      try {
        const response = await fetch(`/api/brokers?token=${getToken()}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ name, phone, email })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success) {
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ· Ø¨Ù†Ø¬Ø§Ø­');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addBrokerModalUnit'));
            modal.hide();
            // Reload brokers
            loadBrokers();
            // Clear form
            document.getElementById('addBrokerFormUnit').reset();
          } else {
            alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·: ' + result.message);
          }
        } else {
          alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·');
        }
      } catch (error) {
        console.error('Error adding broker:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·');
      }
    }
    
    console.log('=== CONTRACTS.HTML SCRIPT ENDED ===');
  </script>
</body>
</html> 